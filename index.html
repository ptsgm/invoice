<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="Sistem Penjualan dan Pembelian dengan Ekspor PDF & Excel" />
    <meta name="author" content="Sistem Akuntansi SGM" />
    <title>Sistem Akuntansi SGM</title>
    <style>
      .form-step {
  display: none; /* Sembunyikan semua langkah secara default */
  animation: fadeIn 0.5s ease; /* Gunakan animasi yang sudah ada */
}
.form-step.active {
  display: block; /* Tampilkan hanya langkah yang aktif */
}
/* Styling untuk grup tombol navigasi antar langkah */
.step-actions {
  display: flex;
  justify-content: space-between;
  margin-top: 25px;
}

      :root {
        --primary: #1e3a8a; /* Biru laut */
        --primary-dark: #172554; /* Biru lebih gelap untuk hover */
        --secondary: #f97316; /* Oranye lembut */
        --success: #16a34a; /* Hijau untuk sukses */
        --warning: #d97706; /* Kuning untuk peringatan */
        --danger: #dc2626; /* Merah untuk bahaya */
        --info: #0284c7; /* Biru muda untuk info */
        --dark: #1f2937; /* Abu-abu gelap untuk teks */
        --light: #ffffff; /* Putih untuk latar belakang */
        --shadow: 0 6px 16px rgba(0, 0, 0, 0.08); /* Bayangan lebih lembut */
        --border: #e5e7eb; /* Abu-abu muda untuk border */
        --text: var(--dark);
        --background: #f9fafb; /* Latar belakang kontainer */
        --card-bg: #ffffff;
        --input-bg: #ffffff;
      }

      /* DARK MODE VARIABLES */
      .dark-mode {
        --primary: #60a5fa; /* Biru lebih terang untuk dark mode */
        --primary-dark: #3b82f6; 
        --secondary: #fb923c;
        --success: #4ade80;
        --warning: #fbbf24;
        --danger: #f87171;
        --info: #38bdf8;
        --dark: #f3f4f6; /* Teks jadi terang */
        --light: #1f2937; /* Latar belakang jadi gelap */
        --shadow: 0 6px 16px rgba(0, 0, 0, 0.5);
        --border: #374151; /* Border lebih gelap */
        --text: #ffffff;
        --background: #111827; /* Latar belakang container gelap */
        --card-bg: #1f2937;
        --input-bg: #374151;
      }

      /* Dark mode specific overrides */
      body.dark-mode {
        /* Three Point Lighting Simulation:
           1. Key Light (Top Left): Cool Blue tint
           2. Fill Light (Bottom Right): Warm Purple/Dark tint
           3. Back Light (Top Right): Accent Blue
           4. Base: Dark Slate */
        background-color: #0f172a;
        background-image: 
            radial-gradient(circle at 10% 20%, rgba(56, 189, 248, 0.15) 0%, transparent 40%), /* Key Light */
            radial-gradient(circle at 90% 80%, rgba(139, 92, 246, 0.1) 0%, transparent 40%),  /* Fill Light */
            radial-gradient(circle at 80% 10%, rgba(30, 58, 138, 0.3) 0%, transparent 50%);   /* Back/Rim Light */
        background-attachment: fixed; /* Parallax-like feel */
        color: var(--text);
      }

      /* Base Body Light Mode 3-Point Light */
      body {
        font-family: 'IBM Plex Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto,
    Helvetica, Arial, sans-serif;
        /* Light Mode 3-Point:
           1. Key: Cool Blue (Subtle)
           2. Fill: Warm Orange (Subtle)
           3. Rim: Soft Purple/Blue */
        background-color: #f8fafc;
        background-image:
            radial-gradient(circle at 10% 20%, rgba(37, 99, 235, 0.05) 0%, transparent 40%),
            radial-gradient(circle at 90% 80%, rgba(249, 115, 22, 0.05) 0%, transparent 40%),
            radial-gradient(circle at 80% 5%, rgba(124, 58, 237, 0.03) 0%, transparent 40%);
        background-attachment: fixed;
        color: var(--text);
        min-height: 100vh;
        padding: 20px;
        font-size: 15px;
        line-height: 1.6;
        transition: background-color 0.3s ease, color 0.3s ease;
      }
      
      /* Card/Container 3-Point Lighting & Glassmorphism Depth */
      .container, .form-section, .stat-card, .history-overlay-content, .nav-tab.active {
          /* Subtle top-left highlight (Key Light reflection) */
          box-shadow: 
            -1px -1px 0 rgba(255, 255, 255, 0.4) inset, /* Top-Left Highlight */
            1px 1px 0 rgba(0, 0, 0, 0.05) inset,       /* Bottom-Right Shadow */
            0 6px 16px rgba(0, 0, 0, 0.08);            /* Drop Shadow */
      }
      
      .dark-mode .container, 
      .dark-mode .form-section, 
      .dark-mode .stat-card, 
      .dark-mode .history-overlay-content,
      .dark-mode .nav-tab.active {
          box-shadow: 
            -1px -1px 0 rgba(255, 255, 255, 0.08) inset, /* Fainter Highlight */
            1px 1px 0 rgba(0, 0, 0, 0.3) inset,         /* Deeper Shadow */
            0 8px 20px rgba(0, 0, 0, 0.4);              /* Heavier Drop Shadow */
      }

      .dark-mode .container {
        background: var(--card-bg);
      }
      
      .dark-mode .form-section {
        background: #111827;
        border-color: var(--border);
      }

      .dark-mode .nav-tab {
        background: var(--card-bg);
        border-color: var(--border);
        color: var(--text);
      }
      
      .dark-mode .nav-tab:hover:not(.active) {
        background: #374151;
      }

      .dark-mode .form-group input,
      .dark-mode .form-group select,
      .dark-mode .form-group textarea {
        background: var(--input-bg);
        color: var(--text);
        border-color: var(--border);
      }

      .dark-mode .data-table th {
        background: #111827;
        color: var(--text);
      }
      
      .dark-mode .data-table td {
         border-color: var(--border);
      }
      
      .dark-mode .stat-card {
        background: var(--card-bg);
        border-color: var(--border);
      }
      
      .dark-mode .history-filters {
        background: #111827;
      }
      
      .dark-mode .data-table tbody tr:nth-child(even) {
        background-color: #374151;
      }
      
      .dark-mode .data-table tbody tr:hover {
        background-color: #4b5563;
      }
      
      .dark-mode .step-number {
        background-color: var(--card-bg);
        border-color: var(--border);
        color: var(--text);
      }
      
      /* Fix Modal & Overlay Backgrounds */
      .dark-mode .history-overlay-content {
          background: var(--card-bg);
          color: var(--text);
      }
      .dark-mode #item-editor-form {
          background: var(--card-bg) !important;
          color: var(--text);
          border: 1px solid var(--border);
      }
      
      /* Dark Scrollbar */
      .dark-mode ::-webkit-scrollbar {
        width: 12px;
      }
      .dark-mode ::-webkit-scrollbar-track {
        background: #1f2937; 
      }
      /* Focus Glows */
      .form-group input:focus,
      .form-group select:focus,
      .form-group textarea:focus {
          outline: none;
          border-color: var(--primary);
          box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.2);
          transition: all 0.3s ease;
      }
      
      .dark-mode .form-group input:focus,
      .dark-mode .form-group select:focus,
      .dark-mode .form-group textarea:focus {
          box-shadow: 0 0 0 4px rgba(96, 165, 250, 0.3);
      }
      
      /* Dark Mode Fixes for Form Clusters & Summary */
      .dark-mode .form-group-cluster {
        background-color: var(--card-bg);
        border-color: var(--border);
      }
      
      .dark-mode .form-group-cluster-title {
          color: var(--primary);
          border-color: var(--border);
      }
      
      .dark-mode .total-amount-display {
        background-color: var(--input-bg);
        color: var(--text);
      }
      
      .dark-mode .dropdown-options {
        background-color: var(--card-bg);
        border-color: var(--border);
      }

      .dark-mode .dropdown-option {
          color: var(--text);
      }
      
      .dark-mode .dropdown-option:hover,
      .dark-mode .dropdown-option.focused {
        background-color: #374151;
      }
      
      .dark-mode .dropdown-option small {
        color: #9ca3af;
      }

      /* Notification Dark Mode */
      .dark-mode .notification.success {
        background-color: rgba(22, 163, 74, 0.2);
        border-color: rgba(22, 163, 74, 0.3);
        color: #4ade80;
      }
      
      .dark-mode .notification.error {
        background-color: rgba(220, 38, 38, 0.2);
        border-color: rgba(220, 38, 38, 0.3);
        color: #f87171;
      }

      /* PRO DASHBOARD LAYOUT */
      .dashboard-grid-pro {
          display: grid;
          grid-template-columns: 2fr 1fr;
          gap: 20px;
          margin-bottom: 25px;
      }
      .chart-card {
           background: var(--card-bg);
           padding: clamp(15px, 3vw, 25px); /* RESPONSIVE PADDING */
           border-radius: 12px;
           border: 1px solid var(--border);
           box-shadow: var(--shadow);
           min-height: 350px; /* MINIMUM DEPTH */
           height: clamp(350px, 45vh, 450px); /* DYNAMIC HEIGHT */
           position: relative;
           display: flex;
           flex-direction: column;
      }
      .chart-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 15px;
      }
      .chart-title {
          font-weight: 700;
          font-size: clamp(0.9rem, 2.5vw, 1.2rem); /* AUTO SCALE TITLE */
          color: var(--text);
          letter-spacing: -0.01em;
      }
      
      @media (max-width: 992px) {
          .dashboard-grid-pro {
              grid-template-columns: 1fr;
          }
      }

      /* TEXT TRUNCATION UTILITY */
      .truncate-text {
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
          max-width: 150px;
          font-size: 0.85em;
      }
      .data-table td.truncate-text {
           max-width: 150px;
      }

      /* RESPONSIVE DASHBOARD STATS */
      .stat-cards {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); /* MORE FLEXIBLE MIN WIDTH */
          gap: 20px;
          margin-bottom: 25px;
      }

      .stat-card {
          padding: 12px; /* EVEN SMALLER PADDING */
          box-sizing: border-box; /* PREVENT PADDING OVERFLOW */
          min-width: 0; /* ALLOW GRID SHRINKAGE */
          overflow: hidden; /* STRICT CONTAINMENT */
          border-radius: 12px;
          border: 1px solid var(--border);
          background: var(--card-bg);
          box-shadow: var(--shadow);
          transition: all 0.3s ease;
          display: flex;
          flex-direction: column;
          gap: 8px;
      }

      .stat-card-title {
          font-size: 0.9rem;
          font-weight: 600;
          color: #64748b; /* Gray in light mode */
          text-transform: uppercase;
          letter-spacing: 0.05em;
      }

      .stat-card-value {
          font-size: clamp(0.7rem, 4vw, 1.5rem); /* EXTREMELY AGGRESSIVE SCALING */
          font-weight: 700;
          color: var(--text);
          white-space: nowrap;
          overflow: hidden; /* SAFETY NET */
          text-overflow: ellipsis; /* LAST RESORT */
          display: block;
          width: 100%;
      }

      .stat-card-value.profit { color: #10b981; }
      .stat-card-value.loss { color: #ef4444; }

      /* DARK MODE OVERRIDES FOR STATS */
      .dark-mode .stat-card-title,
      .dark-mode .stat-card-value,
      .dark-mode .stat-card-value.profit,
      .dark-mode .stat-card-value.loss {
          color: #ffffff !important; /* Force white as per user request */
      }
      
      .dark-mode .stat-card {
          background: rgba(30, 41, 59, 0.7);
          backdrop-filter: blur(8px);
          border-color: rgba(255, 255, 255, 0.1);
      }

      @media (max-width: 600px) {
          .stat-cards {
              grid-template-columns: 1fr; /* Single column on mobile */
              gap: 12px;
          }
          .stat-card {
              padding: 12px;
          }
          /* CHART MOBILE OPTIMIZATION */
          .dashboard-grid-pro {
              grid-template-columns: 1fr !important;
              gap: 15px;
          }
          .chart-card {
              height: 280px !important; /* Adjusted for smaller screens */
              min-height: 240px !important;
              padding: 12px !important;
          }
          .chart-title {
              font-size: 0.95rem !important;
          }
      }



      /* Table Header Contrast */
      .dark-mode .data-table thead th {
          background: #374151; /* Lighter than body, distinct from rows */
          color: #f3f4f6;
          border-bottom: 2px solid #4b5563;
      }
      
      /* Input Readonly Contrast in Dark Mode */
      .dark-mode .form-group input[readonly] {
          background-color: #374151; /* Darker grey */
          color: #9ca3af;
      }
      
      /* Floating Action Button Theme */
      .dark-mode .floating-action-btn {
          background-color: #ef4444; /* Brighter red for visibility on dark */
          color: white;
      }
      .dark-mode .floating-action-btn:hover {
          background-color: #dc2626;
      }


      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: 'IBM Plex Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto,
    Helvetica, Arial, sans-serif;
        background: linear-gradient(135deg, #292929 0%, #303030 100%); /* Gradien lembut */
        color: var(--text);
        min-height: 100vh;
        padding: 20px;
        font-size: 15px;
        line-height: 1.6;
        transition: background-color 0.3s ease, color 0.3s ease;
      }

      .container {
        max-width: 1440px;
        margin: 0 auto;
        background: var(--light);
        border-radius: 12px;
        padding: 30px;
        box-shadow: var(--shadow);
      }

      .header {
        display: flex;
        align-items: center;
        justify-content: flex-start;
        gap: 25px;
        margin-bottom: 35px;
        padding-bottom: 20px;
        border-bottom: 1px solid var(--border);
      }

      .header img {
        max-height: 70px;
        border-radius: 8px;
      }

      .header h1 {
        color: var(--primary);
        font-size: 2rem;
        font-weight: 700;
        margin: 0;
      }

      .header .subtitle {
        color: #6b7280;
        font-size: 1rem;
        margin: 0;
      }

      .nav-tabs {
        display: flex;
        flex-wrap: wrap;
        margin-bottom: 30px;
        border-bottom: 1px solid var(--border);
      }

      .nav-tab {
        padding: 12px 30px;
        background: var(--light);
        border: 1px solid var(--border);
        border-bottom: none;
        cursor: pointer;
        font-weight: 600;
        border-top-left-radius: 8px;
        border-top-right-radius: 8px;
        margin-right: 6px;
        transition: all 0.3s ease;
        color: var(--text);
        margin-bottom: -1px;
      }
      
      .nav-tab[data-tab="edit"] {
          background: #fef3c7;
          border-color: #f59e0b;
          color: #d97706;
      }
      .nav-tab[data-tab="edit"].active {
          background: #f59e0b;
          color: white;
      }

      .nav-tab.active {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
        box-shadow: inset 0 -2px 0 var(--primary-dark);
      }

      .nav-tab:hover:not(.active) {
        background: #f3f4f6;
        color: var(--primary);
      }

        .bebas-ppn-group.hidden {
  display: none;
}

      .tab-content {
        display: none;
      }

      .tab-content.active {
        display: block;
        animation: fadeIn 0.5s ease;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

  /* === UI/UX IMPROVEMENT: Modern Floating Action Buttons (FAB) === */
.floating-action-group {
  position: fixed;
  /* PERBAIKAN: Beri jarak lebih dari tepi layar */
  bottom: 35px;
  right: 40px; 
  z-index: 998;
  display: flex;
  flex-direction: column-reverse;
  align-items: center;
  gap: 15px;
}

/* 1. Atur posisi relatif untuk item FAB agar bisa menampung petunjuk */
.fab-item {
  position: relative;
  /* Tambahkan sedikit ruang di atas untuk animasi */
  margin-top: 40px; 
}

/* 2. Styling untuk kontainer petunjuk (teks + panah) */
.fab-hint {
  position: absolute;
  bottom: 65px; /* Posisikan tepat di atas tombol FAB (56px) + sedikit jarak */
  left: 50%;
  transform: translateX(-50%);
  display: flex;
  flex-direction: column;
  align-items: center;
  pointer-events: none; /* Agar tidak bisa diklik */
  animation: bounce 1.5s infinite; /* Terapkan animasi naik-turun */
}

/* 3. Styling untuk teks petunjuk */
.fab-hint-text {
  background-color: red;
  color: white;
  padding: 6px 12px;
  border-radius: 8px;
  font-size: 0.7rem;
  font-weight: 600;
  white-space: nowrap;
  margin-bottom: 5px;
  box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}

/* 4. Styling untuk panah (dibuat dengan CSS) */
.fab-hint-arrow {
  width: 0;
  height: 0;
  border-left: 10px solid transparent;
  border-right: 10px solid transparent;
  border-top: 10px solid red; /* Panah menunjuk ke bawah */
}

/* 5. Definisikan animasi naik-turun (bounce) */
@keyframes bounce {
  0%, 20%, 50%, 80%, 100% {
    transform: translateX(-50%) translateY(0);
  }
  40% {
    transform: translateX(-50%) translateY(-10px);
  }
  60% {
    transform: translateX(-50%) translateY(-5px);
  }
}

.floating-action-btn {
  background-color: red;
  color: white;
  border: none;
  border-radius: 50%; /* Membuat tombol menjadi lingkaran */
  width: 56px;
  height: 56px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  justify-content: center;
}

.floating-action-btn:hover {
  background-color: rgb(177, 0, 0);
  transform: scale(1.05); /* Sedikit membesar saat di-hover */
}

/* Sembunyikan tooltip lama agar tidak tumpang tindih */
.fab-label {
  display: none;
}

/* Tampilkan tooltip saat item FAB di-hover */
.fab-item:hover .fab-label {
  opacity: 1;
  visibility: visible;
  transform: translateX(0);
}

/* CSS untuk Overlay (Tidak Berubah, tapi tetap disertakan untuk kelengkapan) */
/* === PERBAIKAN TAMPILAN OVERLAY RIWAYAT === */

/* 1. Container Utama Overlay */
.history-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.7); /* Background lebih gelap agar fokus */
    z-index: 2000; /* Z-index tinggi agar di atas elemen lain */
    align-items: center;
    justify-content: center;
    padding: 20px; /* Jarak aman dari tepi layar */
    animation: fadeIn 0.3s ease;
    backdrop-filter: blur(3px); /* Efek blur di belakang */
}

/* 2. Kotak Putih Overlay */
.history-overlay-content {
    background: var(--light);
    border-radius: 12px;
    width: 100%;
    max-width: 1300px; /* Lebar maksimal diperbesar */
    height: 90vh; /* Tinggi fix 90% dari layar */
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
    display: flex;
    flex-direction: column;
    overflow: hidden; /* Mencegah scroll ganda */
    position: relative;
}

/* 3. Reset Style Form Section di dalam Overlay */
.history-overlay-content .form-section {
    margin: 0 !important;
    padding: 20px 25px !important;
    box-shadow: none !important;
    border: none !important;
    height: 100%;
    display: flex;
    flex-direction: column;
    background: transparent;
}

/* 4. Header Judul & Tombol Close */
.history-overlay-content .form-section > div:first-child {
    flex-shrink: 0; /* Header tidak boleh mengecil */
    margin-bottom: 15px !important;
}

/* 5. Filter Area */
.history-overlay-content .history-filters {
    flex-shrink: 0;
    position: static !important; /* Reset sticky bawaan halaman utama */
    margin-bottom: 15px;
    padding: 15px;
}

/* 6. Tombol Export (Action Group) */
.history-overlay-content .actions-group {
    flex-shrink: 0;
}

/* 7. Container Tabel (AREA SCROLLING UTAMA) */
.history-overlay-content .table-container {
    flex-grow: 1; /* Mengambil sisa ruang kosong */
    overflow: auto; /* Scroll vertikal & horizontal otomatis */
    margin-top: 10px;
    margin-bottom: 15px;
    border: 1px solid var(--border);
    border-radius: 8px;
    background: white;
}

/* 8. Tabel Data */
.history-overlay-content .data-table {
    width: 100%;
    min-width: 1000px; /* KUNCI: Paksa tabel melebar agar kolom tidak terpotong/penyet */
    margin-bottom: 0;
}

/* 9. Sticky Header Tabel */
.history-overlay-content .data-table thead th {
    position: sticky;
    top: 0;
    z-index: 10;
    background: #2e3133; /* Warna header */
    box-shadow: 0 2px 2px rgba(0,0,0,0.1);
}

/* 10. Footer Pagination (Selalu di bawah) */
.history-overlay-content .actions-group[id^="pagination-"] {
    flex-shrink: 0;
    margin-top: auto; /* Dorong ke paling bawah */
    padding-top: 10px;
    border-top: 1px solid var(--border);
    background: var(--light);
}

/* Responsif untuk Layar Kecil (Mobile) */
@media (max-width: 768px) {
    .history-overlay {
        padding: 10px;
    }
    .history-overlay-content {
        height: 95vh;
    }
    .history-overlay-content .form-section {
        padding: 15px !important;
    }
    .history-overlay-content .table-container {
        border-right: 1px solid var(--border); /* Kembalikan border */
    }
}

.history-overlay-content .table-container {
    flex-grow: 1;
    overflow-y: auto;
}

.close-overlay-btn {
  font-size: 1.5rem !important;
  padding: 0 12px !important;
  line-height: 1;
}

      .form-section {
        background: var(--background);
        border-radius: 10px;
        padding: 25px;
        margin-top: 15px;
        margin-bottom: 25px;
        border: 1px solid var(--border);
        transition: box-shadow 0.3s ease;
      }

      .form-section:hover {
        box-shadow: var(--shadow);
      }

      .form-section-title {
        color: var(--primary);
        font-size: 1.5rem;
        font-weight: 700;
        margin-bottom: 20px;
        padding-bottom: 12px;
        border-bottom: 2px solid var(--primary);
      }

      .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
      }

      .form-group {
        display: flex;
        flex-direction: column;
        position: relative;
      }

      .form-group label {
        color: var(--dark);
        font-weight: 600;
        margin-bottom: 8px;
        font-size: 0.95rem;
      }

      .form-group input,
      .form-group select,
      .form-group textarea {
        width: 100%;
        padding: 12px;
        border: 1px solid var(--border);
        border-radius: 8px;
        font-size: 0.95rem;
        background: #ffffff;
        color: var(--dark);
        transition: all 0.3s ease;
        font-family: inherit;
      }

      .form-group input:focus,
      .form-group select:focus,
      .form-group textarea:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 4px rgba(30, 58, 138, 0.1);
      }

      .form-group input[readonly] {
        background: #f3f4f6;
        cursor: not-allowed;
        font-weight: 500;
      }

      .form-group input:invalid {
        border-color: var(--danger);
        box-shadow: 0 0 0 4px rgba(220, 38, 38, 0.1);
      }

      /* === UI/UX IMPROVEMENT: Stepper for Multi-Step Forms === */
.stepper {
  display: flex;
  justify-content: space-between;
  align-items: flex-start; /* Align items to the top */
  margin-bottom: 30px;
  padding: 0 15px;
}
.step {
  display: flex;
  align-items: center;
  flex-direction: column;
  position: relative;
  text-align: center;
  flex-grow: 1;
}
/* The line connecting the steps */
.step:not(:first-child)::before {
  content: '';
  position: absolute;
  top: 18px; /* Vertically center with the circle */
  right: 50%;
  height: 2px;
  width: 100%;
  background-color: var(--border);
  z-index: 0;
}
.step-number {
  background-color: var(--light);
  border: 2px solid var(--border);
  color: #6b7280; /* Neutral text color */
  width: 36px;
  height: 36px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 700;
  z-index: 1; /* Make sure the circle is above the line */
  transition: all 0.3s ease;
}
.step-title {
  margin-top: 8px;
  font-weight: 500;
  font-size: 0.85rem;
  color: #6b7280;
  transition: all 0.3s ease;
}

/* --- STATES --- */
/* Active Step */
.step.active .step-number {
  background-color: var(--primary);
  border-color: var(--primary);
  color: white;
  transform: scale(1.1);
}
.step.active .step-title {
  color: var(--primary);
  font-weight: 700;
}
/* Completed Step */
.step.completed .step-number {
  background-color: var(--success);
  border-color: var(--success);
  color: white;
}
/* Color the line for completed steps */
.step.completed:not(:first-child)::before {
    background-color: var(--success);
}
.step.completed .step-title {
  color: var(--dark);
}

      .btn {
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        font-size: 0.95rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 10px;
      }

      .btn:disabled {
        opacity: 0.7;
        cursor: not-allowed;
      }

      .btn-primary {
        background: var(--primary);
        color: white;
      }

      .btn-primary:hover:not(:disabled) {
        background: var(--primary-dark);
        transform: translateY(-1px);
      }

      .btn-success {
        background: var(--success);
        color: white;
      }

      .btn-success:hover:not(:disabled) {
        background: #15803d;
        transform: translateY(-1px);
      }

      .btn-danger {
        background: var(--danger);
        color: white;
      }

      .btn-danger:hover:not(:disabled) {
        background: #b91c1c;
        transform: translateY(-1px);
      }

      .btn-warning {
        background: var(--warning);
        color: white;
      }

      .btn-warning:hover:not(:disabled) {
        background: #b45309;
        transform: translateY(-1px);
      }

      .btn-info {
        background: var(--info);
        color: white;
      }

      .btn-info:hover:not(:disabled) {
        background: #0369a1;
        transform: translateY(-1px);
      }

      .btn-sm {
        padding: 8px 16px;
        font-size: 0.85rem;
      }

      .actions-group {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        margin-top: 25px;
      }

      .table-container {
        margin-top: 25px;
        overflow-x: auto;
      }

      .data-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        font-size: 0.9rem;
        border-radius: 8px;
        overflow: hidden;
      }

      .data-table th,
      .data-table td {
        padding: 12px 15px;
        border: 1px solid var(--border);
        text-align: left;
        vertical-align: top;
      }

      .data-table thead th {
        background: #2e3133;
        color: white;
        font-weight: 600;
        position: sticky;
        top: 0;
        z-index: 1;
      }

      .data-table tbody tr {
        transition: background-color 0.3s ease;
      }

      .data-table tbody tr:hover {
        background-color: #f1f5f9;
      }

      .data-table tbody tr:nth-child(even) {
        background-color: #f9fafb;
      }

      .data-table td.text-right,
      .data-table th.text-right {
        text-align: right;
      }

      .data-table .action-cell {
        text-align: center;
        white-space: nowrap;
      }

      .data-table .action-cell .btn {
        margin: 3px;
      }

      .summary-section {
        margin-top: 25px;
        display: flex;
        justify-content: flex-end;
      }

      .summary-grid {
        width: 100%;
        max-width: 550px;
        display: grid;
        grid-template-columns: auto 1fr;
        gap: 15px 20px;
        align-items: center;
      }

      .summary-grid label {
        font-weight: 600;
        text-align: right;
        padding-right: 12px;
        white-space: nowrap;
      }

      .total-amount-display {
        font-size: 1rem;
        font-weight: 700;
        padding: 12px;
        background-color: #f3f4f6;
        border-radius: 8px;
        text-align: right;
      }

      .notification {
        padding: 20px;
        margin-bottom: 25px;
        border-radius: 8px;
        border: 1px solid transparent;
        display: none;
        animation: fadeIn 0.5s ease;
        font-weight: 500;
      }

      .notification.success {
        background-color: #dcfce7;
        border-color: #bbf7d0;
        color: #166534;
      }

      .notification.error {
        background-color: #fee2e2;
        border-color: #fecaca;
        color: #991b1b;
      }

      .notification button {
        float: right;
        background: none;
        border: none;
        font-size: 1.3rem;
        cursor: pointer;
        line-height: 1;
        color: inherit;
        transition: transform 0.3s ease;
      }

      .notification button:hover {
        transform: scale(1.2);
      }

      .dpp-info-display {
        font-size: 0.85rem;
        color: #d97706; /* Menggunakan warna oranye (warning) */
        text-align: right;
        margin-top: -8px;
        padding-right: 5px;
        display: block; /* Memastikan elemen ini ditampilkan */
        height: 15px; /* Memberi ruang agar tidak hilang */
      }

      .filterable-dropdown {
        position: relative;
      }

      .dropdown-options {
        display: none;
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background-color: white;
        border: 1px solid var(--border);
        border-top: none;
        z-index: 1000;
        max-height: 300px;
        overflow-y: auto;
        box-shadow: var(--shadow);
        border-radius: 0 0 8px 8px;
      }

      .dropdown-option {
        padding: 12px;
        cursor: pointer;
        transition: background-color 0.3s ease;
      }

      .dropdown-option:hover,
      .dropdown-option.focused {
        background-color: #f1f5f9;
      }

      .dropdown-option small {
        color: #6b7280;
        display: block;
        font-size: 0.85rem;
      }

      .stat-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
        gap: 25px;
        margin-bottom: 25px;
      }

      .stat-card {
        background: linear-gradient(135deg, #ffffff 0%, #f9fafb 100%);
        padding: 25px;
        border-radius: 12px;
        border: 1px solid var(--border);
        box-shadow: var(--shadow);
        transition: transform 0.3s ease;
      }

      .stat-card:hover {
        transform: translateY(-2px);
      }

      .stat-card-title {
        font-size: 1rem;
        color: #6b7280;
        margin-bottom: 12px;
        font-weight: 500;
      }

      .stat-card-value {
        font-size: 2.2rem;
        font-weight: 700;
        color: var(--primary);
        word-wrap: break-word;
      }

      .stat-card-value.profit {
        color: var(--success);
      }

      .stat-card-value.loss {
        color: var(--danger);
      }

      .history-filters {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 20px;
        background-color: #f3f4f6;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 20px;
      }

      .loading-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        z-index: 2000;
        align-items: center;
        justify-content: center;
      }

      .loading-spinner {
        border: 5px solid #f3f3f3;
        border-top: 5px solid var(--primary);
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      #print-area {
        display: none;
      }

      body.printing > *:not(#print-area) {
        display: none !important;
      }

      body.printing #print-area {
        display: block !important;
      }
      
      .npwp-group.hidden {
          display: none;
      }

      .btn svg {
        width: 1.2em;
        height: 1.2em;
        fill: currentColor;
      }

      .quick-actions {
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
        margin-top: 10px;
      }
      .quick-actions .btn {
        padding: 15px 30px;
        font-size: 1.1rem;
        flex-grow: 1;
      }

      .form-section-title svg {
        fill: currentColor;
      }

      .form-group-cluster {
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 20px;
        margin-top: 15px;
        background-color: #ffffff;
        grid-column: 1 / -1;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
      }
      .form-group-cluster-title {
        grid-column: 1 / -1;
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--primary);
        margin-top: -5px;
        margin-bottom: 5px;
        border-bottom: 1px solid var(--border);
        padding-bottom: 10px;
      }
      
      .history-filters {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 20px;
        background-color: #f3f4f6;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 20px;
        /* UX: Membuat filter menempel di atas */
        position: sticky;
        top: -20px; 
        z-index: 900;
        border-bottom: 1px solid var(--border);
      }


      @media print {
        * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
          font-size: 10pt !important;
        }

        body,
        html {
          width: 210mm;
          height: 100%;
          margin: 0 !important;
          padding: 0 !important;
        }

        body {
          -webkit-print-color-adjust: exact;
          print-color-adjust: exact;
        }

        body,
        .printable-content {
          margin: 0;
          padding: 0;
          font-family: 'Arial', Helvetica, sans-serif;
          color: #000;
          font-size: 10pt;
        }

        #print-area {
          display: block !important;
        }

        .page {
          width: 210mm;
          min-height: 297mm;
          padding: 10mm !important;
          margin: 0 auto;
          page-break-after: always;
          box-sizing: border-box;
        }

        .page:last-child {
          page-break-after: avoid;
        }

        .print-header {
          display: flex;
          align-items: flex-start;
          justify-content: space-between;
          margin-bottom: 8mm;
          border-bottom: 2px solid #000;
          padding-bottom: 5mm;
          page-break-inside: avoid;
        }

        .print-header .company-info {
          text-align: left;
          max-width: 120mm;
          word-wrap: break-word;
          overflow-wrap: break-word;
        }

        .print-header .logo {
          max-height: 40mm;
          max-width: 50mm;
          object-fit: contain;
        }

        .print-header h3 {
          font-size: 14pt;
          margin: 0;
          color: #000;
        }

        .print-header p {
          font-size: 9pt;
          margin: 2px 0;
          color: #000;
        }

        .print-section {
          border: 1px solid #000;
          padding: 5mm;
          margin-top: 5mm;
          max-width: 190mm;
          box-sizing: border-box;
          page-break-inside: avoid;
        }

        .print-section.kwitansi {
          border: 1px solid #000;
        }

        .print-section h4 {
          text-align: center;
          margin-bottom: 5mm;
          text-decoration: underline;
          font-size: 12pt;
        }

        .meta-tables {
          display: flex;
          justify-content: space-between;
          margin-bottom: 5mm;
          max-width: 190mm;
        }

        .meta-table {
          width: 48%;
          table-layout: fixed;
          font-size: 10pt;
        }

        .meta-table td {
          vertical-align: top;
          padding: 1mm 2mm;
          word-wrap: break-word;
          overflow-wrap: break-word;
          white-space: normal;
        }

        .meta-table td:nth-child(1) {
          width: 30mm;
          font-weight: bold;
        }

        .meta-table td:nth-child(2) {
          width: 2mm;
        }

        .meta-table td:nth-child(3) {
          width: calc(100% - 32mm); /* Sisa ruang untuk isi data */
        }

        .items-table {
          width: 100%;
          border-collapse: collapse;
          margin-top: 5mm;
          font-size: 10pt;
          page-break-inside: auto;
        }

        .items-table th,
        .items-table td {
          border: 0.1mm solid #000 !important;
          padding: 2mm !important;
          word-wrap: break-word;
          overflow-wrap: break-word;
          white-space: normal;
        }

        .items-table th {
          background-color: #eee !important;
        }

        .items-table td:nth-child(2) {
          max-width: 80mm;
        }

        .items-table tr {
          page-break-inside: avoid;
          page-break-after: auto;
        }

        .items-table tbody tr:nth-child(25) ~ tr {
          page-break-before: always;
        }

        .summary-table {
          width: 70mm;
          margin-left: auto;
          margin-top: 8mm;
          border-collapse: collapse;
          font-size: 10pt;
          page-break-inside: avoid;
        }

        .summary-table td {
          padding: 2mm 3mm;
          word-wrap: break-word;
        }

        .kwitansi-box {
          border: 1px solid #000;
          padding: 6mm;
          margin: 8mm 0;
          page-break-inside: avoid;
          max-width: 190mm;
        }

        .kwitansi-box .meta-table {
          border-collapse: collapse;
          font-size: 10pt;
        }

        .kwitansi-box .meta-table td {
          padding: 2mm 3mm;
          vertical-align: top;
        }

        .kwitansi-box .terbilang {
          font-style: italic;
          font-weight: bold;
          max-width: calc(190mm - 40mm);
          word-wrap: break-word;
          overflow-wrap: break-word;
          white-space: normal;
        }

        .print-section p,
        .print-section div:not(.print-signatures) {
          max-width: 190mm;
          word-wrap: break-word;
          overflow-wrap: break-word;
        }

        .print-footer {
          margin-top: 10mm;
          page-break-inside: avoid;
        }

        .print-signatures {
          display: flex;
          justify-content: space-between;
          text-align: center;
          width: 100%;
          margin-top: 20mm;
          page-break-inside: avoid;
        }

        .print-signatures > div {
          width: 45mm;
          word-wrap: break-word;
        }

        .signature-space {
          height: 30mm;
          margin-bottom: 2mm;
        }
      }

      @media (max-width: 992px) {
        .container {
            padding: 20px;
        }

        .header {
            flex-direction: column;
            align-items: flex-start;
            gap: 15px;
        }

        .form-grid {
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        }

        .nav-tab {
            padding: 10px 20px;
            font-size: 0.9rem;
        }

        .summary-grid {
            max-width: 100%;
        }
      }

      @media (max-width: 768px) {
        body {
            padding: 10px;
            font-size: 14px;
        }

        .container {
            padding: 15px;
        }

        .header h1 {
            font-size: 1.8rem;
        }
        
        .header img {
            max-height: 60px;
        }

        .nav-tabs {
            gap: 5px;
        }

        .nav-tab {
            width: 100%;
            text-align: center;
            margin-right: 0;
            border-radius: 8px;
            margin-bottom: 5px;
            border-bottom: 1px solid var(--border);
        }
        
        .nav-tab.active {
            box-shadow: none;
        }

        .form-grid,
        .history-filters,
        .stat-cards {
            grid-template-columns: 1fr;
        }

        .actions-group {
            flex-direction: column;
            align-items: stretch;
        }

        .actions-group .btn {
            width: 100%;
            justify-content: center;
        }
        
        .summary-section {
            justify-content: center;
        }
        
        .summary-grid {
            grid-template-columns: auto 1fr;
            width: 100%;
        }

        .summary-grid label {
            text-align: left;
            padding-right: 0;
        }

        .data-table th,
        .data-table td {
            padding: 10px 8px;
            font-size: 0.85rem;
        }
        
        .table-container {
            border-left: none;
            border-right: none;
            border-radius: 0;
        }
        
        .data-table thead {
            position: relative;
        }
        
        .data-table .action-cell .btn {
            margin: 2px;
            padding: 6px 10px;
            font-size: 0.8rem;
        }
        
        .data-table .action-cell {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .print-signatures {
            justify-content: space-between;  
        }

        .print-signatures > div {
            width: 48%;
            max-width: 200px;
        }
      }

      @media (max-width: 480px) {
        body {
            padding: 5px;
        }

        .container {
            padding: 10px;
        }
        
        .header h1 {
            font-size: 1.5rem;
        }
        
        .header .subtitle {
            font-size: 0.9rem;
        }
        
        .form-section-title {
            font-size: 1.3rem;
        }
        
        .btn {
            padding: 10px 18px;
            font-size: 0.9rem;
        }
        
        .summary-grid {
            grid-template-columns: 1fr;
            gap: 10px;
        }
        
        .summary-grid label {
            text-align: left;
        }

        .total-amount-display {
            text-align: left;
            padding: 10px;
        }
      }

    /* === APP FOOTER STYLING === */
.app-footer {
  background-color: #ffffff; /* Latar belakang Putih di mode terang */
  color: var(--dark);        /* Teks gelap agar kontras */
  
  text-align: center;
  padding: 30px 15px;
  margin-top: 30px;
  
  /* Memberikan sedikit bayangan di atas agar terlihat terpisah dari konten */
  box-shadow: 0 -4px 20px rgba(0,0,0,0.05); 
  border-top: 1px solid var(--border);
  
  /* Opsional: Membuat sudut atas sedikit melengkung */
  border-radius: 15px 15px 0 0; 
  position: relative;
  z-index: 10;
}

/* === MODIFIKASI KHUSUS DARK MODE === */
/* Penting: Agar footer tidak tetap putih silau saat mode gelap aktif */
body.dark-mode .app-footer {
  background-color: var(--card-bg); /* Menggunakan warna kartu gelap */
  color: var(--text);               /* Teks kembali terang */
  border-top: 1px solid rgba(255,255,255,0.05);
  box-shadow: 0 -4px 20px rgba(0,0,0,0.3);
}

.app-footer p {
  margin: 5px 0;
}

.app-footer strong {
  font-weight: 600;
}

.app-footer a {
  color: var(--primary);
  text-decoration: none;
  font-weight: 700;
  transition: all 0.3s ease;
}

.app-footer a:hover {
  color: var(--secondary);
}

@media print {
  .app-footer {
    display: none !important;
  }
}


    </style>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
      <div class="loading-spinner"></div>
    </div>
    <div class="container">
      <div class="header">
        <img
          src="logo.png"
          id="header-logo"
          alt="Logo Perusahaan"
          onerror="this.onerror=null; this.src='https://via.placeholder.com/150x50.png?text=Logo';"
        />
        <div style="flex-grow: 1;">
          <h1 id="header-title">Sistem Akuntansi SGM</h1>
          <p class="subtitle" id="header-tagline">
            Pencatatan Penjualan, Pembelian, dan Surat Jalan
          </p>
        </div>
        <button class="btn btn-sm" id="darkModeToggle" onclick="window.app.toggleDarkMode()" style="background:transparent; border:1px solid var(--border); color:var(--text);" title="Toggle Dark Mode (Ctrl+Shift+D)">
            <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 -960 960 960" width="24" fill="currentColor"><path d="M480-120q-150 0-255-105T120-480q0-150 105-255t255-105q14 0 27.5 1t26.5 3q-41 29-65.5 75.5T444-660q0 90 63 153t153 63q55 0 101-24.5t75-65.5q2 13 3 26.5t1 27.5q0 150-105 255T480-120Zm0-80q88 0 158-48.5T740-375q-20 5-40 8t-40 3q-123 0-209.5-86.5T364-660q0-20 3-40t8-40q-78 32-126.5 102T200-480q0 116 82 198t198 82Zm-10-270Z"/></svg>
        </button>
      </div>

      <div class="nav-tabs" role="tablist">
        <button class="nav-tab active" data-tab="dashboard" role="tab">Dashboard</button>
        <button class="nav-tab" data-tab="penjualan" role="tab">Penjualan</button>
        <button class="nav-tab" data-tab="pembelian" role="tab">Pembelian</button>
        <button class="nav-tab" data-tab="data-transaksi" role="tab">Data Transaksi (Non PPN)</button>
        <button class="nav-tab" data-tab="invoices" role="tab">Data Invoice</button>
        <button class="nav-tab" data-tab="pengaturan" role="tab">Pengaturan</button>
        <button class="nav-tab" data-tab="edit" style="display:none;" id="edit-tab-btn">Edit Transaksi</button>
      </div>

      <div id="notification-area" class="notification"></div>

      <div id="dashboard" class="tab-content active" role="tabpanel"></div>
      <div id="penjualan" class="tab-content" role="tabpanel"></div>
      <div id="pembelian" class="tab-content" role="tabpanel"></div>
      <div id="data-transaksi" class="tab-content" role="tabpanel"></div>
      <div id="invoices" class="tab-content" role="tabpanel"></div>
      <div id="suratJalan" class="tab-content" role="tabpanel"></div> 

      <div id="pengaturan" class="tab-content" role="tabpanel">
        
        <div class="form-section">
            <h3 class="form-section-title">Informasi Perusahaan</h3>
            <div class="form-grid">
                <div class="form-group"><label>Nama Perusahaan</label><input type="text" id="config-namaPerusahaan"></div>
                <div class="form-group"><label>Tagline / Slogan</label><input type="text" id="config-tagline"></div>
                <div class="form-group"><label>Alamat</label><input type="text" id="config-alamatPerusahaan"></div>
                <div class="form-group"><label>Kontak (Telp/Email)</label><input type="text" id="config-kontak"></div>
                <div class="form-group"><label>Nomor Rekening (Utama)</label><input type="text" id="config-rekening"></div>
                <div class="form-group"><label>Nomor Rekening (Khusus PPN)</label><input type="text" id="config-rekeningPpn"></div>
                <div class="form-group"><label>URL Logo</label><input type="text" id="config-logoUrl" placeholder="https://..."></div>
            </div>
            <div class="actions-group">
                <button class="btn btn-primary" onclick="app.saveConfig()">Simpan Informasi</button>
            </div>
        </div>

        <div class="form-section">
            <h3 class="form-section-title">Cadangan & Pemulihan Data</h3>
            <div class="actions-group">
                <button onclick="app.backupData()" class="btn btn-success">Download Backup (JSON)</button>
                <div style="position:relative; display:inline-block;">
                        <input type="file" id="restoreFile" style="display:none" onchange="app.restoreData(event)" accept=".json">
                        <button onclick="document.getElementById('restoreFile').click()" class="btn btn-warning">Restore Data (JSON)</button>
                </div>
                <button onclick="app.clearMasterItems()" class="btn btn-danger">Hapus Semua Master Barang</button>
            </div>
        </div>
        
        <div class="form-section">
    <h3 class="form-section-title">Manajemen Data Barang</h3>

    <div id="item-editor-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1001; display:flex; align-items:center; justify-content:center; display:none;">
        <form id="item-editor-form" style="background:white; padding:25px; border-radius:10px; width:90%; max-width:800px;">
            <h4 class="form-section-title" style="margin-top:0;">Editor Barang</h4>
            <input type="hidden" id="edit-item-original-code">
            <div class="form-grid">
                <div class="form-group"><label>Kode Barang</label><input type="text" id="edit-item-code" required></div>
                <div class="form-group"><label>Nama Barang</label><input type="text" id="edit-item-name" required></div>
                <div class="form-group"><label>Satuan</label><input type="text" id="edit-item-unit"></div>
                <div class="form-group"><label>Harga</label><input type="text" id="edit-item-price" class="rupiah-input"></div>
            </div>
            <div class="actions-group">
                <button type="submit" class="btn btn-primary">Simpan Barang</button>
                <button type="button" id="cancel-edit-btn" class="btn btn-warning">Batal</button>
            </div>
        </form>
    </div>

    <div class="actions-group" style="justify-content: space-between;">
        <button id="show-add-item-form" class="btn btn-success">
             Tambah Barang Baru
        </button>
        <div class="form-group" style="min-width: 300px; margin-bottom:0;">
            <input type="text" id="search-master-items" placeholder="Cari barang berdasarkan nama atau kode...">
        </div>
    </div>

    <div class="table-container" style="margin-top: 20px;">
        <table class="data-table">
            <thead>
                <tr>
                    <th>Kode Barang</th>
                    <th>Nama Barang</th>
                    <th>Satuan</th>
                    <th class="text-right">Harga Jual</th>
                    <th class="action-cell">Aksi</th>
                </tr>
            </thead>
            <tbody id="master-items-table-body">
                </tbody>
        </table>
    </div>
    <div class="actions-group" id="master-items-pagination" style="justify-content: space-between; align-items: center;">
        <p style="font-weight: bold;">
            Total Barang: <span id="master-item-count">0</span>
        </p>
        <div style="display: flex; gap: 10px; align-items: center;">
            <button class="btn btn-primary btn-sm" id="prev-item-page">&laquo; Sebelumnya</button>
            <span>Halaman <span id="current-item-page">1</span> dari <span id="total-item-pages">1</span></span>
            <button class="btn btn-primary btn-sm" id="next-item-page">Berikutnya &raquo;</button>
        </div>
    </div>
    </div> <div id="npwp-management-section"></div>
    <div id="trash-section"></div> <!-- Move trash section here for better layout -->
</div>

<!-- EDIT TAB CONTENT -->
<div id="edit" class="tab-content">
    <div class="form-section">
        <h3 class="form-section-title" id="edit-form-title">Edit Transaksi</h3>
        <form id="editForm">
             <input type="hidden" id="transType-edit"> <!-- Stores 'sale' or 'purchase' -->
             
             <div class="stepper" id="stepper-edit">
                  <div class="step active" id="step-1-edit" data-step="1">
                    <div class="step-number">1</div>
                    <div class="step-title">Informasi Utama</div>
                  </div>
                  <div class="step" id="step-2-edit" data-step="2">
                    <div class="step-number">2</div>
                    <div class="step-title">Detail Barang</div>
                  </div>
                  <div class="step" id="step-3-edit" data-step="3">
                    <div class="step-number">3</div>
                    <div class="step-title">Pembayaran</div>
                  </div>
            </div>

            <div id="form-step-1-edit" class="form-step active">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Tanggal</label>
                        <input type="date" id="invoiceDate-edit" required>
                    </div>
                    <div class="form-group">
                        <label>No. Transaksi</label>
                        <input type="text" id="transNo-edit" readonly>
                    </div>
                </div>

                <div class="form-section-title" style="font-size: 1.2rem; margin-top: 20px;">Informasi Partner</div>
                <div class="form-grid">
                    <div class="form-group filterable-dropdown">
                        <label id="partyNameLabel-edit">Nama Partner</label>
                        <input type="text" id="partyName-edit" onfocus="app.filterPartyNames('edit', true)" oninput="app.filterPartyNames('edit')" required autocomplete="off">
                        <div class="dropdown-options" id="party-dropdown-edit"></div>
                    </div>
                    <div class="form-group">
                        <label>Alamat</label>
                        <input type="text" id="partyAddress-edit">
                    </div>
                    <div class="form-group">
                        <label>Telepon</label>
                        <input type="text" id="partyPhone-edit">
                    </div>
                </div>
                 
                 <div class="form-group" style="margin-top:15px; display:flex; flex-direction:row; align-items:center; gap:10px;">
                    <input type="checkbox" id="includePpn-edit" style="width:auto;" onchange="document.getElementById('npwp-group-edit').classList.toggle('hidden', !this.checked); document.querySelector('.bebas-ppn-group-edit').classList.toggle('hidden', !this.checked); app.calculateTotals('edit');">
                    <label for="includePpn-edit" style="margin:0; cursor:pointer;">Termasuk PPN 11%</label>
                </div>
                
                 <div class="form-group bebas-ppn-group-edit hidden" id="bebas-ppn-group-edit" style="margin-top:10px; margin-left: 25px; display:flex; flex-direction:row; align-items:center; gap:10px;">
                    <input type="checkbox" id="bebasPpn-edit" style="width:auto;" onchange="app.calculateTotals('edit');">
                    <label for="bebasPpn-edit" style="margin:0; cursor:pointer;">PPN Dibebaskan (0%)</label>
                </div>

                <div id="npwp-group-edit" class="form-grid hidden" style="margin-top: 15px;">
                    <div class="form-group">
                        <label>NPWP / NIK (Wajib untuk PPN)</label>
                        <input type="text" id="partyNpwp-edit">
                    </div>
                </div>

                 <div class="actions-group" style="justify-content: flex-end;">
                  <button type="button" class="btn btn-primary" onclick="app.nextStep('edit', 1)">Lanjut &raquo;</button>
                </div>
            </div>

            <div id="form-step-2-edit" class="form-step">
                <div class="form-grid" style="grid-template-columns: 2fr 1fr 1fr 1fr auto; align-items: end;">
                     <div class="form-group filterable-dropdown">
                        <label>Cari Barang</label>
                        <input type="text" id="item-selector-edit" placeholder="Ketik kode atau nama..." onfocus="app.filterDropdown('edit', true)" oninput="app.filterDropdown('edit')" autocomplete="off">
                        <div class="dropdown-options" id="dropdown-options-edit"></div>
                    </div>
                    <div class="form-group"><label>Jumlah</label><input type="number" id="itemQty-edit" value="0" min="0" step="any"></div>
                    <div class="form-group"><label>Satuan</label><input type="text" id="itemUnit-edit" readonly></div>
                    <div class="form-group"><label>Harga</label><input type="text" id="itemPrice-edit" class="rupiah-input" oninput="Utils.formatRupiahInput(this)"></div>
                    <div class="form-group"><button type="button" class="btn btn-success" onclick="app.addItemToTempList('edit')">+</button></div>
                </div>
                <input type="hidden" id="itemCode-edit">

                <div class="table-container">
                    <table class="data-table" id="temp-items-table-edit">
                        <thead><tr><th>No</th><th>Kode</th><th>Nama Barang</th><th class="text-right">Qty</th><th>Satuan</th><th class="text-right">Harga</th><th class="text-right">Total</th><th class="action-cell">Aksi</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
                
                 <div class="actions-group" style="justify-content: space-between;">
                   <button type="button" class="btn btn-warning" onclick="app.prevStep('edit', 2)">&laquo; Kembali</button>
                   <button type="button" class="btn btn-primary" onclick="app.nextStep('edit', 2)">Lanjut &raquo;</button>
                </div>
            </div>

            <div id="form-step-3-edit" class="form-step">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Catatan</label>
                        <textarea id="notes-edit" rows="3"></textarea>
                    </div>
                     <div class="form-group" id="ref-group-edit">
                        <label>Referensi (No. PO / Lainnya)</label>
                         <input type="text" id="ref-edit">
                    </div>
                     <div class="form-group">
                        <label>No. Kendaraan (Surat Jalan)</label>
                         <input type="text" id="vehicleNo-edit">
                    </div>
                </div>

                <div class="summary-section">
                    <div class="summary-grid">
                        <label>Subtotal</label><div class="total-amount-display" id="subtotal-edit">Rp 0</div>
                        <label>Diskon (Rp)</label><input type="text" id="discount-edit" class="rupiah-input" value="0" oninput="Utils.formatRupiahInput(this); app.calculateTotals('edit')">
                        <label>Ongkir (Rp)</label><input type="text" id="shippingCost-edit" class="rupiah-input" value="0" oninput="Utils.formatRupiahInput(this); app.calculateTotals('edit')">
                        <label>PPN 11% <br><small id="dpp-info-edit"></small></label><div class="total-amount-display" id="ppn-edit">Rp 0</div>
                        <label>DP / Uang Muka</label><input type="text" id="dp-edit" class="rupiah-input" value="0" oninput="Utils.formatRupiahInput(this); app.calculateTotals('edit')">
                         <label>Metode Pembayaran</label>
                        <select id="paymentMethod-edit">
                            <option value="Tunai">Tunai</option>
                            <option value="Transfer">Transfer</option>
                            <option value="Tempo">Tempo</option>
                        </select>
                        <label style="font-size: 1.2rem; color: var(--primary);">Grand Total</label>
                        <div class="total-amount-display" id="grandTotal-edit" style="background: var(--primary); color: white; font-size: 1.2rem;">Rp 0</div>
                    </div>
                </div>
                 <div class="actions-group" style="justify-content: space-between; margin-top:20px;">
                   <button type="button" class="btn btn-warning" onclick="app.prevStep('edit', 3)">&laquo; Kembali</button>
                    <div style="display:flex; gap:10px;">
                        <button type="button" class="btn btn-danger" onclick="app.cancelEdit()">Batal Edit</button>
                        <button type="submit" class="btn btn-primary" style="font-size: 1.1rem; padding: 12px 30px;">Update Transaksi</button>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

        </div>
        
      </div>
    </div>
<footer class="app-footer">
        <p>
            &copy; <script>document.write(new Date().getFullYear())</script> 
            <strong>Sistem Akuntansi SGM</strong>. All Rights Reserved.
        </p>
        <p>
            Dibuat dengan <span style="color: #e25555;">&hearts;</span> oleh 
            <a href="#" target="_blank" title="Kunjungi Website Kami">Nunudev Studio</a>
        </p>
</footer>
    <div id="print-area"></div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>

    <script>
      /**
       * Utility functions for common operations
       */
      const Utils = {
        formatRupiahInput(input) {
          let value = input.value.replace(/[^0-9]/g, "");
          if (value === "") {
            input.value = "";
            return;
          }
          const number = parseInt(value, 10);
          if (isNaN(number)) {
            input.value = "";
            return;
          }
          input.value = new Intl.NumberFormat("id-ID").format(number);
        },
        debounce(func, wait) {
          let timeout;
          return function (...args) {
            const context = this;
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(context, args), wait);
          };
        },
        validateInput: (value, type) => {
          switch (type) {
            case "required":
              return !!value.trim();
            case "number":
              return !isNaN(value) && value >= 0;
            case "url":
              try {
                new URL(value);
                return true;
              } catch (e) {
                return false;
              }
            case "phone":
              return /^\+?[\d\s-]{8,}$/.test(value);
            default:
              return true;
          }
        },
        logError: (message, error) => {
          console.error(`[SistemAkuntansi] ${message}`, error);
        },
      };

      /**
       * Main accounting system class
       */
      class SistemAkuntansi {
        showHistoryOverlay(type) {
    const overlay = document.getElementById(`history-overlay-${type}`);
    if (overlay) {
        overlay.style.display = 'flex';
    }
}

hideHistoryOverlay(type) {
    const overlay = document.getElementById(`history-overlay-${type}`);
    if (overlay) {
        overlay.style.display = 'none';
    }
}

        constructor() {
          this.STORAGE_KEY = "sistemAkuntansiData_v5.1";
          this.DRAFT_KEY = "sistemAkuntansiDraft_v5.1";
          this.TRASH_KEY = "sistemAkuntansiTrash_v5.1";

          this.data = null;
          this.trash = [];
          this.activeDropdown = null;
          this.trash = [];
          this.activeDropdown = null;
          this.tempItems = { sale: [], purchase: [], edit: [] };
          this.draftForms = { sale: null, purchase: null };
          
          // Form step state including edit
          this.formSteps = { sale: 1, purchase: 1, edit: 1 };

          this.masterItemsPage = 1

          this.npwpPage = 1
          
          this.partyDetails = {
            customer: new Map(),
            pemasok: new Map(),
          };

          this.itemIndex = new Map();
          this.isLoading = false;
          this.eventControllers = new Map();
          this.notificationTimeout = null;
          this.editingId = null; // Track currently editing transaction ID
        }

        async init() {
          try {
            this.cleanup();
            console.log("Starting init v5.1...");
            
            // Load Dark Mode Preference
            this.loadDarkMode();

            this.showLoading(true);
            await this.loadData();
            this.buildDOM();
            this.bindGlobalEvents();
            await this.updateAllUI();
            
            // NEW: Load Drafts & Render Chart
            this.loadDrafts();
            setTimeout(() => this.renderDashboardChart(), 500); 

            // RESPONSIVE AUTO-SCALE LISTENER
            window.addEventListener('resize', Utils.debounce(() => {
                if(document.getElementById('dashboard-stats')) {
                    this.autoScaleStatFonts();
                    this.renderDashboardChart(this.currentDashboardStart, this.currentDashboardEnd);
                }
            }, 200));
          } catch (error) {
            Utils.logError("Initialization failed", error);
            this.showNotification(
              "Gagal memuat sistem: " + error.message,
              false
            );
          } finally {
            this.showLoading(false);
          }
        }

        toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            localStorage.setItem('darkMode', isDark);
            
            this.showNotification(isDark ? 'Mode Gelap Aktif' : 'Mode Terang Aktif');
        }

        loadDarkMode() {
            const isDark = localStorage.getItem('darkMode') === 'true';
            if (isDark) document.body.classList.add('dark-mode');
        }

        // Wrapper methods for edit form navigation (fixing app.nextStep is not a function)
        nextStep(type, currentStep) {
            this.navigateToStep(type, currentStep + 1);
        }

        prevStep(type, currentStep) {
            this.navigateToStep(type, currentStep - 1);
        }

        switchSubTab(type) {
            // Hide all sub-views
            document.querySelectorAll('.sub-view').forEach(el => el.style.display = 'none');
            // Show target
            const target = document.getElementById(`view-history-${type}`);
            if(target) target.style.display = 'block';

            // Update buttons
            document.querySelectorAll('.sub-tab-btn').forEach(btn => {
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-secondary');
            });
            const activeBtn = document.getElementById(`btn-subtab-${type}`);
            if(activeBtn) {
                activeBtn.classList.remove('btn-secondary');
                activeBtn.classList.add('btn-primary');
            }
        }

        showLoading(show) {
          this.isLoading = show;
          document.getElementById("loadingOverlay").style.display = show
            ? "flex"
            : "none";
        }

        cleanup() {
          this.eventControllers.forEach((controller) => controller.abort());
          this.eventControllers.clear();
        }

        buildDOM() {
    this.cleanup();

    // Create a container for floating buttons
    let fabGroup = document.getElementById('fab-group');
    if (fabGroup) fabGroup.remove();
    fabGroup = document.createElement('div');
    fabGroup.id = 'fab-group';
    fabGroup.className = 'floating-action-group';
    document.body.appendChild(fabGroup);

    const historyIconSVG = `<svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 -960 960 960" width="24" fill="currentColor"><path d="M320-240q-33 0-56.5-23.5T240-320v-480q0-33 23.5-56.5T320-880h480q33 0 56.5 23.5T880-800v480q0 33-23.5 56.5T800-240H320Zm0-80h480v-480H320v480ZM160-80q-33 0-56.5-23.5T80-160v-560h80v560h560v80H160Zm160-720v480-480Z"/></svg>`;

    // Clear the new tab content first
    // Clear and Setup the new tab content with Sub-Navigation
    const dataTransaksiContainer = document.getElementById("data-transaksi");
    if (dataTransaksiContainer) {
        dataTransaksiContainer.innerHTML = `
            <div class="sub-tab-container" style="padding: 20px; border-bottom: 1px solid var(--border); margin-bottom: 20px; background: var(--card-bg); display:flex; gap:10px; align-items:center; border-radius: 8px;">
                <label style="font-weight:600; margin-right:10px; color: var(--text);">Pilih Data:</label>
                <button id="btn-subtab-sale" class="btn btn-primary sub-tab-btn" onclick="app.switchSubTab('sale')">Riwayat Penjualan</button>
                <button id="btn-subtab-purchase" class="btn btn-secondary sub-tab-btn" onclick="app.switchSubTab('purchase')">Riwayat Pembelian</button>
            </div>
        `;
    }

    ["sale", "purchase"].forEach((type) => {
        const containerId = type === "sale" ? "penjualan" : "pembelian";
        const container = document.getElementById(containerId);
        if (container) {
             container.innerHTML = this.generateFormHTML(type);
        }

        // Render History to the NEW TAB "Data Transaksi"
        if (dataTransaksiContainer) {
            const historyHTML = this.generateHistoryHTML(type);
            const isHidden = type === 'purchase'; // Default hide purchase
            const wrapper = `
                <div id="view-history-${type}" class="sub-view" style="display: ${isHidden ? 'none' : 'block'}; animation: fadeIn 0.3s ease;">
                    ${historyHTML}
                </div>
            `;
            dataTransaksiContainer.insertAdjacentHTML('beforeend', wrapper);
        }
    });

    // Keep the rest of the buildDOM logic
    const invoiceContainer = document.getElementById("invoices");
    if (invoiceContainer) invoiceContainer.innerHTML = this.generateHistoryHTML("invoice");

    const dashboardContainer = document.getElementById("dashboard");
    if (dashboardContainer) dashboardContainer.innerHTML = this.generateDashboardHTML();

    const npwpManagementContainer = document.getElementById("npwp-management-section");
    if(npwpManagementContainer) npwpManagementContainer.innerHTML = this.generateNpwpManagementHTML();

    const pengaturanContainer = document.getElementById("pengaturan");
    if (pengaturanContainer) {
        let trashSection = document.getElementById("trash-section");
        if (trashSection) trashSection.remove();
        trashSection = document.createElement("div");
        trashSection.id = "trash-section";
        pengaturanContainer.appendChild(trashSection);
        trashSection.innerHTML = this.generateTrashHTML();
        this.renderTrashTable();
    }
}

        generateFormHTML(type) {
        // ADD THIS:
  const stepperHTML = `
    <div class="stepper" id="stepper-${type}">
      <div class="step active" data-step="1">
        <div class="step-number">1</div>
        <div class="step-title">Informasi Dasar</div>
      </div>
      <div class="step" data-step="2">
        <div class="step-number">2</div>
        <div class="step-title">Tambah Barang</div>
      </div>
      <div class="step" data-step="3">
        <div class="step-number">3</div>
        <div class="step-title">Ringkasan</div>
      </div>
    </div>
  `;

  const isTransaction = type === "sale" || type === "purchase";
  if (!isTransaction) return '';

  const title = type === "sale" ? "Penjualan" : "Pembelian";
  const partyLabel = type === "sale" ? "Customer" : "Pemasok";
  const partyType = type === "sale" ? "customer" : "pemasok";

  const step1_infoDasar = `
  <div class="form-step active" id="form-step-1-${type}">
    ${/* PPN Checkbox */ `
    <div class="form-group" style="grid-column: 1 / -1; background-color: var(--background); padding: 12px; border-radius: 8px; border: 1px solid var(--border);">
      <div style="display: flex; align-items: center; gap: 10px;">
        <input type="checkbox" id="includePpn-${type}" style="width: auto; height: 1.3em; transform: scale(1.3);">
        <label for="includePpn-${type}" style="margin-bottom: 0; font-weight: bold; font-size: 1.05rem; color: red; cursor: pointer;">GUNAKAN PPN 11% (Membuat Invoice)</label>
      </div>
      
      <div class="form-group bebas-ppn-group hidden" id="bebas-ppn-group-${type}" style="margin-top: 10px; padding-left: 35px;">
        <div style="display: flex; align-items: center; gap: 10px;">
            <input type="checkbox" id="bebasPpn-${type}" style="width: auto;">
            <label for="bebasPpn-${type}" style="margin-bottom: 0; font-weight: 600; color: #d97706; cursor: pointer;">Bebas PPN</label>
        </div>
      </div>
      </div>`}
      <div class="form-grid">
        <div class="form-group-cluster">
          <h4 class="form-group-cluster-title">Informasi ${partyLabel}</h4>
          <div class="form-group filterable-dropdown">
            <label for="${partyType}Name-${type}">Nama ${partyLabel}</label>
            <input type="text" id="${partyType}Name-${type}" required autocomplete="off">
            <div class="dropdown-options" id="party-dropdown-${type}"></div>
          </div>
          <div class="form-group">
            <label for="${partyType}Address-${type}">Alamat ${partyLabel}</label>
            <input type="text" id="${partyType}Address-${type}">
          </div>
          <div class="form-group">
            <label for="${partyType}Phone-${type}">Telepon ${partyLabel}</label>
            <input type="tel" id="${partyType}Phone-${type}" placeholder="Contoh: 0812...">
          </div>
          <div class="form-group npwp-group hidden" id="npwp-group-${type}">
            <label for="${partyType}Npwp-${type}">NPWP/NIK</label>
            <input type="text" id="${partyType}Npwp-${type}" placeholder="Contoh: 01.234.567.8-901.000">
          </div>
        </div>
        <div class="form-group-cluster">
          <h4 class="form-group-cluster-title">Informasi Transaksi</h4>
          <div class="form-group">
            <label for="transNo-${type}">No. Transaksi</label>
            <input type="text" id="transNo-${type}" readonly value="${this.generateId(type)}">
          </div>
          <div class="form-group">
            <label for="invoiceDate-${type}">Tanggal</label>
            <input type="date" id="invoiceDate-${type}" required value="${new Date().toISOString().slice(0, 10)}">
          </div>
          <div class="form-group">
            <label for="paymentMethod-${type}">Metode Pembayaran</label>
            <select id="paymentMethod-${type}"><option value="Transfer">Transfer</option><option value="Tunai">Tunai</option><option value="Kredit">Kredit</option></select>
          </div>
          <div class="form-group">
            <label for="vehicleNo-${type}">No. Kendaraan</label>
            <input type="text" id="vehicleNo-${type}">
          </div>
          ${type === "sale" ? `<div class="form-group"><label for="ref-${type}">Ref</label><input type="text" id="ref-${type}"></div>` : ""}
        </div>
      </div>
      <div class="step-actions">
        <span></span> <button type="button" class="btn btn-primary" onclick="app.navigateToStep('${type}', 2)">Lanjutkan ke Tambah Barang &rarr;</button>
      </div>
    </div>`;

  const step2_tambahBarang = `
    <div class="form-step" id="form-step-2-${type}">
      <div class="form-section" style="padding:15px; margin-top:0;">
        <div class="form-grid">
          <div class="form-group filterable-dropdown" style="grid-column: 1 / -1;"><label for="item-selector-${type}">Cari Barang (Nama/Kode)</label><input type="text" id="item-selector-${type}" autocomplete="off" placeholder="Ketik nama atau kode barang..."><div class="dropdown-options" id="dropdown-options-${type}"></div></div>
          <div class="form-group"><label for="itemCode-${type}">Kode Barang</label><input type="text" id="itemCode-${type}" readonly></div>
          <div class="form-group"><label for="itemQty-${type}">Jumlah</label><input type="number" id="itemQty-${type}" min="0" step="0.01" value="0" required></div>
          <div class="form-group"><label for="itemUnit-${type}">Satuan</label><input type="text" id="itemUnit-${type}"></div>
          <div class="form-group"><label for="itemPrice-${type}">Harga Satuan (Rp)</label><input type="text" id="itemPrice-${type}" class="rupiah-input" value="0" required></div>
          <div class="form-group" style="grid-column: 1 / -1; align-self: flex-end; display: flex; align-items: center; justify-content: flex-end; gap: 15px;"><button type="button" id="addItemBtn-${type}" class="btn btn-primary">Tambah</button><span style="color: red; font-weight: 600; white-space: nowrap;">TAMBAHKAN BARANG TERLEBIH DAHULU</span></div>
        </div>
      </div>
      <div class="table-container">
        <table class="data-table" id="temp-items-table-${type}">
          <thead><tr><th>No</th><th>Kode</th><th>Nama Barang</th><th class="text-right">Jumlah</th><th>Satuan</th><th class="text-right">Harga Satuan</th><th class="text-right">Total</th><th class="action-cell">Aksi</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="step-actions">
        <button type="button" class="btn btn-warning" onclick="app.navigateToStep('${type}', 1)">&larr; Kembali ke Info Dasar</button>
        <button type="button" class="btn btn-primary" onclick="app.navigateToStep('${type}', 3)">Lanjutkan ke Ringkasan &rarr;</button>
      </div>
    </div>`;

  const step3_ringkasan = `
    <div class="form-step" id="form-step-3-${type}">
      <div class="summary-section">
        <div class="summary-grid">
          <label>Subtotal:</label>
          <div><div class="total-amount-display" id="subtotal-${type}">Rp 0</div><div class="dpp-info-display" id="dpp-info-${type}"></div></div>
          <label for="discount-${type}">Diskon (Rp):</label><input type="text" id="discount-${type}" class="rupiah-input" value="0">
          <label for="shippingCost-${type}">Ongkos Kirim (Rp):</label><input type="text" id="shippingCost-${type}" class="rupiah-input" value="0">
          <label for="dp-${type}">Uang Muka / DP (Rp):</label><input type="text" id="dp-${type}" class="rupiah-input" value="0">
          <label>PPN 11%:</label><div class="total-amount-display" id="ppn-${type}">Rp 0</div>
          <label>Grand Total:</label><div class="total-amount-display" id="grandTotal-${type}">Rp 0</div>
        </div>
      </div>
      <div class="form-group" style="grid-column: 1 / -1; margin-top: 20px;">
        <label for="notes-${type}">Catatan</label>
        <textarea id="notes-${type}" rows="3" placeholder="Tambahkan catatan untuk transaksi ini..."></textarea>
      </div>
      <div class="actions-group step-actions">
        <button type="button" class="btn btn-warning" onclick="app.navigateToStep('${type}', 2)">&larr; Kembali ke Tambah Barang</button>
        <div>
          <button type="button" class="btn btn-danger" onclick="app.resetForm('${type}')">Reset Form</button>
          <button type="submit" class="btn btn-success">Simpan Transaksi</button>
          
        </div>
      </div>
    </div>`;

  return `<div class="form-section">
            <h3 class="form-section-title">Form ${title}</h3>
            <form id="${type}Form">
              ${stepperHTML}  ${step1_infoDasar}
              ${step2_tambahBarang}
              ${step3_ringkasan}
            </form>
          </div>`;
}

//  TAMBAHKAN FUNGSI BARU INI DI DALAM CLASS 
navigateToStep(type, step) {
  // Validasi sederhana: jangan biarkan ke langkah 2 atau 3 jika item kosong di langkah 2
  if (step > 1 && this.tempItems[type].length === 0) {
      const partyInput = document.getElementById(`${type === 'sale' ? 'customer' : 'pemasok'}Name-${type}`);
      if (!partyInput.value.trim()) {
        this.showNotification("Harap isi Nama Customer/Pemasok terlebih dahulu.", false);
        partyInput.focus();
        return;
      }
  }
  if (step === 3 && this.tempItems[type].length === 0) {
    this.showNotification("Harap tambahkan minimal satu barang sebelum melanjutkan.", false);
    return;
  }
  
  this.formSteps[type] = step;
  const form = document.getElementById(`${type}Form`);
  if (!form) return;

  form.querySelectorAll('.form-step').forEach(s => s.classList.remove('active'));
  const activeStep = form.querySelector(`#form-step-${step}-${type}`);
  if (activeStep) {
    activeStep.classList.add('active');
  }

  // ADD THIS NEW LOGIC BLOCK:
  const stepper = document.getElementById(`stepper-${type}`);
  if (stepper) {
      const steps = stepper.querySelectorAll('.step');
      steps.forEach(s => {
          const stepNumber = parseInt(s.dataset.step, 10);
          s.classList.remove('active', 'completed');
          if (stepNumber < step) {
              s.classList.add('completed');
          } else if (stepNumber === step) {
              s.classList.add('active');
          }
      });
  }
}
//  TAMBAHKAN FUNGSI BARU INI DI DALAM CLASS 
        
        bindGlobalEvents() {
            this.cleanup();
            const globalController = new AbortController();
            this.eventControllers.set("global", globalController);
            const { signal } = globalController;

            document.addEventListener("click", (e) => {
                if (!e.target.closest(".filterable-dropdown")) {
                    this.closeAllDropdowns();
                }
            }, { signal });

            // Settings tab listeners
            document.getElementById("saveConfigBtn")?.addEventListener("click", () => this.saveConfig(), { signal });
            document.getElementById("backupDataBtn")?.addEventListener("click", () => this.backupData(), { signal });
            document.getElementById("restoreDataBtn")?.addEventListener("click", () => document.getElementById("restoreFileInput")?.click(), { signal });
            document.getElementById("restoreFileInput")?.addEventListener("change", (e) => this.restoreData(e), { signal });

    // Listener untuk manajemen barang yang baru
    document.getElementById("show-add-item-form")?.addEventListener("click", () => this.showItemEditor(), { signal });
    document.getElementById("item-editor-form")?.addEventListener("submit", (e) => this.saveMasterItemFromModal(e), { signal });
    document.getElementById("cancel-edit-btn")?.addEventListener("click", () => this.hideItemEditor(), { signal });
    document.getElementById("search-master-items")?.addEventListener("input", Utils.debounce(() => {
        this.masterItemsPage = 1; // Reset ke halaman 1 setiap kali mencari
        this.renderMasterItemsTable();
    }, 300), { signal });

    document.getElementById("prev-item-page")?.addEventListener("click", () => {
        if (this.masterItemsPage > 1) {
            this.masterItemsPage--;
            this.renderMasterItemsTable();
        }
    }, { signal });

    document.getElementById("next-item-page")?.addEventListener("click", () => {
        this.masterItemsPage++;
        this.renderMasterItemsTable();
    }, { signal });

            //  TAMBAHKAN LISTENER BARU INI 
document.getElementById("show-add-npwp-form")?.addEventListener("click", () => this.showNpwpEditor(), { signal });
document.getElementById("npwp-editor-form")?.addEventListener("submit", (e) => this.saveNpwpFromModal(e), { signal });
document.getElementById("cancel-npwp-edit-btn")?.addEventListener("click", () => this.hideNpwpEditor(), { signal });
document.getElementById("search-npwp-items")?.addEventListener("input", Utils.debounce(() => {
    this.npwpPage = 1;
    this.renderNpwpTable();
}, 300), { signal });

document.getElementById("prev-npwp-page")?.addEventListener("click", () => {
    if (this.npwpPage > 1) {
        this.npwpPage--;
        this.renderNpwpTable();
    }
}, { signal });

document.getElementById("next-npwp-page")?.addEventListener("click", () => {
    this.npwpPage++;
    this.renderNpwpTable();
}, { signal });


            const dashboardFilters = document.getElementById("dashboard-filters");
            if (dashboardFilters) {
                dashboardFilters.addEventListener("input", Utils.debounce(() => this.renderDashboard(), 300), { signal });
            }

            ["sale", "purchase", "edit"].forEach((type) => {
                this.bindFormEvents(type);
            });

            document.querySelector('.container').addEventListener('input', (e) => {
                if (e.target.closest('.history-filters')) {
                    const historyFilters = e.target.closest('.history-filters');
                    const type = historyFilters.id.replace('history-filters-', '');
                    const dataKey = type === 'sale' ? 'penjualan' : type === 'purchase' ? 'pembelian' : type;
                    Utils.debounce(() => this.renderHistoryTable(dataKey, `${type}-history-table`), 300)();
                }
            });

            document.querySelector('.container').addEventListener('click', (e) => {
                const button = e.target.closest('button[data-key]');
                if (!button) return;

                const dataKey = button.getAttribute('data-key');
                if (button.id.startsWith('export-excel-btn-')) {
                    this.exportHistoryToExcel(dataKey);
                } else if (button.id.startsWith('export-pdf-btn-')) {
                    this.exportHistoryToPdf(dataKey);
                }
            });
        }

        bindFormEvents(type) {
            const controller = new AbortController();
            this.eventControllers.set(`form-${type}`, controller);
            const { signal } = controller;

            const form = document.getElementById(`${type}Form`);
            if (!form) return;

            form.addEventListener("submit", (e) => {
                e.preventDefault();
                this.saveTransaction(type);
                // Clear draft on successful submit (handled in saveTransaction usually, or explicit clear here if save is async/verified)
                localStorage.removeItem(`${this.DRAFT_KEY}_${type}`); 
            }, { signal });

            form.addEventListener("input", Utils.debounce(() => this.saveDraft(type), 1000), { signal });
            
            let partyType = type === 'sale' ? 'customer' : 'pemasok';
            // Logic for 'edit' to bind correctly
            if (type === 'edit') {
                 // In edit mode we can't fully know if it is customer or pemasok just by type 'edit'
                 // But the ID in HTML is generic 'partyName-edit'
                 // We will rely on 'transType-edit' hidden field at runtime or just bind the generic ID
                 partyType = 'party'; 
            }
            
            // If type is edit, ID is partyName-edit. If sale, customerName-sale.
            const inputId = type === 'edit' ? `partyName-edit` : `${partyType}Name-${type}`;
            const partyInput = form.querySelector(`#${inputId}`);

            if (partyInput) {
                // For edit mode, we need to know what to filter (customer or pemasok) dynamically
                partyInput.addEventListener("input", Utils.debounce(() => this.filterPartyNames(type), 300), { signal });
                partyInput.addEventListener("focus", () => this.filterPartyNames(type, true), { signal });
                
                const dropdownId = type === 'edit' ? `party-dropdown-edit` : `party-dropdown-${type}`;
                const dropdown = form.querySelector(`#${dropdownId}`);
                
                if (dropdown) {
                    dropdown.addEventListener("click", (e) => {
                        const option = e.target.closest(".dropdown-option");
                        if (option) {
                            const selectedName = option.dataset.name;
                            partyInput.value = selectedName;
                            this.populatePartyDetails(selectedName, type);
                            this.closeAllDropdowns();
                            this.saveDraft(type); // Save draft on selection
                        }
                    }, { signal });
                }
            }



            const itemSelector = form.querySelector(`#item-selector-${type}`);
            const dropdownOptions = form.querySelector(`#dropdown-options-${type}`);

            itemSelector?.addEventListener("input", Utils.debounce(() => this.filterDropdown(type), 300), { signal });
            itemSelector?.addEventListener("focus", () => this.filterDropdown(type, true), { signal });
            itemSelector?.addEventListener("keydown", (e) => {
                if (e.key === "ArrowDown" || e.key === "ArrowUp") {
                    e.preventDefault();
                    const options = Array.from(dropdownOptions.querySelectorAll(".dropdown-option"));
                    if (!options.length) return;
                    const current = dropdownOptions.querySelector(".dropdown-option.focused");
                    let index = current ? options.indexOf(current) : -1;
                    if (e.key === "ArrowDown") {
                        index = (index + 1) % options.length;
                    } else if (e.key === "ArrowUp") {
                        index = (index - 1 + options.length) % options.length;
                    }
                    options.forEach(o => o.classList.remove("focused"));
                    if (index >= 0) {
                        options[index].classList.add("focused");
                        options[index].scrollIntoView({ block: "nearest" });
                    }
                } else if (e.key === "Enter" && dropdownOptions.style.display === "block") {
                    e.preventDefault();
                    const focused = dropdownOptions.querySelector(".dropdown-option.focused");
                    if (focused && focused.dataset.code) {
                        this.selectItemFromDropdown(focused.dataset.code, type);
                    }
                }
            }, { signal });

            dropdownOptions?.addEventListener("click", (e) => {
                const option = e.target.closest(".dropdown-option");
                if (option && option.dataset.code) {
                    this.selectItemFromDropdown(option.dataset.code, type);
                }
            }, { signal });

            form.querySelector(`#addItemBtn-${type}`)?.addEventListener("click", () => this.addItemToTempList(type), { signal });
            form.querySelector(`#temp-items-table-${type}`)?.addEventListener("click", (e) => {
                if (e.target.classList.contains("delete-temp-item-btn")) {
                    this.deleteItemFromTempList(parseInt(e.target.dataset.id, 10), type);
                }
            }, { signal });

            ["itemPrice", "shippingCost", "discount", "dp", "itemQty", "itemUnit"].forEach((id) => {
                const input = form.querySelector(`#${id}-${type}`);
                if (input) {
                    input.addEventListener("input", (e) => {
                        if(input.classList.contains('rupiah-input')) Utils.formatRupiahInput(e.target);
                    });
                    input.addEventListener("blur", () => this.calculateTotals(type));
                    
                    // Trap Enter key for item inputs to add item instead of submit
                    if (["itemPrice", "itemQty", "itemUnit"].includes(id)) {
                        input.addEventListener("keydown", (e) => {
                            if (e.key === "Enter") {
                                e.preventDefault();
                                this.addItemToTempList(type);
                            }
                        });
                    }
                }
            });
            
            const ppnCheckbox = form.querySelector(`#includePpn-${type}`);
if (ppnCheckbox) {
    ppnCheckbox.addEventListener("change", () => {
        this.calculateTotals(type);
        
        let partyType = type === 'sale' ? 'customer' : 'pemasok';
        if (type === 'edit') partyType = 'party';
        
        const npwpGroup = document.getElementById(`npwp-group-${type}`);
        const npwpId = type === 'edit' ? `partyNpwp-edit` : `${partyType}Npwp-${type}`;
        const npwpInput = document.getElementById(npwpId);
        
        //  PERUBAHAN DIMULAI 
        const bebasPpnGroup = document.getElementById(`bebas-ppn-group-${type}`);
        const bebasPpnCheckbox = document.getElementById(`bebasPpn-${type}`);
        //  PERUBAHAN SELESAI 

        if (ppnCheckbox.checked) {
            npwpGroup.classList.remove('hidden');
            npwpInput.required = true;
            //  PERUBAHAN DIMULAI 
            bebasPpnGroup.classList.remove('hidden'); 
            //  PERUBAHAN SELESAI 
        } else {
            npwpGroup.classList.add('hidden');
            npwpInput.required = false;
            //  PERUBAHAN DIMULAI 
            bebasPpnGroup.classList.add('hidden');
            if (bebasPpnCheckbox) bebasPpnCheckbox.checked = false; // Uncheck 'Bebas PPN' if PPN is disabled
            //  PERUBAHAN SELESAI 
        }
    }, { signal });
}

//  PERUBAHAN DIMULAI 
// Add a new event listener for the 'Bebas PPN' checkbox
const bebasPpnCheckbox = form.querySelector(`#bebasPpn-${type}`);
if (bebasPpnCheckbox) {
    bebasPpnCheckbox.addEventListener("change", () => {
        this.calculateTotals(type); // Recalculate totals when this checkbox changes
    }, { signal });
}
        }

        // AUTO-SAVE LOGIC
        saveDraft(type) {
            if (type === 'edit') return; // Don't auto-save edit mode
            const form = document.getElementById(`${type}Form`);
            if (!form) return;

            const formData = {};
            // Capture inputs
            form.querySelectorAll('input, select, textarea').forEach(input => {
                if (input.id) formData[input.id] = input.type === 'checkbox' ? input.checked : input.value;
            });
            // Capture temp items
            formData.tempItems = this.tempItems[type];

            localStorage.setItem(`${this.DRAFT_KEY}_${type}`, JSON.stringify(formData));
        }

        loadDrafts() {
            ['sale', 'purchase'].forEach(type => {
                const draft = localStorage.getItem(`${this.DRAFT_KEY}_${type}`);
                if (draft) {
                    try {
                        const data = JSON.parse(draft);
                        this.tempItems[type] = data.tempItems || [];
                        
                        // Restore inputs
                        Object.keys(data).forEach(key => {
                            if (key === 'tempItems') return;
                            const input = document.getElementById(key);
                            if (input) {
                                if (input.type === 'checkbox') input.checked = data[key];
                                else input.value = data[key];
                            }
                        });
                        this.renderTempItems(type);
                        this.calculateTotals(type);
                        const ppnCheck = document.getElementById(`includePpn-${type}`);
                        if(ppnCheck) ppnCheck.dispatchEvent(new Event('change'));
                    } catch (e) {
                        console.error("Failed to load draft", e);
                    }
                }
            });
        }

        // CHART LOGIC
        async renderDashboard() {
             const dashboardContainer = document.getElementById("dashboard");
             if (dashboardContainer) {
                 dashboardContainer.innerHTML = this.generateDashboardHTML();
                 this.renderDashboardChart(); // Call chart render
             }
        }

        renderDashboardChart(startDate, endDate) {
            const filterPredicate = t => (!startDate || t.tanggal >= startDate) && (!endDate || t.tanggal <= endDate);
            
            // Collect all sales and purchases
            const allSales = [...this.data.penjualan, ...this.data.invoices.filter(inv => inv.transType === 'sale')].filter(filterPredicate);
            const allPurchases = [...this.data.pembelian, ...this.data.invoices.filter(inv => inv.transType === 'purchase')].filter(filterPredicate);

            // Destroy existing charts if they exist
            if (this.salesChartInst) this.salesChartInst.destroy();
            if (this.productChartInst) this.productChartInst.destroy();

            const isDark = document.body.classList.contains('dark-mode');
            const textColor = isDark ? '#ffffff' : '#475569';

            // 1. Combination Chart (Sales, Purchase, Profit)
            const ctxSales = document.getElementById('salesChart');
            if (ctxSales) {
                const salesMap = new Map();
                const purchaseMap = new Map();
                
                allSales.forEach(item => {
                    const date = item.tanggal;
                    salesMap.set(date, (salesMap.get(date) || 0) + (item.grandTotal || 0));
                });
                allPurchases.forEach(item => {
                    const date = item.tanggal;
                    purchaseMap.set(date, (purchaseMap.get(date) || 0) + (item.grandTotal || 0));
                });
                
                const allDates = Array.from(new Set([...salesMap.keys(), ...purchaseMap.keys()])).sort();
                
                this.salesChartInst = new Chart(ctxSales, {
                    type: 'bar',
                    data: {
                        labels: allDates.map(d => this.formatDate(d)),
                        datasets: [
                            {
                                type: 'line',
                                label: 'Keuntungan',
                                data: allDates.map(d => (salesMap.get(d)||0) - (purchaseMap.get(d)||0)),
                                borderColor: '#10b981',
                                borderWidth: 3,
                                fill: false,
                                tension: 0.4,
                                order: 1
                            },
                            {
                                type: 'bar',
                                label: 'Penjualan',
                                data: allDates.map(d => salesMap.get(d)||0),
                                backgroundColor: 'rgba(59, 130, 246, 0.6)',
                                borderRadius: 4,
                                order: 2
                            },
                            {
                                type: 'bar',
                                label: 'Pembelian',
                                data: allDates.map(d => purchaseMap.get(d)||0),
                                backgroundColor: 'rgba(249, 115, 22, 0.6)',
                                borderRadius: 4,
                                order: 3
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: { mode: 'index', intersect: false },
                        scales: {
                            x: { 
                                grid: { display: false }, 
                                ticks: { 
                                    color: textColor, 
                                    maxRotation: 45, 
                                    minRotation: 45,
                                    font: { size: window.innerWidth < 600 ? 10 : 12 }
                                } 
                            },
                            y: { 
                                grid: { color: isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.05)' },
                                ticks: { 
                                    color: textColor,
                                    font: { size: window.innerWidth < 600 ? 10 : 12 }
                                }
                            }
                        },
                        plugins: {
                            legend: { 
                                labels: { 
                                    usePointStyle: true, 
                                    color: textColor,
                                    font: { size: window.innerWidth < 600 ? 11 : 13 }
                                } 
                            }
                        }
                    }
                });
            }

            // 2. Donut Chart (Top Products)
            const ctxProduct = document.getElementById('productChart');
            if (ctxProduct) {
                const productCounts = {};
                allSales.forEach(tx => {
                    (tx.items || []).forEach(item => {
                        productCounts[item.name] = (productCounts[item.name] || 0) + (item.qty || 0);
                    });
                });
                
                const sortedProducts = Object.entries(productCounts)
                    .sort((a,b) => b[1] - a[1])
                    .slice(0, 5);
                
                this.productChartInst = new Chart(ctxProduct, {
                    type: 'doughnut',
                    data: {
                        labels: sortedProducts.map(p => p[0]),
                        datasets: [{
                            data: sortedProducts.map(p => p[1]),
                            backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'],
                            hoverOffset: 15,
                            borderWidth: 2,
                            borderColor: document.body.classList.contains('dark-mode') ? '#1e293b' : '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: '70%',
                        plugins: {
                            legend: { 
                                position: 'bottom', 
                                labels: { 
                                    color: textColor, 
                                    padding: window.innerWidth < 600 ? 10 : 20, 
                                    usePointStyle: true,
                                    font: { size: window.innerWidth < 600 ? 10 : 12 }
                                } 
                            }
                        }
                    }
                });
            }
        }
        
        // ... (rest of the class methods are mostly unchanged)
        
        async updateAllUI() {
    try {
        this.showLoading(true);
        this.renderAllHistoryTables();
        await this.renderDashboard();

        //  GANTI BARIS INI 
        // await this.renderMasterItemsTextarea();
        await this.renderMasterItemsTable(); // Menjadi ini
        //  SELESAI 

        await this.renderNpwpTable();
        // this.updateMasterItemCountDisplay(); // Fungsi ini sekarang dipanggil di dalam renderMasterItemsTable
        this.loadConfigToForm();
        this.renderTrashTable();
    } catch (error) {
        Utils.logError("UI update failed", error);
        this.showNotification("Gagal memperbarui UI", false);
    } finally {
        this.showLoading(false);
    }
}
        
        // PENAMBAHAN FITUR: All new methods for NPWP management
        
        generateNpwpManagementHTML() {
    return `<div class="form-section">
        <h3 class="form-section-title">Manajemen Data NPWP/NIK</h3>

        <div id="npwp-editor-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1001; display:flex; align-items:center; justify-content:center; display:none;">
            <form id="npwp-editor-form" style="background:white; padding:25px; border-radius:10px; width:90%; max-width:800px;">
                <h4 class="form-section-title" style="margin-top:0;">Editor Data Customer/Pemasok</h4>
                <input type="hidden" id="edit-npwp-original-name">
                <input type="hidden" id="edit-npwp-original-type">
                <div class="form-grid">
                    <div class="form-group"><label>Nama Customer/Pemasok</label><input type="text" id="edit-npwp-name" required></div>
                    <div class="form-group"><label>Jenis</label><select id="edit-npwp-type" required><option value="customer">Customer</option><option value="pemasok">Pemasok</option></select></div>
                    <div class="form-group"><label>NPWP/NIK</label><input type="text" id="edit-npwp-number"></div>
                    <div class="form-group"><label>Alamat</label><input type="text" id="edit-npwp-address"></div>
                    <div class="form-group" style="grid-column: 1 / -1;"><label>Telepon</label><input type="text" id="edit-npwp-phone"></div>
                </div>
                <div class="actions-group">
                    <button type="submit" class="btn btn-primary">Simpan Data</button>
                    <button type="button" id="cancel-npwp-edit-btn" class="btn btn-warning">Batal</button>
                </div>
            </form>
        </div>

        <div class="actions-group" style="justify-content: space-between;">
            <button id="show-add-npwp-form" class="btn btn-success">Tambah Data Baru</button>
            <div class="form-group" style="min-width: 300px; margin-bottom:0;">
                <input type="text" id="search-npwp-items" placeholder="Cari berdasarkan nama, NPWP, atau alamat...">
            </div>
        </div>

        <div class="table-container" style="margin-top: 20px;">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Nama</th>
                        <th>Jenis</th>
                        <th>NPWP/NIK</th>
                        <th>Alamat</th>
                        <th>Telepon</th>
                        <th class="action-cell">Aksi</th>
                    </tr>
                </thead>
                <tbody id="npwp-table-body"></tbody>
            </table>
        </div>
        <div class="actions-group" id="npwp-items-pagination" style="justify-content: space-between; align-items: center;">
            <p style="font-weight: bold;">Total Data: <span id="npwp-item-count">0</span></p>
            <div style="display: flex; gap: 10px; align-items: center;">
                <button class="btn btn-primary btn-sm" id="prev-npwp-page">&laquo; Sebelumnya</button>
                <span>Halaman <span id="current-npwp-page">1</span> dari <span id="total-npwp-pages">1</span></span>
                <button class="btn btn-primary btn-sm" id="next-npwp-page">Berikutnya &raquo;</button>
            </div>
        </div>
    </div>`;
}

//  TAMBAHKAN FUNGSI INI 
renderNpwpTable() {
    const tableBody = document.getElementById("npwp-table-body");
    if (!tableBody) return;

    // 1. Gabungkan data customer dan pemasok menjadi satu array
    const allParties = [];
    this.partyDetails.customer.forEach((details, name) => allParties.push({ type: 'customer', name, ...details }));
    this.partyDetails.pemasok.forEach((details, name) => allParties.push({ type: 'pemasok', name, ...details }));
    allParties.sort((a, b) => a.name.localeCompare(b.name));

    // 2. Filter berdasarkan input pencarian
    const searchInput = document.getElementById("search-npwp-items");
    const filter = searchInput ? searchInput.value.toUpperCase() : "";
    const filteredData = allParties.filter(p =>
        p.name.toUpperCase().includes(filter) ||
        (p.npwp || '').toUpperCase().includes(filter) ||
        (p.alamat || p.address || '').toUpperCase().includes(filter)
    );

    // 3. Logika Paginasi
    const itemsPerPage = 10;
    const totalPages = Math.ceil(filteredData.length / itemsPerPage) || 1;
    this.npwpPage = Math.max(1, Math.min(this.npwpPage, totalPages));
    const startIndex = (this.npwpPage - 1) * itemsPerPage;
    const paginatedData = filteredData.slice(startIndex, startIndex + itemsPerPage);

    // 4. Render baris tabel
    tableBody.innerHTML = paginatedData.map(p => `
        <tr>
            <td class="truncate-text">${this.sanitizeInput(p.name)}</td>
            <td><span class="btn btn-sm ${p.type === 'customer' ? 'btn-info' : 'btn-warning'}">${p.type}</span></td>
            <td>${this.sanitizeInput(p.npwp || '-')}</td>
            <td class="truncate-text">${this.sanitizeInput(p.alamat || p.address || '-')}</td>
            <td>${this.sanitizeInput(p.telepon || p.phone || '-')}</td>
            <td class="action-cell">
                <button class="btn btn-sm btn-warning" onclick="app.showNpwpEditor('${this.sanitizeInput(p.name)}', '${p.type}')">Edit</button>
                <button class="btn btn-sm btn-danger" onclick="app.deleteNpwpEntry('${this.sanitizeInput(p.name)}', '${p.type}')">Hapus</button>
            </td>
        </tr>
    `).join('');

    // 5. Update info paginasi
    document.getElementById('npwp-item-count').textContent = filteredData.length;
    document.getElementById('current-npwp-page').textContent = this.npwpPage;
    document.getElementById('total-npwp-pages').textContent = totalPages;
    document.getElementById('prev-npwp-page').disabled = this.npwpPage === 1;
    document.getElementById('next-npwp-page').disabled = this.npwpPage >= totalPages;
}

//  TAMBAHKAN 3 FUNGSI INI 
showNpwpEditor(name = null, type = 'customer') {
    const modal = document.getElementById('npwp-editor-modal');
    const form = document.getElementById('npwp-editor-form');
    form.reset();

    if (name) { // Mode Edit
        const details = this.partyDetails[type]?.get(name);
        if (details) {
            document.getElementById('edit-npwp-original-name').value = name;
            document.getElementById('edit-npwp-original-type').value = type;
            document.getElementById('edit-npwp-name').value = name;
            document.getElementById('edit-npwp-type').value = type;
            document.getElementById('edit-npwp-number').value = details.npwp || '';
            document.getElementById('edit-npwp-address').value = details.alamat || details.address || '';
            document.getElementById('edit-npwp-phone').value = details.telepon || details.phone || '';
            document.getElementById('edit-npwp-name').readOnly = true; // Kunci tidak bisa diubah
            document.getElementById('edit-npwp-type').disabled = true;
        }
    } else { // Mode Tambah
        document.getElementById('edit-npwp-original-name').value = '';
        document.getElementById('edit-npwp-original-type').value = '';
        document.getElementById('edit-npwp-name').readOnly = false;
        document.getElementById('edit-npwp-type').disabled = false;
    }
    modal.style.display = 'flex';
    document.getElementById('edit-npwp-name').focus();
}

hideNpwpEditor() {
    document.getElementById('npwp-editor-modal').style.display = 'none';
}

saveNpwpFromModal(event) {
    event.preventDefault();
    const originalName = document.getElementById('edit-npwp-original-name').value;
    const originalType = document.getElementById('edit-npwp-original-type').value;

    const name = document.getElementById('edit-npwp-name').value.trim();
    const type = document.getElementById('edit-npwp-type').value;
    const npwp = document.getElementById('edit-npwp-number').value.trim();
    const address = document.getElementById('edit-npwp-address').value.trim();
    const phone = document.getElementById('edit-npwp-phone').value.trim();

    if (!name) {
        this.showNotification("Nama harus diisi.", false);
        return;
    }

    const newDetails = { npwp, address, phone };

    if (originalName) { // Mode Edit
        this.partyDetails[originalType].set(originalName, newDetails);
        this.showNotification(`Data untuk '${name}' berhasil diperbarui.`);
    } else { // Mode Tambah
        if (this.partyDetails[type].has(name)) {
            this.showNotification(`Nama '${name}' sudah ada untuk jenis '${type}'.`, false);
            return;
        }
        this.partyDetails[type].set(name, newDetails);
        this.showNotification(`Data '${name}' berhasil ditambahkan.`);
    }

    this.saveData();
    this.renderNpwpTable();
    this.hideNpwpEditor();
}

//  TAMBAHKAN FUNGSI INI 
deleteNpwpEntry(name, type) {
    if (confirm(`Yakin ingin menghapus data untuk: ${name}?`)) {
        if (this.partyDetails[type]?.has(name)) {
            this.partyDetails[type].delete(name);
            this.saveData();
            this.renderNpwpTable();
            this.showNotification(`Data '${name}' berhasil dihapus.`);
        }
    }
}
        
        async renderNpwpTextarea() {
    const textarea = document.getElementById("npwp-json-data");
    if (!textarea) return;

    const combinedList = [];
    
    this.partyDetails.customer.forEach((details, name) => {
        combinedList.push({ 
            name, 
            type: 'customer', 
            npwp: details.npwp || '',
            alamat: details.address || details.alamat || '',
            phone: details.phone || details.telepon || ''
        });
    });

    this.partyDetails.pemasok.forEach((details, name) => {
        combinedList.push({ 
            name, 
            type: 'pemasok',
            npwp: details.npwp || '',
            alamat: details.address || details.alamat || '',
            phone: details.phone || details.telepon || ''
        });
    });

    combinedList.sort((a, b) => a.name.localeCompare(b.name));
    textarea.value = JSON.stringify(combinedList, null, 2);
}

async addNewNpwp() {
    const number = document.getElementById('new-npwp-number').value.trim();
    const name = document.getElementById('new-npwp-name').value.trim();
    const type = document.getElementById('new-npwp-type').value;

    if (!number || !name) {
        this.showNotification("Nomor NPWP/NIK dan Nama harus diisi.", false);
        return;
    }

    const existingDetails = this.partyDetails[type].get(name) || { address: '', phone: '', npwp: '' };
    existingDetails.npwp = number;
    
    this.partyDetails[type].set(name, existingDetails);
    this.saveData();
    await this.renderNpwpTextarea();
    this.showNotification(`Data NPWP untuk ${name} berhasil disimpan.`);
    document.getElementById('add-npwp-form').reset();
}

        async saveNpwpFromJson() {
            const textarea = document.getElementById("npwp-json-data");
            try {
                const data = JSON.parse(textarea.value);
                if (!Array.isArray(data)) throw new Error("Format JSON harus berupa array.");
                if (!data.every(item => item.hasOwnProperty("name") && item.hasOwnProperty("npwp") && item.hasOwnProperty("type"))) {
                    throw new Error('Setiap item harus memiliki properti "name", "npwp", dan "type".');
                }

                if (confirm("Anda yakin ingin menimpa semua data NPWP dengan data dari JSON ini?")) {
                    const tempCustomers = new Map();
                    const tempPemasok = new Map();

                    data.forEach(item => {
                        const targetMap = item.type === 'customer' ? tempCustomers : tempPemasok;
                        const existing = targetMap.get(item.name) || {};
                        targetMap.set(item.name, { ...existing, npwp: item.npwp });
                    });

                    // Merge with existing details to not lose address/phone
                    this.partyDetails.customer.forEach((details, name) => {
                        if (tempCustomers.has(name)) {
                            tempCustomers.set(name, { ...details, ...tempCustomers.get(name) });
                        }
                    });
                     this.partyDetails.pemasok.forEach((details, name) => {
                        if (tempPemasok.has(name)) {
                            tempPemasok.set(name, { ...details, ...tempPemasok.get(name) });
                        }
                    });

                    this.partyDetails.customer = tempCustomers;
                    this.partyDetails.pemasok = tempPemasok;

                    this.saveData();
                    await this.renderNpwpTextarea();
                    this.showNotification("Data NPWP berhasil disimpan dari JSON.");
                }
            } catch (error) {
                Utils.logError("Failed to save NPWP from JSON", error);
                this.showNotification(`Gagal menyimpan: ${error.message}`, false);
            }
        }
        
        async clearAllNpwp() {
            if (confirm("Yakin ingin menghapus SEMUA data NPWP yang tersimpan? (Alamat dan telepon tidak akan terhapus)")) {
                this.partyDetails.customer.forEach(details => details.npwp = '');
                this.partyDetails.pemasok.forEach(details => details.npwp = '');
                this.saveData();
                await this.renderNpwpTextarea();
                this.showNotification("Semua data NPWP telah dihapus.");
            }
        }
        
        // ... (all other methods remain the same as the previous version)
        
        // Minor modification to loadData and saveData to handle the new structure
        loadData() {
            const defaultData = {
                penjualan: [], pembelian: [], invoices: [], suratJalan: [], masterItems: [{"code": "BRG-2", "name": "ALMUNIUM", "unit": "Kg", "price": 0},
    {"code": "BRG-3", "name": "UNP", "unit": "Kg", "price": 0},
    {"code": "j", "name": "SCRAP", "unit": "Kg", "price": 0},
    {"code": "BRG-5", "name": "SIKU + UNP", "unit": "Kg", "price": 0},
    {"code": "BRG-6", "name": "ASH", "unit": "Kg", "price": 0},
    {"code": "BRG-7", "name": "RANGKA BETON BEKAS", "unit": "Kg", "price": 0},
    {"code": "BRG-8", "name": "PARALON", "unit": "Kg", "price": 0},
    {"code": "BRG-9", "name": "PULI", "unit": "Kg", "price": 0},
    {"code": "BRG-10", "name": "TB", "unit": "Kg", "price": 0},
    {"code": "BRG-11", "name": "CSR", "unit": "Kg", "price": 0},
    {"code": "BRG-12", "name": "RONGSOK KABIN", "unit": "Kg", "price": 0},
    {"code": "BRG-13", "name": "ACP", "unit": "Kg", "price": 0},
    {"code": "BRG-14", "name": "TEMBAGA", "unit": "Kg", "price": 0},
    {"code": "BRG-15", "name": "PIPA", "unit": "Kg", "price": 0},
    {"code": "BRG-16", "name": "WF", "unit": "Kg", "price": 0},
    {"code": "BRG-17", "name": "BON DIMINTA", "unit": "", "price": 0},
    {"code": "BRG-18", "name": "HBEAM + PIPA", "unit": "Kg", "price": 0},
    {"code": "BRG-19", "name": "KIRIM", "unit": "", "price": 0},
    {"code": "BRG-20", "name": "PLONGAN", "unit": "Kg", "price": 0},
    {"code": "BRG-21", "name": "PCB", "unit": "Kg", "price": 0},
    {"code": "BRG-22", "name": "TS", "unit": "Kg", "price": 0},
    {"code": "BRG-23", "name": "JEMBATAN WF", "unit": "Rad", "price": 0},
    {"code": "BRG-24", "name": "STAINLESS INDIA", "unit": "Kg", "price": 0},
    {"code": "BRG-25", "name": "STAINLESS", "unit": "Kg", "price": 0},
    {"code": "BRG-26", "name": "SLINDER", "unit": "Kg", "price": 0},
    {"code": "BRG-27", "name": "DINAMO", "unit": "Kg", "price": 0},
    {"code": "BRG-28", "name": "KANAL U", "unit": "Kg", "price": 0},
    {"code": "BRG-29", "name": "SPEARPART ALMUNIUM", "unit": "Kg", "price": 0},
    {"code": "BRG-30", "name": "SPEARPART PLASTIK", "unit": "Kg", "price": 0},
    {"code": "BRG-31", "name": "SPEARPART BESI", "unit": "Kg", "price": 0},
    {"code": "BRG-32", "name": "CK AYAM + STEK", "unit": "Kg", "price": 0},
    {"code": "BRG-33", "name": "BESI UNP", "unit": "Kg", "price": 0},
    {"code": "BRG-34", "name": "VIBRATOR", "unit": "Kg", "price": 0},
    {"code": "BRG-36", "name": "CK AYAM", "unit": "Kg", "price": 0},
    {"code": "BRG-37", "name": "SIKU", "unit": "Kg", "price": 0},
    {"code": "BRG-38", "name": "ACCU", "unit": "Kg", "price": 0},
    {"code": "BRG-39", "name": "MINGGUAN", "unit": "Pcs", "price": 0},
    {"code": "BRG-40", "name": "SPEARPART", "unit": "Rad", "price": 0},
    {"code": "BRG-41", "name": "CNP", "unit": "Kg", "price": 0},
    {"code": "BRG-42", "name": "CINCIN BETON", "unit": "Kg", "price": 0},
    {"code": "BRG-43", "name": "HOLLO", "unit": "Kg", "price": 0},
    {"code": "BRG-44", "name": "TABUNG PEREON", "unit": "Kg", "price": 0},
    {"code": "BRG-45", "name": "BESI CAMPUR", "unit": "Kg", "price": 0},
    {"code": "BRG-46", "name": "RANGKA BETON BARU", "unit": "Kg", "price": 0},
    {"code": "BRG-47", "name": "KENI", "unit": "Kg", "price": 0},
    {"code": "BRG-48", "name": "SENG GALVALUME", "unit": "M", "price": 0},
    {"code": "BRG-49", "name": "BAJA RINGAN", "unit": "Pcs", "price": 0},
    {"code": "BRG-50", "name": "HBEAM", "unit": "Kg", "price": 0},
    {"code": "BRG-51", "name": "DP H BEAM", "unit": "Kg", "price": 0},
    {"code": "BRG-52", "name": "KALENG", "unit": "Kg", "price": 0},
    {"code": "BRG-53", "name": "BAJA RINGAN BEKAS", "unit": "Kg", "price": 0},
    {"code": "BRG-54", "name": "TIANG VOLLY", "unit": "Kg", "price": 0},
    {"code": "BRG-55", "name": "OKSIGEN", "unit": "Tabung", "price": 0},
    {"code": "BRG-56", "name": "BESI BETON", "unit": "Kg", "price": 0},
    {"code": "BRG-57", "name": "GRAM BESI", "unit": "Kg", "price": 0},
    {"code": "BRG-58", "name": "FEE", "unit": "Kg", "price": 0},
    {"code": "BRG-59", "name": "PLATE", "unit": "Kg", "price": 0},
    {"code": "BRG-60", "name": "PALET PLASTIK", "unit": "Pcs", "price": 0},
    {"code": "BRG-61", "name": "WIREMESH  BEKAS", "unit": "Kg", "price": 0},
    {"code": "BRG-62", "name": "KALENG", "unit": "Kg", "price": 0},
    {"code": "BRG-63", "name": "Cakar Ayam Bekas", "unit": "Kg", "price": 0},
    {"code": "BRG-64", "name": "CICALENGKA - RANCAEKEK DC", "unit": "TF", "price": 0},
    {"code": "BRG-65", "name": "RANCAEKEK - RANCAEKEK DC", "unit": "TF", "price": 0},
    {"code": "BRG-66", "name": "KOORDINASI", "unit": "Rad", "price": 0},
    {"code": "BRG-67", "name": "WIREMESH", "unit": "Lembar", "price": 0},
    {"code": "BRG-68", "name": "ALMUNIUM KALENG", "unit": "Kg", "price": 0},
    {"code": "BRG-69", "name": "KOMPA", "unit": "Kg", "price": 0},
    {"code": "BRG-70", "name": "PRINTER", "unit": "Pcs", "price": 0},
    {"code": "BRG-71", "name": "RONGSOK MOTOR", "unit": "Kg", "price": 0},
    {"code": "BRG-72", "name": "TREGSTANG", "unit": "Kg", "price": 0},
    {"code": "BRG-73", "name": "SIEBEL", "unit": "Kg", "price": 0},
    {"code": "BRG-74", "name": "KUNINGAN", "unit": "Kg", "price": 0},
    {"code": "BRG-75", "name": "BOLA LAHER", "unit": "Kg", "price": 0},
    {"code": "BRG-76", "name": "LOGAM", "unit": "Kg", "price": 0},
    {"code": "BRG-77", "name": "SENG", "unit": "Kg", "price": 0},
    {"code": "BRG-78", "name": "KERAN STAINLESS", "unit": "Kg", "price": 0},
    {"code": "BRG-79", "name": "HIDROLIK", "unit": "Kg", "price": 0},
    {"code": "BRG-80", "name": "TS 2", "unit": "Kg", "price": 0},
    {"code": "BRG-81", "name": "BC", "unit": "Kg", "price": 0},
    {"code": "BRG-82", "name": "TB", "unit": "Kg", "price": 0},
    {"code": "BRG-83", "name": "KN", "unit": "Kg", "price": 0},
    {"code": "BRG-84", "name": "RADIATOR KUNINGAN", "unit": "Kg", "price": 0},
    {"code": "BRG-85", "name": "ALM KAWAT", "unit": "Kg", "price": 0},
    {"code": "BRG-86", "name": "SKA", "unit": "Kg", "price": 0},
    {"code": "BRG-87", "name": "BM", "unit": "Kg", "price": 0},
    {"code": "BRG-88", "name": "ALM PLAT", "unit": "Kg", "price": 0},
    {"code": "BRG-89", "name": "ALM ARO", "unit": "Kg", "price": 0},
    {"code": "BRG-90", "name": "ALM KREY", "unit": "Kg", "price": 0},
    {"code": "BRG-91", "name": "PLASTIK PVC", "unit": "Kg", "price": 0},
    {"code": "BRG-92", "name": "BETON 10 MM URIL", "unit": "Btg", "price": 0},
    {"code": "BRG-93", "name": "BETON 16 MM URIL", "unit": "Btg", "price": 0},
    {"code": "BRG-94", "name": "KAWAT TALI BETON", "unit": "Kg", "price": 0},
    {"code": "BRG-95", "name": "MOBIL", "unit": "Unit", "price": 0},
    {"code": "BRG-96", "name": "PLATE POTONG", "unit": "Kg", "price": 0},
    {"code": "BRG-97", "name": "SARINGAN", "unit": "Kg", "price": 0},
    {"code": "BRG-98", "name": "ACP", "unit": "Kg", "price": 0},
    {"code": "BRG-99", "name": "RAK", "unit": "Kg", "price": 0},
    {"code": "BRG-100", "name": "BAUD BEKAS", "unit": "Kg", "price": 0},
    {"code": "BRG-101", "name": "SENG ROLL", "unit": "Kg", "price": 0},
    {"code": "BRG-102", "name": "KAWAT", "unit": "Kg", "price": 0},
    {"code": "BRG-103", "name": "DRUM", "unit": "Pcs", "price": 0},
    {"code": "BRG-104", "name": "LAHER", "unit": "Kg", "price": 0},
    {"code": "BRG-105", "name": "FORKLIFT", "unit": "Kg", "price": 0},
    {"code": "BRG-106", "name": "TOREN", "unit": "Pcs", "price": 0},
    {"code": "BRG-107", "name": "KEREN", "unit": "Kg", "price": 0},
    {"code": "BRG-108", "name": "KABEL", "unit": "Kg", "price": 0},
    {"code": "BRG-109", "name": "DRUM", "unit": "PCS", "price": 0},
    {"code": "BRG-110", "name": "JELIGEN", "unit": "PCS", "price": 0},
    {"code": "BRG-111", "name": "DP RANGKA", "unit": "Rad", "price": 0},
    {"code": "BRG-112", "name": "SELANG HIDROLIK", "unit": "Pcs", "price": 0},
    {"code": "BRG-113", "name": "KABIN", "unit": "Kg", "price": 0},
    {"code": "BRG-114", "name": "GRAM ALM", "unit": "Kg", "price": 0},
    {"code": "BRG-115", "name": "SENG ALM", "unit": "Kg", "price": 0},
    {"code": "BRG-116", "name": "WIREMESH BEKAS", "unit": "Kg", "price": 0},
    {"code": "BRG-117", "name": "TONG", "unit": "Pcs", "price": 0},
    {"code": "BRG-118", "name": "BONDEX 0,7 MM", "unit": "LEMBAR", "price": 0},
    {"code": "BRG-119", "name": "BETON 8 MM FULL", "unit": "BATANG", "price": 0},
    {"code": "BRG-120", "name": "BETON 6 MM FULL", "unit": "BATANG", "price": 0},
    {"code": "BRG-121", "name": "CNP 150 X 2,3 MM X 6 M", "unit": "BATANG", "price": 0},
    {"code": "BRG-122", "name": "CNP 75 X 1,6 MM X 6M", "unit": "BATANG", "price": 0},
    {"code": "BRG-123", "name": "CNP BAJA RINGAN 0,75 MM", "unit": "BATANG", "price": 0},
    {"code": "BRG-124", "name": "RENG BAJA RINGAN 0,4 MM", "unit": "BATANG", "price": 0},
    {"code": "BRG-125", "name": "KUNINGAN TEMBAGA", "unit": "Kg", "price": 0},
    {"code": "BRG-126", "name": "ALM ATAP", "unit": "Kg", "price": 0},
    {"code": "BRG-127", "name": "RADIATOR ALM", "unit": "Kg", "price": 0},
    {"code": "BRG-128", "name": "ACU", "unit": "Kg", "price": 0},
    {"code": "BRG-129", "name": "TIMAH", "unit": "Kg", "price": 0},
    {"code": "BRG-130", "name": "RONGSOK A", "unit": "Kg", "price": 0},
    {"code": "BRG-131", "name": "RONGSOK B", "unit": "Kg", "price": 0},
    {"code": "BRG-132", "name": "KAWAT", "unit": "Kg", "price": 0},
    {"code": "BRG-133", "name": "CINCIN BETON BARU", "unit": "Kg", "price": 0},
    {"code": "BRG-134", "name": "BESI", "unit": "Kg", "price": 0},
    {"code": "BRG-135", "name": "KONTAKTOR", "unit": "Kg", "price": 0},
    {"code": "BRG-136", "name": "DP WF", "unit": "Rad", "price": 0},
    {"code": "BRG-137", "name": "DP Seng", "unit": "Kg", "price": 0},
    {"code": "BRG-139", "name": "SATU SET ALAT POTONG", "unit": "Kg", "price": 0},
    {"code": "BRG-140", "name": "Win Sling", "unit": "Pcs", "price": 0},
    {"code": "BRG-141", "name": "BETON 13 URIL", "unit": "BATANG", "price": 0},
    {"code": "BRG-142", "name": "NCB", "unit": "Kg", "price": 0},
    {"code": "BRG-143", "name": "BAK PEEL", "unit": "Kg", "price": 0},
    {"code": "BRG-144", "name": "ALMUNIUM SIKU", "unit": "Kg", "price": 0},
    {"code": "BRG-145", "name": "PER", "unit": "Kg", "price": 0},
    {"code": "BRG-146", "name": "TONG", "unit": "Pcs", "price": 0},
    {"code": "BRG-147", "name": "SIMER SIBEL", "unit": "Kg", "price": 0},
    {"code": "BRG-148", "name": "TANGGA PUTAR", "unit": "Kg", "price": 0},
    {"code": "BRG-149", "name": "KABINET", "unit": "Kg", "price": 0},
    {"code": "BRG-150", "name": "LUBANG", "unit": "Pcs", "price": 0},
    {"code": "BRG-151", "name": "TIANG LISTRIK 8 M", "unit": "Pcs", "price": 0},
    {"code": "BRG-152", "name": "WF DAN HBEAM", "unit": "Kg", "price": 0},
    {"code": "BRG-153", "name": "BESI BETON REJECT", "unit": "Kg", "price": 0},
    {"code": "BRG-154", "name": "HBEAM 300 PLUS BESPLAT", "unit": "Kg", "price": 0},
    {"code": "BRG-155", "name": "HBEAM", "unit": "Kg", "price": 0},
    {"code": "BRG-156", "name": "SOBLEKER", "unit": "Pcs", "price": 0},
    {"code": "BRG-157", "name": "TABUNG KECIL", "unit": "PCS", "price": 0},
    {"code": "BRG-158", "name": "TABUNG BESAR", "unit": "PCS", "price": 0},
    {"code": "BRG-159", "name": "KAYU GELONDONGAN", "unit": "Rad", "price": 0},
    {"code": "BRG-160", "name": "KAYU DAN GENTENG", "unit": "Rad", "price": 0},
    {"code": "BRG-161", "name": "WF 300", "unit": "Kg", "price": 0},
    {"code": "BRG-162", "name": "WF 250", "unit": "Kg", "price": 0},
    {"code": "BRG-163", "name": "HENPALET DAN SPERPART", "unit": "Kg", "price": 0},
    {"code": "BRG-164", "name": "PIPA BOR", "unit": "Kg", "price": 0},
    {"code": "BRG-165", "name": "ROLINGDOR", "unit": "Kg", "price": 0},
    {"code": "BRG-166", "name": "KAWAT BETON", "unit": "Kg", "price": 0},
    {"code": "BRG-167", "name": "PAKU", "unit": "Kg", "price": 0},
    {"code": "BRG-168", "name": "LAHER", "unit": "Kg", "price": 0},
    {"code": "BRG-169", "name": "BAN BEKAS", "unit": "PCS", "price": 0},
    {"code": "BRG-170", "name": "ALM SENG", "unit": "Kg", "price": 0},
    {"code": "BRG-171", "name": "PLAT POTONG", "unit": "Kg", "price": 0},
    {"code": "BRG-172", "name": "TIHANG PIPA", "unit": "Kg", "price": 0},
    {"code": "BRG-173", "name": "CONTAKTOR", "unit": "Kg", "price": 0},
    {"code": "BRG-174", "name": "FEE SENG", "unit": "M", "price": 0},
    {"code": "BRG-175", "name": "PARALON 12''", "unit": "BATANG", "price": 0},
    {"code": "BRG-176", "name": "GRAM KUNINGAN", "unit": "Kg", "price": 0},
    {"code": "BRG-177", "name": "CILER", "unit": "Pcs", "price": 0},
    {"code": "BRG-178", "name": "IBEAM", "unit": "Kg", "price": 0},
    {"code": "BRG-179", "name": "PLAT WAJIT", "unit": "LEMBAR", "price": 0},
    {"code": "BRG-180", "name": "ONGKOS LUBANG", "unit": "LUBANG", "price": 0},
    {"code": "BRG-181", "name": "TANGGA", "unit": "Kg", "price": 0},
    {"code": "BRG-182", "name": "KERAN", "unit": "Kg", "price": 0},
    {"code": "BRG-183", "name": "GRAM ALM", "unit": "Kg", "price": 0},
    {"code": "BRG-184", "name": "KABEL", "unit": "Kg", "price": 0},
    {"code": "BRG-185", "name": "KONTAKTOR", "unit": "Kg", "price": 0},
    {"code": "BRG-186", "name": "MESIN PRESS", "unit": "Kg", "price": 0},
    {"code": "BRG-187", "name": "DRUM RONGSOK", "unit": "Kg", "price": 0},
    {"code": "BRG-188", "name": "KAWAT", "unit": "Kg", "price": 0},
    {"code": "BRG-189", "name": "PAKU", "unit": "Kg", "price": 0},
    {"code": "BRG-190", "name": "CIN CIN BEKAS", "unit": "Kg", "price": 0},
    {"code": "BRG-191", "name": "GRAM TEMBAGA", "unit": "Kg", "price": 0},
    {"code": "BRG-192", "name": "KURSI CHITOSE", "unit": "Kg", "price": 0},
    {"code": "BRG-193", "name": "DRUM", "unit": "PCS", "price": 0},
    {"code": "BRG-194", "name": "BETON", "unit": "Kg", "price": 0},
    {"code": "BRG-195", "name": "GEAR BOX DLL", "unit": "Kg", "price": 0},
    {"code": "BRG-196", "name": "RANGKA BETON", "unit": "Kg", "price": 0},
    {"code": "BRG-197", "name": "SEPERPART PLASTIK", "unit": "Kg", "price": 0},
    {"code": "BRG-198", "name": "MESIN ROTI", "unit": "Kg", "price": 0},
    {"code": "BRG-199", "name": "PLASTIK", "unit": "Kg", "price": 0},
    {"code": "BRG-200", "name": "TOREN STENLIS", "unit": "Kg", "price": 0},
    {"code": "BRG-201", "name": "RAK", "unit": "Kg", "price": 0},
    {"code": "BRG-202", "name": "PIPA", "unit": "Kg", "price": 0},
    {"code": "BRG-203", "name": "PARALON 8\"", "unit": "BATANG", "price": 0},
    {"code": "BRG-204", "name": "BAUD", "unit": "Kg", "price": 0},
    {"code": "BRG-205", "name": "SENG", "unit": "LEMBAR", "price": 0},
    {"code": "BRG-206", "name": "WARMES M.8", "unit": "LEMBAR", "price": 0},
    {"code": "BRG-207", "name": "MESIN DISEL", "unit": "PCS", "price": 0},
    {"code": "BRG-208", "name": "BONDEX 0,75 MM", "unit": "LEMBAR", "price": 0},
    {"code": "BRG-209", "name": "DINAMO", "unit": "Kg", "price": 0},
    {"code": "BRG-210", "name": "SEPANDEX", "unit": "M", "price": 0},
    {"code": "BRG-211", "name": "BLEKER", "unit": "Kg", "price": 0},
    {"code": "BRG-212", "name": "GEAR BOX DINAMO", "unit": "Kg", "price": 0},
    {"code": "BRG-213", "name": "RONGSOK MESIN", "unit": "Kg", "price": 0},
    {"code": "BRG-214", "name": "MESIN BEJING", "unit": "RAD", "price": 0},
    {"code": "BRG-215", "name": "BLOWER", "unit": "Kg", "price": 0},
    {"code": "BRG-216", "name": "GEAR BOX", "unit": "Kg", "price": 0},
    {"code": "BRG-217", "name": "GEAR BOX ALM DINAMO ALM", "unit": "Kg", "price": 0},
    {"code": "BRG-218", "name": "NCB", "unit": "Kg", "price": 0},
    {"code": "BRG-219", "name": "PINTU BESI", "unit": "Kg", "price": 0},
    {"code": "BRG-220", "name": "PANEL", "unit": "Kg", "price": 0},
    {"code": "BRG-221", "name": "KAP LAMPU", "unit": "Kg", "price": 0},
    {"code": "BRG-222", "name": "ALAT TEKNIK", "unit": "Kg", "price": 0},
    {"code": "BRG-223", "name": "INP & H-BEEM", "unit": "Kg", "price": 0},
    {"code": "BRG-224", "name": "HOIS 0,5 TON", "unit": "UNIT", "price": 0},
    {"code": "BRG-225", "name": "HOIS 1 TON", "unit": "UNIT", "price": 0},
    {"code": "BRG-226", "name": "TROSFAL", "unit": "Kg", "price": 0},
    {"code": "BRG-227", "name": "EMBER", "unit": "Pcs", "price": 0},
    {"code": "BRG-228", "name": "PREON", "unit": "Kg", "price": 0},
    {"code": "BRG-229", "name": "ONERDIL", "unit": "Kg", "price": 0},
    {"code": "BRG-230", "name": "HBEAM DAN PIPA", "unit": "Kg", "price": 0},
    {"code": "BRG-231", "name": "UNP & BAJA RINGAN", "unit": "Kg", "price": 0},
    {"code": "BRG-232", "name": "BESI COR", "unit": "Kg", "price": 0},
    {"code": "BRG-233", "name": "TIHANG 8 M", "unit": "BATANG", "price": 0},
    {"code": "BRG-234", "name": "PARALON", "unit": "Kg", "price": 0},
    {"code": "BRG-235", "name": "WF 500", "unit": "Kg", "price": 0},
    {"code": "BRG-236", "name": "BEARING", "unit": "Kg", "price": 0},
    {"code": "BRG-237", "name": "BETON", "unit": "Kg", "price": 0},
    {"code": "BRG-238", "name": "WF 200", "unit": "Kg", "price": 0},
    {"code": "BRG-239", "name": "LADIATOR KUNINGAN", "unit": "Kg", "price": 0},
    {"code": "BRG-240", "name": "GARDAN", "unit": "Kg", "price": 0},
    {"code": "BRG-241", "name": "BAUD", "unit": "Kg", "price": 0},
    {"code": "BRG-242", "name": "KARET", "unit": "Kg", "price": 0},
    {"code": "BRG-243", "name": "KABEL", "unit": "Kg", "price": 0},
    {"code": "BRG-244", "name": "PARALON", "unit": "Kg", "price": 0},
    {"code": "BRG-245", "name": "PAGER", "unit": "Kg", "price": 0},
    {"code": "BRG-246", "name": "MESIN DOMPLENG LENGKAP", "unit": "Kg", "price": 0},
    {"code": "BRG-247", "name": "MESIN DOMPLENG", "unit": "Kg", "price": 0},
    {"code": "BRG-248", "name": "TABUNG", "unit": "Kg", "price": 0},
    {"code": "BRG-249", "name": "BAJA RINGAN", "unit": "Kg", "price": 0},
    {"code": "BRG-250", "name": "SAKLAR", "unit": "Kg", "price": 0},
    {"code": "BRG-251", "name": "SEPERPART SETENLIS", "unit": "Kg", "price": 0},
    {"code": "BRG-252", "name": "WF 200", "unit": "Kg", "price": 0},
    {"code": "BRG-253", "name": "SEPANDEX BEKAS", "unit": "Kg", "price": 0},
    {"code": "BRG-254", "name": "CINCIN TROSFAL", "unit": "Kg", "price": 0},
    {"code": "BRG-255", "name": "KOMPRESOR", "unit": "Kg", "price": 0},
    {"code": "BRG-256", "name": "SELING", "unit": "Kg", "price": 0},
    {"code": "BRG-257", "name": "KOMPA", "unit": "Kg", "price": 0},
    {"code": "BRG-258", "name": "TUTUP DYNAMO", "unit": "Kg", "price": 0},
    {"code": "BRG-259", "name": "DRUM", "unit": "Kg", "price": 0},
    {"code": "BRG-260", "name": "BESI SIKU", "unit": "Kg", "price": 0},
    {"code": "BRG-261", "name": "CNP 20", "unit": "Kg", "price": 0},
    {"code": "BRG-262", "name": "KERAN", "unit": "Kg", "price": 0},
    {"code": "BRG-263", "name": "TAKEL", "unit": "Pcs", "price": 0},
    {"code": "BRG-264", "name": "TRAFO", "unit": "Kg", "price": 0},
    {"code": "BRG-265", "name": "NEVEL", "unit": "Kg", "price": 0},
    {"code": "BRG-266", "name": "BAUD", "unit": "Kg", "price": 0},
    {"code": "BRG-267", "name": "WF", "unit": "Kg", "price": 0},
    {"code": "BRG-268", "name": "BOX PLASTIK", "unit": "Pcs", "price": 0},
    {"code": "BRG-269", "name": "ASH", "unit": "Kg", "price": 0},
    {"code": "BRG-270", "name": "CNP 10", "unit": "Kg", "price": 0},
    {"code": "BRG-271", "name": "CUBIN", "unit": "Kg", "price": 0},
    {"code": "BRG-272", "name": "RONGSOK ROLL", "unit": "Kg", "price": 0},
    {"code": "BRG-273", "name": "PALET", "unit": "Kg", "price": 0},
    {"code": "BRG-274", "name": "COMPUTER", "unit": "PCS", "price": 0},
    {"code": "BRG-275", "name": "MONITOR", "unit": "PCS", "price": 0},
    {"code": "BRG-276", "name": "PLATE ALUMUNIUM", "unit": "Kg", "price": 0},
    {"code": "BRG-277", "name": "MESIN", "unit": "Kg", "price": 0},
    {"code": "BRG-278", "name": "AC", "unit": "Kg", "price": 0},
    {"code": "BRG-279", "name": "SPARE PART STAINLESS", "unit": "Kg", "price": 0},
    {"code": "BRG-280", "name": "HANDKLIP", "unit": "Pcs", "price": 0},
    {"code": "BRG-281", "name": "TROLLY", "unit": "Pcs", "price": 0},
    {"code": "BRG-282", "name": "GEAR BOX", "unit": "Kg", "price": 0},
    {"code": "BRG-283", "name": "MESIN GERGAJI", "unit": "Kg", "price": 0},
    {"code": "BRG-284", "name": "WF-200", "unit": "BTG", "price": 0},
    {"code": "BRG-285", "name": "CNP 100", "unit": "BTG", "price": 0},
    {"code": "BRG-286", "name": "BETON 12 MM", "unit": "BTG", "price": 0},
    {"code": "BRG-287", "name": "PAGAR BRC", "unit": "Kg", "price": 0},
    {"code": "BRG-288", "name": "RODA", "unit": "Kg", "price": 0},
    {"code": "BRG-289", "name": "ALAT LISTRIK", "unit": "Kg", "price": 0},
    {"code": "BRG-290", "name": "MESIN STENLIS", "unit": "UNIT", "price": 0},
    {"code": "BRG-291", "name": "TALANG AIR", "unit": "Kg", "price": 0},
    {"code": "BRG-292", "name": "ANGKUR", "unit": "PCS", "price": 0},
    {"code": "BRG-293", "name": "BAUD", "unit": "PCS", "price": 0},
    {"code": "BRG-294", "name": "RING", "unit": "PCS", "price": 0},
    {"code": "BRG-295", "name": "SPAN SCROEP", "unit": "PCS", "price": 0},
    {"code": "BRG-296", "name": "TOREN KEMPU", "unit": "PCS", "price": 0},
    {"code": "BRG-297", "name": "KAWAT DURI", "unit": "Kg", "price": 0},
    {"code": "BRG-298", "name": "UNP", "unit": "Kg", "price": 0},
    {"code": "BRG-299", "name": "TIANG 9 M", "unit": "BTG", "price": 0},
    {"code": "BRG-300", "name": "CNP", "unit": "Kg", "price": 0},
    {"code": "BRG-301", "name": "KONTRAKTOR", "unit": "Kg", "price": 0},
    {"code": "BRG-302", "name": "BESI", "unit": "Kg", "price": 0},
    {"code": "BRG-303", "name": "LADIATOR", "unit": "Kg", "price": 0},
    {"code": "BRG-304", "name": "RITASE CICALENGKA", "unit": "TF", "price": 0},
    {"code": "BRG-305", "name": "RITASE RANCAEKEK", "unit": "TF", "price": 0},
    {"code": "BRG-306", "name": "CNP 100", "unit": "BTG", "price": 0},
    {"code": "BRG-307", "name": "MESIN", "unit": "UNIT", "price": 0},
    {"code": "BRG-308", "name": "KOMPLAYER", "unit": "UNIT", "price": 0},
    {"code": "BRG-309", "name": "TIHANG LISTRIK 9 M", "unit": "BTG", "price": 0},
    {"code": "BRG-310", "name": "KABIN", "unit": "UNIT", "price": 0},
    {"code": "BRG-311", "name": "GRAM", "unit": "Kg", "price": 0},
    {"code": "BRG-312", "name": "TIANG PLANG", "unit": "Pcs", "price": 0},
    {"code": "BRG-313", "name": "HIDROLIK KECIL", "unit": "PCS", "price": 0},
    {"code": "BRG-314", "name": "PAKU BESI", "unit": "Kg", "price": 0},
    {"code": "BRG-315", "name": "PAKU BETON", "unit": "Kg", "price": 0},
    {"code": "BRG-316", "name": "TIHANG TLP 7 M", "unit": "BTG", "price": 0},
    {"code": "BRG-317", "name": "PAGAR", "unit": "RAD", "price": 0},
    {"code": "BRG-318", "name": "ARSIP", "unit": "Kg", "price": 0},
    {"code": "BRG-319", "name": "PAKU ROOFING", "unit": "Kg", "price": 0},
    {"code": "BRG-320", "name": "BAJA RINGAN 0,75", "unit": "BTG", "price": 0},
    {"code": "BRG-321", "name": "BAJA RINGAN 0,70", "unit": "BTG", "price": 0},
    {"code": "BRG-322", "name": "SPANDECK", "unit": "M", "price": 0},
    {"code": "BRG-323", "name": "BESI BOLA", "unit": "Kg", "price": 0},
    {"code": "BRG-324", "name": "KANAL C", "unit": "Kg", "price": 0},
    {"code": "BRG-325", "name": "DINAMO STATER", "unit": "PCS", "price": 0},
    {"code": "BRG-326", "name": "LETTER C BAJA RINGAN", "unit": "Kg", "price": 0},
    {"code": "BRG-327", "name": "SIKAT", "unit": "Kg", "price": 0},
    {"code": "BRG-328", "name": "DAUN PINTU BESI", "unit": "Kg", "price": 0},
    {"code": "BRG-329", "name": "PARALON 2\"", "unit": "BTG", "price": 0},
    {"code": "BRG-330", "name": "SELANG VVC", "unit": "ROLL", "price": 0},
    {"code": "BRG-331", "name": "HIDROLIK", "unit": "Kg", "price": 0},
    {"code": "BRG-332", "name": "TENGKI 16 LITER", "unit": "UNIT", "price": 0},
    {"code": "BRG-333", "name": "KARDUS", "unit": "Kg", "price": 0},
    {"code": "BRG-334", "name": "SOLAR", "unit": "RAD", "price": 0},
    {"code": "BRG-335", "name": "ANGKUTAN ELOD / SLUDGE", "unit": "RIT", "price": 0},
    {"code": "BRG-336", "name": "BUBUK BESI / SKIL", "unit": "Kg", "price": 0},
    {"code": "BRG-337", "name": "ONGKOS KERJA", "unit": "RAD", "price": 0},
    {"code": "BRG-338", "name": "BAJA RINGAN", "unit": "Kg", "price": 0},
    {"code": "BRG-339", "name": "TIHANG LISTRIK 11 M", "unit": "BTG", "price": 0},
    {"code": "BRG-340", "name": "ROLLINGDOR", "unit": "PCS", "price": 0},
    {"code": "BRG-341", "name": "PLATE PLENES", "unit": "Kg", "price": 0},
    {"code": "BRG-342", "name": "BETON 19 mm", "unit": "PCS", "price": 0},
    {"code": "BRG-343", "name": "BETON 10 MM", "unit": "BTG", "price": 0},
    {"code": "BRG-344", "name": "KOMPRESOR", "unit": "Kg", "price": 0},
    {"code": "BRG-345", "name": "RONGSOK", "unit": "Kg", "price": 0},
    {"code": "BRG-346", "name": "KAWAT", "unit": "Kg", "price": 0},
    {"code": "BRG-347", "name": "BAUT", "unit": "Kg", "price": 0},
    {"code": "BRG-348", "name": "BESI BETON 10 MM FULL", "unit": "BTG", "price": 0},
    {"code": "BRG-349", "name": "DUS", "unit": "Kg", "price": 0},
    {"code": "BRG-350", "name": "BETON BAKAR", "unit": "Kg", "price": 0},
    {"code": "BRG-351", "name": "LOGAM CAMPUR", "unit": "Kg", "price": 0},
    {"code": "BRG-352", "name": "ALM ACP", "unit": "RAD", "price": 0},
    {"code": "BRG-353", "name": "PINTU POLINGGET", "unit": "Kg", "price": 0},
    {"code": "BRG-354", "name": "BOLA LAHER", "unit": "Kg", "price": 0},
    {"code": "BRG-355", "name": "RENG BAJA RINGAN", "unit": "Kg", "price": 0},
    {"code": "BRG-356", "name": "ATAP 0,35", "unit": "LBR", "price": 0},
    {"code": "BRG-357", "name": "ATAP PIBER", "unit": "LBR", "price": 0},
    {"code": "BRG-358", "name": "RUFING 5 CM", "unit": "Pcs", "price": 0},
    {"code": "BRG-359", "name": "RUFING 3 CM", "unit": "Pcs", "price": 0},
    {"code": "BRG-360", "name": "SENG TALANG", "unit": "M", "price": 0},
    {"code": "BRG-361", "name": "KALENG PRES", "unit": "Kg", "price": 0},
    {"code": "BRG-362", "name": "LPG BEKAS", "unit": "Kg", "price": 0},
    {"code": "BRG-363", "name": "KARUNG GUNNY", "unit": "PCS", "price": 0},
    {"code": "BRG-364", "name": "BAJA RINGAN BEKAS", "unit": "Kg", "price": 0},
    {"code": "BRG-365", "name": "KANDANG MAGOT", "unit": "UNIT", "price": 0},
    {"code": "BRG-366", "name": "DINDING KANDANG MAGOT", "unit": "UNIT", "price": 0},
    {"code": "BRG-367", "name": "FIBER", "unit": "LEMBAR", "price": 0},
    {"code": "BRG-368", "name": "TALANG PARALON", "unit": "BTG", "price": 0},
    {"code": "BRG-369", "name": "WASTAPEL KENCING", "unit": "PCS", "price": 0},
    {"code": "BRG-370", "name": "OPEN COKLAT", "unit": "Kg", "price": 0},
    {"code": "BRG-371", "name": "ALDELON", "unit": "LBR", "price": 0},
    {"code": "BRG-372", "name": "SEKIL", "unit": "Kg", "price": 0},
    {"code": "BRG-373", "name": "DP SEWA BANGUNAN", "unit": "RAD", "price": 0},
    {"code": "BRG-374", "name": "CAKAR  AYAM", "unit": "Kg", "price": 0},
    {"code": "BRG-375", "name": "BESI BAHAN", "unit": "Kg", "price": 0},
    {"code": "BRG-376", "name": "HOICE", "unit": "Pcs", "price": 0},
    {"code": "BRG-377", "name": "TENGKI", "unit": "Kg", "price": 0},
    {"code": "BRG-378", "name": "RAK BESI", "unit": "Kg", "price": 0},
    {"code": "BRG-379", "name": "PULI", "unit": "Kg", "price": 0},
    {"code": "BRG-380", "name": "PELASTIK", "unit": "Kg", "price": 0},
    {"code": "BRG-381", "name": "WARMES BEKAS", "unit": "Kg", "price": 0},
    {"code": "BRG-382", "name": "TIMBANGAN", "unit": "PCS", "price": 0},
    {"code": "BRG-383", "name": "GERGAJI", "unit": "Kg", "price": 0},
    {"code": "BRG-384", "name": "RDT", "unit": "Kg", "price": 0},
    {"code": "BRG-385", "name": "TENGKI", "unit": "Kg", "price": 0},
    {"code": "BRG-386", "name": "SENG BEKAS", "unit": "Kg", "price": 0},
    {"code": "BRG-387", "name": "DRIL", "unit": "Kg", "price": 0},
    {"code": "BRG-388", "name": "LEMARI KABINET", "unit": "UNIT", "price": 0},
    {"code": "BRG-389", "name": "TANGGA", "unit": "Kg", "price": 0},
    {"code": "BRG-390", "name": "PLATE STRIP", "unit": "Kg", "price": 0},
    {"code": "BRG-391", "name": "SOKET", "unit": "Kg", "price": 0},
    {"code": "BRG-392", "name": "SIWAR", "unit": "Kg", "price": 0},
    {"code": "BRG-393", "name": "Dinabolt", "unit": "Kg", "price": 0},
    {"code": "BRG-394", "name": "OLI BAGUS", "unit": "DRUM", "price": 0},
    {"code": "BRG-395", "name": "ROLLING DOR", "unit": "UNIT", "price": 0},
    {"code": "BRG-396", "name": "SENG PENDEK", "unit": "Kg", "price": 0},
    {"code": "BRG-397", "name": "CNP BAJA RINGAN", "unit": "Kg", "price": 0},
    {"code": "BRG-398", "name": "SCRAP PLAT STRIP", "unit": "Kg", "price": 0},
    {"code": "BRG-399", "name": "SCRAP REL", "unit": "Kg", "price": 0},
    {"code": "BRG-400", "name": "SENG", "unit": "Kg", "price": 0},
    {"code": "BRG-401", "name": "MAJALENGKA", "unit": "TF", "price": 0},
    {"code": "BRG-402", "name": "RITASE MAJALENGKA", "unit": "TF", "price": 0},
    {"code": "BRG-403", "name": "TANGKI", "unit": "UNIT", "price": 0},
    {"code": "BRG-404", "name": "PILOW", "unit": "Kg", "price": 0},
    {"code": "BRG-405", "name": "BETON 6 MM", "unit": "BTG", "price": 0},
    {"code": "BRG-406", "name": "BETON 8 MM", "unit": "BTG", "price": 0},
    {"code": "BRG-407", "name": "BETON 10 MM", "unit": "BTG", "price": 0},
    {"code": "BRG-408", "name": "TIANG 7 M", "unit": "PCS", "price": 0},
    {"code": "BRG-409", "name": "LAS SASIS", "unit": "RAD", "price": 0},
    {"code": "BRG-410", "name": "JEMBATAN DRILL", "unit": "Kg", "price": 0},
    {"code": "BRG-411", "name": "WF & HOLLOW", "unit": "Kg", "price": 0},
    {"code": "BRG-412", "name": "RELL", "unit": "Kg", "price": 0},
    {"code": "BRG-413", "name": "MESEN PERAHU", "unit": "UNIT", "price": 0},
    {"code": "BRG-414", "name": "HOLLO 5 x 10", "unit": "BTG", "price": 0},
    {"code": "BRG-415", "name": "HOLLO 4 x 6", "unit": "BTG", "price": 0},
    {"code": "BRG-416", "name": "HOLLO 4 x 4", "unit": "BTG", "price": 0},
    {"code": "BRG-417", "name": "HANDCLIFT 2000 KG", "unit": "UNIT", "price": 0},
    {"code": "BRG-418", "name": "HANDCLIFT 3000 KG", "unit": "UNIT", "price": 0},
    {"code": "BRG-419", "name": "DINAMO ALM", "unit": "Kg", "price": 0},
    {"code": "BRG-420", "name": "GIGI", "unit": "Kg", "price": 0},
    {"code": "BRG-421", "name": "RANTAI", "unit": "Kg", "price": 0},
    {"code": "BRG-422", "name": "GRANIT", "unit": "M", "price": 0},
    {"code": "BRG-423", "name": "ASH STENLIS", "unit": "Kg", "price": 0},
    {"code": "BRG-424", "name": "HENKLIF 2 TON", "unit": "PCS", "price": 0},
    {"code": "BRG-425", "name": "TENGKI", "unit": "UNIT", "price": 0},
    {"code": "BRG-426", "name": "JERIGEN", "unit": "Pcs", "price": 0},
    {"code": "BRG-427", "name": "PAGAR BEKAS", "unit": "Kg", "price": 0},
    {"code": "BRG-428", "name": "HOLLO BEKAS", "unit": "Kg", "price": 0},
    {"code": "BRG-429", "name": "RANGKA BETON BARU", "unit": "Kg", "price": 0},
    {"code": "BRG-430", "name": "BAJARINGAN", "unit": "Kg", "price": 0},
    {"code": "BRG-431", "name": "RONGSOK", "unit": "Kg", "price": 0},
    {"code": "BRG-432", "name": "BETON 10", "unit": "Btg", "price": 0},
    {"code": "BRG-433", "name": "BETON 8", "unit": "Kg", "price": 0},
    {"code": "BRG-434", "name": "KERAMIK", "unit": "M", "price": 0},
    {"code": "BRG-435", "name": "MAJALENGKA", "unit": "TF", "price": 0},
    {"code": "BRG-436", "name": "MESIN PERAHU", "unit": "UNIT", "price": 0},
    {"code": "BRG-437", "name": "BETON 6 MM", "unit": "BTG", "price": 0},
    {"code": "BRG-438", "name": "STAINLESS", "unit": "Kg", "price": 0},
    {"code": "BRG-439", "name": "BAJARINGAN", "unit": "Kg", "price": 0},
    {"code": "BRG-440", "name": "KRAN STAINLESS", "unit": "Kg", "price": 0},
    {"code": "BRG-441", "name": "GEARBOX", "unit": "Kg", "price": 0},
    {"code": "BRG-442", "name": "KRAN BESI", "unit": "Kg", "price": 0},
    {"code": "BRG-443", "name": "SENG WUWUNG", "unit": "M", "price": 0},
    {"code": "BRG-444", "name": "JENDELA ALMUNIUM", "unit": "PCS", "price": 0},
    {"code": "BRG-445", "name": "BONDEX 0,70 MM", "unit": "LEMBAR", "price": 0},
    {"code": "BRG-446", "name": "SPEARPART", "unit": "Kg", "price": 0},
    {"code": "BRG-447", "name": "T.B.C", "unit": "Kg", "price": 0},
    {"code": "BRG-448", "name": "RAM SIKU", "unit": "Kg", "price": 0},
    {"code": "BRG-449", "name": "TANGGA DAN RAK", "unit": "RAD", "price": 0},
    {"code": "BRG-450", "name": "SENG GALVALUM DAN RENG", "unit": "M", "price": 0},
    {"code": "BRG-451", "name": "PIPA 2,5\"", "unit": "BTG", "price": 0},
    {"code": "BRG-452", "name": "SEPERPART BEKU", "unit": "Kg", "price": 0},
    {"code": "BRG-453", "name": "OLI BEKAS", "unit": "DRUM", "price": 0},
    {"code": "BRG-454", "name": "TOREN AIR 500 L", "unit": "PCS", "price": 0},
    {"code": "BRG-455", "name": "TONG CIMOL 200 L", "unit": "PCS", "price": 0},
    {"code": "BRG-456", "name": "ANGKUR BEKAS", "unit": "Kg", "price": 0},
    {"code": "BRG-457", "name": "MESIN", "unit": "Kg", "price": 0},
    {"code": "BRG-458", "name": "DINAMO + STAINLIS + ALM", "unit": "Kg", "price": 0},
    {"code": "BRG-459", "name": "TIHANG TAKEL", "unit": "Kg", "price": 0},
    {"code": "BRG-460", "name": "AYAKAN BATU ( 2 UNIT )", "unit": "RAD", "price": 0},
    {"code": "BRG-461", "name": "TIANG LISTRIK 9 M", "unit": "PCS", "price": 0},
    {"code": "BRG-462", "name": "SIBEL", "unit": "Kg", "price": 0},
    {"code": "BRG-463", "name": "PARALON TALANG", "unit": "BTG", "price": 0},
    {"code": "BRG-464", "name": "BONDEX", "unit": "LBR", "price": 0},
    {"code": "BRG-465", "name": "WARMES M.10", "unit": "LBR", "price": 0},
    {"code": "BRG-466", "name": "BREKER", "unit": "Kg", "price": 0},
    {"code": "BRG-467", "name": "TIANG TELEPON 7 M", "unit": "PCS", "price": 0},
    {"code": "BRG-468", "name": "TIANG TELEPON 9 M", "unit": "PCS", "price": 0},
    {"code": "BRG-469", "name": "BESI BETON 8 FULL", "unit": "BTG", "price": 0},
    {"code": "BRG-470", "name": "CATOK", "unit": "PCS", "price": 0},
    {"code": "BRG-471", "name": "SCRAP HSS", "unit": "Kg", "price": 0},
    {"code": "BRG-472", "name": "BATU GERINDA", "unit": "Kg", "price": 0},
    {"code": "BRG-473", "name": "JACK HUMMER", "unit": "Kg", "price": 0},
    {"code": "BRG-474", "name": "GEAR", "unit": "Kg", "price": 0},
    {"code": "BRG-475", "name": "HSS", "unit": "Kg", "price": 0},
    {"code": "BRG-476", "name": "TRAPO", "unit": "Kg", "price": 0},
    {"code": "BRG-477", "name": "KIKIR", "unit": "Kg", "price": 0},
    {"code": "BRG-478", "name": "HBEAM 250", "unit": "Kg", "price": 0},
    {"code": "BRG-479", "name": "ALAT BOR", "unit": "Kg", "price": 0},
    {"code": "BRG-480", "name": "BESI BOR", "unit": "Kg", "price": 0},
    {"code": "BRG-481", "name": "KAWAT LAS", "unit": "Kg", "price": 0},
    {"code": "BRG-482", "name": "ALAT BUBUT", "unit": "Kg", "price": 0},
    {"code": "BRG-483", "name": "BAUD CAMPUR", "unit": "Kg", "price": 0},
    {"code": "BRG-484", "name": "SPERPART ESKALATOR", "unit": "Kg", "price": 0},
    {"code": "BRG-485", "name": "LAMPU NEON", "unit": "PCS", "price": 0},
    {"code": "BRG-486", "name": "SENG GALVALUM", "unit": "M", "price": 0},
    {"code": "BRG-487", "name": "KERAMIK LISTRIK", "unit": "Kg", "price": 0},
    {"code": "BRG-488", "name": "MESIN KOMPESOR", "unit": "PCS", "price": 0},
    {"code": "BRG-489", "name": "JENSET", "unit": "UNIT", "price": 0},
    {"code": "BRG-490", "name": "ALUMUNIUM", "unit": "Kg", "price": 0},
    {"code": "BRG-491", "name": "BAKET BEKO", "unit": "Kg", "price": 0},
    {"code": "BRG-492", "name": "Filter Hydraulic Oil", "unit": "Pcs", "price": 0},
    {"code": "BRG-493", "name": "Filter Solar", "unit": "Pcs", "price": 0},
    {"code": "BRG-494", "name": "Filter Udara", "unit": "Pcs", "price": 0},
    {"code": "BRG-495", "name": "Fan Belt", "unit": "Pcs", "price": 0},
    {"code": "BRG-496", "name": "Cover Clutte", "unit": "Pcs", "price": 0},
    {"code": "BRG-497", "name": "Pump Assy", "unit": "Pcs", "price": 0},
    {"code": "BRG-498", "name": "Master Cluute", "unit": "Pcs", "price": 0},
    {"code": "BRG-499", "name": "Minyak Rem", "unit": "Pcs", "price": 0},
    {"code": "BRG-500", "name": "Bondex Busa", "unit": "Lembar", "price": 0},
    {"code": "BRG-496", "name": "COUNTAINER 20 FIT", "unit": "UNIT", "price": 0},
    {"code": "BRG-497", "name": "TIANG TLP 9 M", "unit": "BATANG", "price": 0},
    {"code": "BRG-498", "name": "BETON 16 URIL FULL", "unit": "PCS", "price": 0},
    {"code": "BRG-499", "name": "BETON 8 POLOS FULL", "unit": "PCS", "price": 0},
    {"code": "BRG-450", "name": "TALANG", "unit": "Kg", "price": 0}
    ],
                config: {
                    noPenjualan: 1, noPembelian: 1, noInvoice: 1, noSuratJalan: 1,
                    namaPerusahaan: "PT. SUMBER GANDA MEKAR", alamatPerusahaan: "Jl. Raya Gedebage No. 95 Bandung",
                    kontak: "CP. Irwan : 082117800626, CP. Uwem : 082318188863",
                    rekening: "BANK BCA No. Rek. 2801011286 a.n Maman Suherman",
                    rekeningPpn: "BANK BCA No. Rek. 2803024545 a.n PT. SUMBER GANDA MEKAR",
                    tagline: "JUAL BELI BESI TUA/BARU - RANGKA BETON/LOGAM - TIANG LISTRIK/TELP - KONSTRUKSI BAJA DAN PAKAN TERNAK",
                    logoUrl: "logo.png",
                },
                partyDetails: { customer: {
                  "PT. HAMPARAN REJEKI": { "npwp": "0020102315004000", "alamat": "", "phone": "" },
                  "PT. PUTRA NOER HIDAYAH": { "npwp": "857905400427000", "alamat": "", "phone": "" },
                  "AGUS KUSNAEDI": { "npwp": "3273070303830002", "alamat": "JL. SUKAJADI NO. 338/182 BANDUNG", "phone": "" },
                  "YOGI MUHAMAD QORNI": { "npwp": "3204272909980003", "alamat": "KP. PEUNDEUY", "phone": "" },
                  "DANI AGUS RAMDANI": { "npwp": "3204251203790023", "alamat": "KP. BALONG", "phone": "" },
                  "ARIFIN GUNAWIJAYA": { "npwp": "3204151012800004", "alamat": "KP. CIKONDANG", "phone": "" },
                  "BOBBY LOWELL": { "npwp": "3277010707940019", "alamat": "KOMP BUMI INDAH KAV 70", "phone": "" },
                  "WANTO": { "npwp": "3273122803850000", "alamat": "BANDUNG", "phone": "" }
                }, 
                pemasok: {
                  "PT. HAMPARAN REJEKI": { "npwp": "0020102315004000", "alamat": "", "phone": "" },
                  "PT. PUTRA NOER HIDAYAH": { "npwp": "857905400427000", "alamat": "", "phone": "" },
                  "AGUS KUSNAEDI": { "npwp": "3273070303830002", "alamat": "JL. SUKAJADI NO. 338/182 BANDUNG", "phone": "" },
                  "YOGI MUHAMAD QORNI": { "npwp": "3204272909980003", "alamat": "KP. PEUNDEUY", "phone": "" },
                  "DANI AGUS RAMDANI": { "npwp": "3204251203790023", "alamat": "KP. BALONG", "phone": "" },
                  "ARIFIN GUNAWIJAYA": { "npwp": "3204151012800004", "alamat": "KP. CIKONDANG", "phone": "" },
                  "BOBBY LOWELL": { "npwp": "3277010707940019", "alamat": "KOMP BUMI INDAH KAV 70", "phone": "" },
                  "WANTO": { "npwp": "3273122803850000", "alamat": "BANDUNG", "phone": "" }
                } },
            };

            return new Promise((resolve, reject) => {
                try {
                    const dataFromStorage = localStorage.getItem(this.STORAGE_KEY);
                    if (dataFromStorage) {
                        const parsedData = JSON.parse(dataFromStorage);
                        this.data = {
                            ...defaultData, ...parsedData,
                            config: { ...defaultData.config, ...(parsedData.config || {}) },
                            partyDetails: parsedData.partyDetails || defaultData.partyDetails,
                            invoices: parsedData.invoices || [],
                        };
                    } else {
                        this.data = defaultData;
                    }

                    this.partyDetails.customer = new Map(Object.entries(this.data.partyDetails.customer || {}));
                    this.partyDetails.pemasok = new Map(Object.entries(this.data.partyDetails.pemasok || {}));

                    const trashData = localStorage.getItem(this.TRASH_KEY);
                    if (trashData) {
                        this.trash = JSON.parse(trashData);
                        const cutoff = new Date();
                        cutoff.setDate(cutoff.getDate() - 30);
                        this.trash = this.trash.filter(item => new Date(item.deletedAt) >= cutoff);
                        localStorage.setItem(this.TRASH_KEY, JSON.stringify(this.trash));
                    } else { this.trash = []; }

                    this.buildItemIndex();
                    resolve();
                } catch (e) {
                    this.data = defaultData; this.trash = [];
                    this.buildItemIndex();
                    reject(e);
                }
            });
        }
        
        saveData() {
            try {
                this.data.partyDetails.customer = Object.fromEntries(this.partyDetails.customer);
                this.data.partyDetails.pemasok = Object.fromEntries(this.partyDetails.pemasok);
                localStorage.setItem(this.STORAGE_KEY, JSON.stringify(this.data));
            } catch (error) {
                Utils.logError("Failed to save data", error);
                this.showNotification("Gagal menyimpan data ke storage", false);
            }
        }
        
        // The rest of the javascript code is identical...
        // ... (insert remaining unchanged JavaScript methods here)
        
        selectItemFromDropdown(code, type) {
            const form = document.getElementById(`${type}Form`);
            if (!form) return;

            const item = this.data.masterItems.find((i) => i.code === code);
            if (!item) return;

            form.querySelector(`#item-selector-${type}`).value = item.name;
            form.querySelector(`#itemCode-${type}`).value = item.code;
            form.querySelector(`#itemUnit-${type}`).value = item.unit || "";
            form.querySelector(`#itemPrice-${type}`).value = this.formatNumber(item.price || 0);
            form.querySelector(`#itemQty-${type}`).focus();
            this.closeAllDropdowns();
        }

        formatCurrency(value, withSymbol = true) {
            const number = Number(value) || 0;
            const options = {
                style: "currency",
                currency: "IDR",
                minimumFractionDigits: 0,
                maximumFractionDigits: 0,
            };
            if (!withSymbol) {
                return new Intl.NumberFormat("id-ID").format(number);
            }
            return new Intl.NumberFormat("id-ID", options).format(number);
        }

        formatNumber(value) {
            return new Intl.NumberFormat("id-ID").format(Number(value) || 0);
        }

        addItemToTempList(type) {
            const form = document.getElementById(`${type}Form`);
            if (!form) return;

            const itemCode = form.querySelector(`#itemCode-${type}`).value;
            const qty = parseFloat(form.querySelector(`#itemQty-${type}`).value) || 0;
            const price = parseInt((form.querySelector(`#itemPrice-${type}`).value || "0").replace(/[^0-9]/g, ""), 10) || 0;
            const unit = form.querySelector(`#itemUnit-${type}`).value;

            const item = this.data.masterItems.find((i) => i.code === itemCode);
            if (!item) {
                this.showNotification("Kode barang tidak ditemukan.", false);
                return;
            }

            if (qty <= 0) {
                this.showNotification("Jumlah barang harus lebih dari 0.", false);
                return;
            }

            const newItem = {
                id: Date.now(),
                code: itemCode,
                name: item.name,
                qty,
                unit: unit || item.unit || "-",
                price: price,
                total: qty * price,
            };

            this.tempItems[type].push(newItem);
            this.renderTempItemsTable(type);
            form.querySelector(`#item-selector-${type}`).value = "";
            form.querySelector(`#itemCode-${type}`).value = "";
            form.querySelector(`#itemQty-${type}`).value = "0";
            form.querySelector(`#itemPrice-${type}`).value = "0";
            form.querySelector(`#itemUnit-${type}`).value = "";
            form.querySelector(`#item-selector-${type}`).focus();
        }

        filterPartyNames(type, showAll = false) {
            let partyType = type === "sale" ? "customer" : "pemasok";
            // Logic for 'edit' ID selection
            let inputId = `${partyType}Name-${type}`;
            let dropdownId = `party-dropdown-${type}`;
            
            if (type === 'edit') {
                 partyType = 'party'; // Just for variable consistency, real type determined below
                 inputId = `partyName-edit`;
                 dropdownId = `party-dropdown-edit`;
            }

            const input = document.getElementById(inputId);
            const filter = input?.value?.toUpperCase() || "";
            const dropdown = document.getElementById(dropdownId);
            if (!dropdown || !input) return;

            this.closeAllDropdowns();
            this.activeDropdown = dropdown;
            
            // Special handling for 'edit' to load correct party list
            let targetPartyType = partyType;
             if (type === 'edit') {
                 const transType = document.getElementById('transType-edit').value;
                 targetPartyType = transType === 'sale' ? 'customer' : 'pemasok';
            }

            const allPartyNames = [...this.partyDetails[targetPartyType].keys()];
            const filteredNames = showAll ? allPartyNames.sort() : allPartyNames.filter(name => name.toUpperCase().includes(filter)).sort();
            
            dropdown.innerHTML = filteredNames
                .map(name => `<div class="dropdown-option" data-name="${this.sanitizeInput(name)}">${this.sanitizeInput(name)}</div>`)
                .join("");
            
            dropdown.style.display = dropdown.innerHTML ? "block" : "none";
        }
        
        populatePartyDetails(name, type) {
            let partyType = type === 'sale' ? 'customer' : 'pemasok';
            // Handle edit type
             if (type === 'edit') {
                 const transType = document.getElementById('transType-edit').value;
                 partyType = transType === 'sale' ? 'customer' : 'pemasok';
            }

            const details = this.partyDetails[partyType].get(name);
            if (details) {
                // Determine ID prefix
                const prefix = type === 'edit' ? 'party' : partyType;
                
                // Perbaikan: Cek properti 'address' atau 'alamat'
                document.getElementById(`${prefix}Address-${type}`).value = details.address || details.alamat || '';
                
                // Perbaikan: Cek properti 'phone' atau 'telepon'
                document.getElementById(`${prefix}Phone-${type}`).value = details.phone || details.telepon || '';
                
                const npwpInput = document.getElementById(`${prefix}Npwp-${type}`);
                if (npwpInput) {
                    npwpInput.value = details.npwp || '';
                }
            }
        }
        
        buildItemIndex() {
            this.itemIndex.clear();
            if (!this.data || !Array.isArray(this.data.masterItems)) return;
            this.data.masterItems.forEach(item => {
                if (item.code) this.itemIndex.set(item.code.toUpperCase(), item);
                if (item.name && !this.itemIndex.has(item.name.toUpperCase())) {
                    this.itemIndex.set(item.name.toUpperCase(), item);
                }
            });
        }

        async deleteTransaction(dataKey, id) {
            if (confirm(`Apakah Anda yakin ingin menghapus transaksi ID: ${id}? Transaksi akan dipindahkan ke Trash.`)) {
                try {
                    this.showLoading(true);
                    const index = this.data[dataKey].findIndex(item => item.id === id);
                    if (index > -1) {
                        const [transaction] = this.data[dataKey].splice(index, 1);
                        const trashedItem = { ...transaction, dataKey, deletedAt: new Date().toISOString() };
                        this.trash.unshift(trashedItem);
                        
                        localStorage.setItem(this.TRASH_KEY, JSON.stringify(this.trash));
                        this.saveData();
                        await this.updateAllUI();
                        
                        this.showNotification(`Transaksi ${id} dipindahkan ke Trash. <button class="btn btn-sm btn-warning" onclick="app.restoreTransaction('${dataKey}', '${trashedItem.id}', true)">Undo</button>`);
                    }
                } catch (error) {
                    Utils.logError("Transaction delete failed", error);
                    this.showNotification("Gagal menghapus transaksi", false);
                } finally {
                    this.showLoading(false);
                }
            }
        }

        generateTrashHTML() {
            return `<div class="form-section">
                        <h3 class="form-section-title">Trash (Item dihapus < 30 hari)</h3>
                        <div class="table-container">
                            <table class="data-table">
                                <thead>
                                    <tr><th>Jenis</th><th>No. Transaksi</th><th>Tanggal</th><th>Nama</th><th>Dihapus Pada</th><th class="action-cell">Aksi</th></tr>
                                </thead>
                                <tbody id="trash-table"></tbody>
                            </table>
                        </div>
                    </div>`;
        }

        renderTrashTable() {
            const tableBody = document.getElementById("trash-table");
            if (!tableBody) return;

            tableBody.innerHTML = this.trash.map(item => {
                const party = item.customer || item.pemasok || item.penerima || "N/A";
                let typeName = "Unknown";
                switch(item.dataKey){
                    case "penjualan": typeName = "Penjualan"; break;
                    case "pembelian": typeName = "Pembelian"; break;
                    case "invoices": typeName = "Invoice"; break;
                    case "suratJalan": typeName = "Surat Jalan"; break;
                }

                return `<tr>
                            <td>${typeName}</td>
                            <td>${item.id}</td>
                            <td>${this.formatDate(item.tanggal)}</td>
                            <td>${party}</td>
                            <td>${this.formatDate(item.deletedAt)}</td>
                            <td class="action-cell">
                                <button class="btn btn-sm btn-success" onclick="app.restoreTransaction('${item.dataKey}', '${item.id}')">Pulihkan</button>
                                <button class="btn btn-sm btn-danger" onclick="app.permanentlyDeleteTransaction('${item.id}')">Hapus Permanen</button>
                            </td>
                        </tr>`;
            }).join('');
        }

        async restoreTransaction(dataKey, id, fromUndo = false) {
            const index = this.trash.findIndex(t => t.id === id && t.dataKey === dataKey);
            if (index === -1) {
                if(fromUndo) this.showNotification("Transaksi sudah dipulihkan.", false);
                return;
            };

            const [item] = this.trash.splice(index, 1);
            delete item.deletedAt;
            const originalDataKey = item.dataKey;
            delete item.dataKey;

            this.data[originalDataKey].unshift(item);
            this.data[originalDataKey].sort((a,b) => new Date(b.tanggal) - new Date(a.tanggal));

            localStorage.setItem(this.TRASH_KEY, JSON.stringify(this.trash));
            this.saveData();
            await this.updateAllUI();
            this.renderTrashTable();
            this.showNotification(`Transaksi ${id} berhasil dipulihkan.`);
        }

        permanentlyDeleteTransaction(id) {
            if (confirm(`Anda YAKIN ingin menghapus transaksi ${id} secara permanen? Tindakan ini tidak dapat dibatalkan.`)) {
                this.trash = this.trash.filter(t => t.id !== id);
                localStorage.setItem(this.TRASH_KEY, JSON.stringify(this.trash));
                this.renderTrashTable();
                this.showNotification(`Transaksi ${id} telah dihapus permanen.`);
            }
        }
        
        filterDropdown(type, showAll = false) {
            const input = document.getElementById(`item-selector-${type}`);
            const filter = input?.value?.toUpperCase() || "";
            const dropdown = document.getElementById(`dropdown-options-${type}`);
            if (!dropdown) return;

            this.closeAllDropdowns();
            this.activeDropdown = dropdown;
            
            const uniqueItems = new Map();
            if(this.itemIndex.has(filter)) {
                const item = this.itemIndex.get(filter);
                uniqueItems.set(item.code, item);
            }

            this.data.masterItems.forEach(item => {
                if (showAll || filter === "" || item.name.toUpperCase().includes(filter) || item.code.toUpperCase().includes(filter)) {
                    uniqueItems.set(item.code, item);
                }
            });

            const sortedItems = [...uniqueItems.values()].sort((a, b) => a.name.localeCompare(b.name));
            
            dropdown.innerHTML = sortedItems.map(item => 
                `<div class="dropdown-option" data-code="${item.code}">${item.name} <small>(${item.code})</small></div>`
            ).join('');
            
            dropdown.style.display = dropdown.innerHTML ? "block" : "none";
        }

        closeAllDropdowns() {
            document.querySelectorAll(".dropdown-options").forEach((d) => (d.style.display = "none"));
            if (this.activeDropdown) {
                this.activeDropdown = null;
            }
        }

        saveDraft(type) {
            const form = document.getElementById(`${type}Form`);
            if (!form) return;

            const draftData = {};
            form.querySelectorAll("input, select, textarea").forEach((input) => {
                if (input.id) {
                    draftData[input.id] = input.type === "checkbox" ? input.checked : input.value;
                }
            });

            const draft = {
                formData: draftData,
                tempItems: this.tempItems[type],
                expires: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString(),
            };

            this.draftForms[type] = draft;
            localStorage.setItem(this.DRAFT_KEY, JSON.stringify(this.draftForms));
        }

        loadDrafts() {
            try {
                const draftData = localStorage.getItem(this.DRAFT_KEY);
                if (!draftData) return;
                
                this.draftForms = JSON.parse(draftData);
                const now = new Date();

                Object.keys(this.draftForms).forEach((type) => {
                    const draft = this.draftForms[type];
                    if (!draft || !draft.formData || !Array.isArray(draft.tempItems) || new Date(draft.expires) <= now) {
                        delete this.draftForms[type];
                    } else if (draft.tempItems.length > 0 || Object.values(draft.formData).some(v => !!v)) {
  /* --- NOTIFIKASI DRAFT DINONAKTIFKAN ---
  if (confirm(`Ditemukan draft ${type} yang belum disimpan. Pulihkan?`)) {
    this.restoreDraft(type);
  } else {
    delete this.draftForms[type];
  }
  */
} else {
                        delete this.draftForms[type];
                    }
                });
                localStorage.setItem(this.DRAFT_KEY, JSON.stringify(this.draftForms));
            } catch (error) {
                Utils.logError("Failed to load drafts", error);
                this.showNotification("Gagal memuat draft", false);
            }
        }

        editTransaction(dataKey, id) {
            // Find transaction first
            const transaction = this.data[dataKey].find(t => t.id === id);
            if (!transaction) {
                this.showNotification("Transaksi tidak ditemukan", false);
                return;
            }
            
            // Determine form type based on dataKey or stored transType
            let transType = 'sale'; // default
            if (dataKey === 'invoices') {
                transType = transaction.transType; 
            } else if (dataKey === 'penjualan') {
                transType = 'sale';
            } else if (dataKey === 'pembelian') {
                transType = 'purchase';
            } else {
                transType = transaction.transType || 'sale';
            }

            // --- SWITCH TO EDIT TAB ---
            const editTab = document.querySelector(`.nav-tab[data-tab="edit"]`);
            if(editTab) {
                editTab.style.display = 'block'; // Make sure it's visible
                editTab.click(); 
            }
            
            const form = document.getElementById(`editForm`);
            if (!form) return;

             // Reset steps
            this.navigateToStep('edit', 1);

            // Hide history overlay if open (using original dataKey map for overlay ID)
            const overlayType = dataKey === "penjualan" ? "sale" : dataKey === "pembelian" ? "purchase" : dataKey === "suratJalan" ? "suratJalan" : "invoice";
            this.hideHistoryOverlay(overlayType);

            // Set editing ID & Trans Type
            this.editingId = id;
            document.getElementById('transType-edit').value = transType;
            
            // Update Title & Labels based on Type
            const isSale = transType === 'sale';
            const titleEl = document.getElementById('edit-form-title');
            if(titleEl) titleEl.textContent = isSale ? `Edit Penjualan: ${id}` : `Edit Pembelian: ${id}`;
            
            const partyLabel = document.getElementById('partyNameLabel-edit');
            if(partyLabel) partyLabel.textContent = isSale ? 'Nama Customer' : 'Nama Pemasok';
            
            const refGroup = document.getElementById('ref-group-edit');
            if(refGroup) refGroup.style.display = isSale ? 'block' : 'none';

            // Restore Data to Form
            // Dates & Basic Info
            if(form.querySelector(`#invoiceDate-edit`)) form.querySelector(`#invoiceDate-edit`).value = transaction.tanggal;
            if(form.querySelector(`#transNo-edit`)) form.querySelector(`#transNo-edit`).value = transaction.id;
            
            // Party Info
            // Note: In edit form we use generic 'party' prefix
            if(form.querySelector(`#partyName-edit`)) form.querySelector(`#partyName-edit`).value = transaction[isSale ? 'customer' : 'pemasok'] || transaction.customer || transaction.pemasok || transaction.penerima || "";
            if(form.querySelector(`#partyAddress-edit`)) form.querySelector(`#partyAddress-edit`).value = transaction.alamat || "";
            if(form.querySelector(`#partyPhone-edit`)) form.querySelector(`#partyPhone-edit`).value = transaction.telepon || "";
            if(form.querySelector(`#partyNpwp-edit`)) form.querySelector(`#partyNpwp-edit`).value = transaction.npwp || "";
            
            document.getElementById(`npwp-group-edit`).classList.toggle('hidden', !transaction.npwp);

            // PPN & Bebas PPN
            const includePpnCheckbox = form.querySelector(`#includePpn-edit`);
            if (includePpnCheckbox) {
                const isInvoice = dataKey === 'invoices';
                includePpnCheckbox.checked = isInvoice;
                // Trigger change event to update UI visibility
                includePpnCheckbox.dispatchEvent(new Event('change'));
                
                if (isInvoice) {
                     const bebasPpnCheckbox = form.querySelector(`#bebasPpn-edit`);
                     if(bebasPpnCheckbox) {
                         bebasPpnCheckbox.checked = !!transaction.isPpnDibebaskan;
                     }
                }
            }

            // Other fields
            if(form.querySelector(`#vehicleNo-edit`)) form.querySelector(`#vehicleNo-edit`).value = transaction.noKendaraan || "";
            if(form.querySelector(`#paymentMethod-edit`)) form.querySelector(`#paymentMethod-edit`).value = transaction.metodePembayaran || "Tunai";
            if(form.querySelector(`#notes-edit`)) form.querySelector(`#notes-edit`).value = transaction.notes || "";
            if(form.querySelector(`#ref-edit`)) form.querySelector(`#ref-edit`).value = transaction.ref || "";
            
            // Financials
            if(form.querySelector(`#discount-edit`)) form.querySelector(`#discount-edit`).value = this.formatCurrency(transaction.discount || 0);
            if(form.querySelector(`#shippingCost-edit`)) form.querySelector(`#shippingCost-edit`).value = this.formatCurrency(transaction.shippingCost || 0);
            if(form.querySelector(`#dp-edit`)) form.querySelector(`#dp-edit`).value = this.formatCurrency(transaction.dp || 0);

            // Items
            // Need to deep copy to avoid reference issues
            this.tempItems['edit'] = transaction.items.map(item => ({...item}));
            this.renderTempItemsTable('edit');
            this.calculateTotals('edit'); // Recalc totals immediately
            
            this.showNotification(`Edit Mode: Transaksi ${id} dimuat.`);
        }
        
        cancelEdit() {
             if (confirm("Batalkan perubahan edit? Data yang belum disimpan akan hilang.")) {
                this.editingId = null;
                const tab = document.querySelector('.nav-tab[data-tab="dashboard"]');
                if(tab) tab.click();
                
                // Hide edit tab
                const editTab = document.querySelector(`.nav-tab[data-tab="edit"]`);
                if(editTab) editTab.style.display = 'none';
             }
        }

        restoreDraft(type) {
            const draft = this.draftForms[type];
            if (!draft) return;
            const form = document.getElementById(`${type}Form`);
            if (!form) return;

            Object.entries(draft.formData).forEach(([id, value]) => {
                const input = document.getElementById(id);
                if (input) {
                    if (input.type === "checkbox") {
                        input.checked = value;
                        if (input.id.startsWith('includePpn')) {
                            input.dispatchEvent(new Event('change'));
                        }
                    }
                    else input.value = value;
                }
            });
            
            this.tempItems[type] = Array.isArray(draft.tempItems) ? draft.tempItems.filter(item => item && item.id && item.code && item.name) : [];
            this.renderTempItemsTable(type);
        }

        _getFilteredHistoryData(dataKey) {
            const type = dataKey === "penjualan" ? "sale" : dataKey === "pembelian" ? "purchase" : dataKey === "suratJalan" ? "suratJalan" : "invoice";
            const filters = document.getElementById(`history-filters-${type}`);
            const searchQuery = filters ? (filters.querySelector(".search-query")?.value || "").toUpperCase() : "";
            const startDate = filters ? filters.querySelector(".start-date")?.value : "";
            const endDate = filters ? filters.querySelector(".end-date")?.value : "";

            const filteredData = (this.data[dataKey] || []).filter(item => {
                const party = (item.customer || item.pemasok || item.penerima || "").toUpperCase();
                const idMatch = item.id.toUpperCase().includes(searchQuery);
                const partyMatch = party.includes(searchQuery);
                const dateMatch = (!startDate || item.tanggal >= startDate) && (!endDate || item.tanggal <= endDate);
                return (idMatch || partyMatch) && dateMatch;
            });
            return filteredData;
        }

        renderAllHistoryTables() {
            this.renderHistoryTable("penjualan", "sale-history-table");
            this.renderHistoryTable("pembelian", "purchase-history-table");
            this.renderHistoryTable("invoices", "invoice-history-table");
            this.renderHistoryTable("suratJalan", "suratJalan-history-table");
        }

        renderHistoryTable(dataKey, tableId, page = 1) {
            const tableBody = document.getElementById(tableId);
            if (!tableBody) return;
            
            const type = dataKey === "penjualan" ? "sale" : dataKey === "pembelian" ? "purchase" : dataKey === "suratJalan" ? "suratJalan" : "invoice";
            const itemsPerPage = 25;

            const filteredData = this._getFilteredHistoryData(dataKey);

            const totalPages = Math.ceil(filteredData.length / itemsPerPage);
            page = Math.min(Math.max(1, page), totalPages || 1);
            const startIndex = (page - 1) * itemsPerPage;
            const paginatedData = filteredData.slice(startIndex, startIndex + itemsPerPage);

            tableBody.innerHTML = paginatedData.map(item => {
                const party = item.customer || item.pemasok || item.penerima || "N/A";
                const isTransaction = dataKey !== "suratJalan";
                
                let printButtons = '';
                if (dataKey === 'invoices') {
                    printButtons = `
                            <button class="btn btn-sm btn-info" onclick="app.printTransaction('${dataKey}', '${item.id}', 'invoice')">Invoice</button>
                            <button class="btn btn-sm btn-primary" onclick="app.printTransaction('${dataKey}', '${item.id}', 'surat_jalan')">Surat Jalan</button>
                            <button class="btn btn-sm btn-warning" onclick="app.printTransaction('${dataKey}', '${item.id}', 'kwitansi')">Kwitansi</button>`;
                } else if (dataKey === 'penjualan' || dataKey === 'pembelian') {
                    printButtons = `
                            <button class="btn btn-sm btn-info" onclick="app.printTransaction('${dataKey}', '${item.id}', 'faktur')">Faktur</button>
                            <button class="btn btn-sm btn-primary" onclick="app.printTransaction('${dataKey}', '${item.id}', 'surat_jalan')">Surat Jalan</button>
                            <button class="btn btn-sm btn-warning" onclick="app.printTransaction('${dataKey}', '${item.id}', 'kwitansi')">Kwitansi</button>`;
                } else if (dataKey === 'suratJalan') {
                     printButtons = `<button class="btn btn-sm btn-success" onclick="app.printTransaction('${dataKey}', '${item.id}', 'surat_jalan')">Cetak</button>`;
                }

                return `<tr>
                            <td>${item.id}</td>
                            <td>${this.formatDate(item.tanggal)}</td>
                            <td class="truncate-text">${party}<br><small>${item.telepon || ""}</small></td>
                            ${isTransaction ? `<td class="text-right">${this.formatCurrency(item.grandTotal)}</td>` : `<td>${item.noKendaraan || ""}</td>`}
                            <td class="action-cell">
                                ${printButtons}
                                <button class="btn btn-sm btn-info" onclick="app.editTransaction('${dataKey}', '${item.id}')">Edit</button>
                                <button class="btn btn-sm btn-danger" onclick="app.deleteTransaction('${dataKey}', '${item.id}')">Hapus</button>
                            </td>
                        </tr>`;
            }).join('');
            
            const paginationContainer = document.getElementById(`pagination-${type}`);
            if (paginationContainer) {
                paginationContainer.querySelector(`#page-info-${type}`).textContent = `Halaman ${page} dari ${totalPages}`;
                const prevButton = paginationContainer.querySelector(`#prev-${type}`);
                const nextButton = paginationContainer.querySelector(`#next-${type}`);
                prevButton.disabled = page === 1;
                nextButton.disabled = page >= totalPages;
                prevButton.onclick = () => this.renderHistoryTable(dataKey, tableId, page - 1);
                nextButton.onclick = () => this.renderHistoryTable(dataKey, tableId, page + 1);
            }
        }

        renderTempItemsTable(type) {
            const tableBody = document.querySelector(`#temp-items-table-${type} tbody`);
            if (!tableBody) return;
            const list = this.tempItems[type];
            
            tableBody.innerHTML = list.map((item, index) => {
                return `<tr>
                            <td>${index + 1}</td>
                            <td>${item.code}</td>
                            <td class="truncate-text">${item.name}</td>
                            <td class="text-right">${this.formatNumber(item.qty)}</td>
                            <td>${item.unit}</td>
                            <td class="text-right">${this.formatCurrency(item.price)}</td>
                            <td class="text-right">${this.formatCurrency(item.total)}</td>
                            <td class="action-cell"><button type="button" class="btn btn-sm btn-danger delete-temp-item-btn" data-id="${item.id}">X</button></td>
                        </tr>`;
            }).join('');

            this.calculateTotals(type);
            this.saveDraft(type);
        }

        showNotification(message, isSuccess = true) {
            const notifArea = document.getElementById("notification-area");
            clearTimeout(this.notificationTimeout);

            notifArea.innerHTML = `${message} <button onclick="this.parentElement.style.display='none';">&times;</button>`;
            notifArea.className = `notification ${isSuccess ? "success" : "error"}`;
            notifArea.style.display = "block";
            window.scrollTo(0, 0);

            notifArea.querySelectorAll("button[onclick]").forEach(button => {
                const func = button.getAttribute('onclick');
                button.onclick = () => {
                    try { eval(func); } catch (e) { console.error("Error in notification button", e); }
                };
            });
            
            this.notificationTimeout = setTimeout(() => {
                notifArea.style.display = "none";
            }, 8000);
        }

        sanitizeInput(value) {
            if (typeof value !== 'string') return value;
            const div = document.createElement("div");
            div.textContent = value;
            return div.innerHTML;
        }

        calculateTotals(type) {
    const form = document.getElementById(`${type}Form`);
    if (!form) return { subtotal: 0, dpp: 0, ppn: 0, discount: 0, shippingCost: 0, dp: 0, grandTotal: 0 };

    const subtotal = this.tempItems[type].reduce((sum, item) => sum + (item.total || 0), 0);
    const discount = parseInt((form.querySelector(`#discount-${type}`)?.value || "0").replace(/[^0-9]/g, ""), 10) || 0;
    const shippingCost = parseInt((form.querySelector(`#shippingCost-${type}`)?.value || "0").replace(/[^0-9]/g, ""), 10) || 0;
    const dp = parseInt((form.querySelector(`#dp-${type}`)?.value || "0").replace(/[^0-9]/g, ""), 10) || 0;
    const includePpn = form.querySelector(`#includePpn-${type}`)?.checked;
    
    //  PERUBAHAN DIMULAI 
    const isPpnDibebaskan = form.querySelector(`#bebasPpn-${type}`)?.checked;
    //  PERUBAHAN SELESAI 

    const totalAfterDiscount = subtotal - discount;
    const dpp = (totalAfterDiscount + shippingCost) * (11/12);
    
    let ppn = 0;
    
    //  PERUBAHAN PADA BLOK INI 
    if (includePpn && !isPpnDibebaskan) {
        ppn = (totalAfterDiscount + shippingCost) * (11/100);
    }
    //  PERUBAHAN SELESAI 
    
    const grandTotal = totalAfterDiscount + ppn + shippingCost - dp;

    form.querySelector(`#subtotal-${type}`).textContent = this.formatCurrency(subtotal);

    //  PERUBAHAN PADA BLOK INI 
    const ppnDisplay = form.querySelector(`#ppn-${type}`);
    if (includePpn && isPpnDibebaskan) {
        ppnDisplay.textContent = 'Rp 0 (Dibebaskan)';
    } else {
        ppnDisplay.textContent = this.formatCurrency(ppn);
    }
    //  PERUBAHAN SELESAI 

    form.querySelector(`#grandTotal-${type}`).textContent = this.formatCurrency(grandTotal);

    const dppInfoEl = form.querySelector(`#dpp-info-${type}`);
    if (dppInfoEl) {
        //  PERUBAHAN PADA KONDISI INI 
        if (includePpn && !isPpnDibebaskan && dpp > 0) {
            dppInfoEl.textContent = `(dpp: ${this.formatCurrency(dpp, false)})`;
        } else {
            dppInfoEl.textContent = '';
        }
    }

    return { subtotal, dpp, ppn, discount, shippingCost, dp, grandTotal };
}

        generateId(type, transType = null) {
            let num, prefix, configKey;
            const date = new Date();
            const year = date.getFullYear().toString().slice(-2);
            const month = (date.getMonth() + 1).toString().padStart(2, "0");

            switch (type) {
                case "sale":
                    num = this.data.config.noPenjualan;
                    prefix = "SGM.PJ";
                    configKey = "noPenjualan";
                    break;
                case "purchase":
                    num = this.data.config.noPembelian;
                    prefix = "SGM.PB";
                    configKey = "noPembelian";
                    break;
                case "invoice":
                    num = this.data.config.noInvoice;
                    prefix = transType === "sale" ? "SGM.PJF" : "SGM.PBF";
                    configKey = "noInvoice";
                    break;
                case "suratJalan":
                     num = this.data.config.noSuratJalan;
                     prefix = "SGM.SJ";
                     configKey = "noSuratJalan";
                     break;
                default:
                    return "";
            }

            const id = `${String(num).padStart(3, "0")}.${prefix}.${year}${month}`;
            const dataKey = type === "sale" ? "penjualan" : type === "purchase" ? "pembelian" : type;

            if (this.data[dataKey] && this.data[dataKey].some(t => t.id === id)) {
                this.data.config[configKey]++;
                return this.generateId(type, transType);
            }
            return id;
        }

        async saveTransaction(type) {
            try {
                this.showLoading(true);
                const form = document.getElementById(`${type}Form`);
                const tempItems = this.tempItems[type];
                if (tempItems.length === 0) throw new Error("Tambahkan minimal satu barang.");
                for (const field of form.querySelectorAll("[required]")) {
                    const label = field.labels?.[0]?.textContent || field.name;
                    if (!Utils.validateInput(field.value, "required")) {
                        field.focus();
                        throw new Error(`Field '${label}' harus diisi.`);
                    }
                }
                // Mapping generic fields to specific ones if editing
                const transType = type === 'edit' ? document.getElementById('transType-edit').value : type;
                
                const partyTypeCalc = type === 'edit' ? (transType === 'sale' ? 'customer' : 'pemasok') : partyType;
                
                const partyNameVal = type === 'edit' ? form.querySelector(`#partyName-edit`).value.trim() : form.querySelector(`#${partyType}Name-${type}`).value.trim();
                const addressVal = type === 'edit' ? form.querySelector(`#partyAddress-edit`).value.trim() : form.querySelector(`#${partyType}Address-${type}`).value.trim();
                const phoneVal = type === 'edit' ? form.querySelector(`#partyPhone-edit`).value.trim() : form.querySelector(`#${partyType}Phone-${type}`).value.trim();
                const npwpVal = type === 'edit' ? form.querySelector(`#partyNpwp-edit`).value.trim() : form.querySelector(`#${partyType}Npwp-${type}`).value.trim();
                
                const partyName = this.sanitizeInput(partyNameVal);
                const address = this.sanitizeInput(addressVal);
                const phone = this.sanitizeInput(phoneVal);
                const npwp = this.sanitizeInput(npwpVal);

                if (partyName) {
                    this.partyDetails[partyTypeCalc].set(partyName, { address, phone, npwp });
                }

                const isTransaction = transType === "sale" || transType === "purchase";
                const includePpn = isTransaction && form.querySelector(`#includePpn-${type}`)?.checked;
                const isPpnDibebaskan = form.querySelector(`#bebasPpn-${type}`)?.checked;
                const dataKey = includePpn ? "invoices" : (transType === "sale" ? "penjualan" : "pembelian");
                const idType = includePpn ? "invoice" : transType;
                
                if (includePpn && !npwp) {
                    throw new Error("Field 'NPWP/NIK' harus diisi jika menggunakan PPN.");
                }

                // --- EDIT LOGIC START ---
                let newId;
                if (this.editingId) {
                    // We are editing
                    newId = this.editingId;
                } else {
                    // New Transaction
                    newId = this.generateId(idType, includePpn ? transType : null);
                }
                // --- EDIT LOGIC END ---

                const totals = this.calculateTotals(type);

                const newTrans = {
                    id: newId,
                    tanggal: form.querySelector(`#invoiceDate-${type}`).value,
                    notes: this.sanitizeInput(form.querySelector(`#notes-${type}`).value),
                    items: [...tempItems],
                    ...totals,
                    [partyTypeCalc]: partyName,
                    alamat: address,
                    telepon: phone,
                    npwp: npwp,
                    isPpnDibebaskan: includePpn && isPpnDibebaskan,
                    noKendaraan: this.sanitizeInput(form.querySelector(`#vehicleNo-${type}`)?.value),
                    metodePembayaran: form.querySelector(`#paymentMethod-${type}`).value,
                    transType: transType, 
                };
                
                if (transType === "sale") {
                    newTrans.ref = this.sanitizeInput(form.querySelector(`#ref-${type}`).value);
                }

                if (this.editingId) {
                     // UPDATE EXISTING
                     const index = this.data[dataKey].findIndex(t => t.id === newId);
                     if (index !== -1) {
                         this.data[dataKey][index] = newTrans;
                         this.showNotification(`Transaksi ${newTrans.id} berhasil diperbarui.`);
                     } else {
                         // Fallback if not found (shouldn't happen)
                         this.data[dataKey].unshift(newTrans);
                     }
                     // Exit Edit Mode
                     this.editingId = null;
                     
                     // Hide edit tab if used
                     if(type === 'edit') {
                        document.querySelector(`.nav-tab[data-tab="edit"]`).style.display = 'none';
                         const tab = document.querySelector('.nav-tab[data-tab="dashboard"]');
                        if(tab) tab.click();
                     }
                     
                } else {
                    // CREATE NEW
                    if (includePpn) this.data.config.noInvoice++;
                    else if (transType === "sale") this.data.config.noPenjualan++;
                    else if (transType === "purchase") this.data.config.noPembelian++;
                    
                    this.data[dataKey].unshift(newTrans);
                    this.showNotification(`Transaksi ${newTrans.id} berhasil disimpan di ${dataKey}.`);
                }

                this.saveData();
                this.resetForm(type); 
                await this.updateAllUI();
                
            } catch (error) {
                Utils.logError("Transaction save failed", error);
                this.showNotification(`Gagal: ${error.message}`, false);
            } finally {
                this.showLoading(false);
            }
        }

        resetForm(type) {
            const form = document.getElementById(`${type}Form`);
            if (!form) return;
            form.reset();
            this.tempItems[type] = [];
            this.renderTempItemsTable(type);
            form.querySelector(`#invoiceDate-${type}`).value = new Date().toISOString().slice(0, 10);
            
            let partyType = type === "sale" ? "customer" : "pemasok";
            if (type === 'edit') partyType = 'party';

            document.getElementById(`npwp-group-${type}`).classList.add('hidden');
            const npwpId = type === 'edit' ? `partyNpwp-edit` : `${partyType}Npwp-${type}`;
            const npwpInput = document.getElementById(npwpId);
            if(npwpInput) npwpInput.required = false;

            form.querySelector(`#transNo-${type}`).value = this.generateId(type); 
            
            this.draftForms[type] = null;
            localStorage.setItem(this.DRAFT_KEY, JSON.stringify(this.draftForms));

            this.editingId = null; // Clear editing state
            this.navigateToStep(type, 1)
        }

        generateHistoryHTML(type) {
            const isInvoice = type === 'invoice';
            const isSuratJalan = type === 'suratJalan';
            let title, partyHeader, dataKey;
        
            switch (type) {
                case 'sale':
                    title = 'Penjualan (Tanpa PPN)';
                    partyHeader = 'Customer';
                    dataKey = 'penjualan';
                    break;
                case 'purchase':
                    title = 'Pembelian (Tanpa PPN)';
                    partyHeader = 'Pemasok';
                    dataKey = 'pembelian';
                    break;
                case 'invoice':
                    title = 'Invoice (Dengan PPN)';
                    partyHeader = 'Customer/Pemasok';
                    dataKey = 'invoices';
                    break;
                case 'suratJalan':
                    title = 'Surat Jalan';
                    partyHeader = 'Penerima';
                    dataKey = 'suratJalan';
                    break;
                default:
                    return '';
            }
        
            const headers = `<th>No. Transaksi</th><th>Tanggal</th><th>${partyHeader} & Kontak</th>${!isSuratJalan ? '<th class="text-right">Total</th>' : '<th>No. Kendaraan</th>'}<th class="action-cell">Aksi</th>`;
        
            return `<div class="form-section" style="margin-top: 40px;">
                <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); padding-bottom: 15px; margin-bottom: 15px;">
    <h3 class="form-section-title" style="margin-bottom:0; border:none; padding-bottom:0;">Riwayat ${title}</h3>
</div>
                <div class="history-filters" id="history-filters-${type}">
                    <div class="form-group"><label>Cari (ID, Nama)</label><input type="text" class="search-query" placeholder="Ketik untuk mencari..."></div>
                    <div class="form-group"><label>Dari Tanggal</label><input type="date" class="start-date"></div>
                    <div class="form-group"><label>Sampai Tanggal</label><input type="date" class="end-date"></div>
                </div>
                <div class="actions-group" style="margin-bottom: 10px; justify-content: flex-start;">
                    <button class="btn btn-success" onclick="app.exportHistoryToCsv('${dataKey}')">Export CSV</button>
                    <button class="btn btn-danger" id="export-pdf-btn-${type}" data-key="${dataKey}">Export PDF</button>
                    <button class="btn btn-primary" id="export-excel-btn-${type}" data-key="${dataKey}">Export Excel</button>
                </div>
                <div class="table-container">
                    <table class="data-table">
                        <thead><tr>${headers}</tr></thead>
                        <tbody id="${type}-history-table"></tbody>
                    </table>
                </div>
                <div class="actions-group" id="pagination-${type}" style="justify-content: center;">
                    <button class="btn btn-primary" id="prev-${type}" disabled>&laquo; Sebelumnya</button>
                    <span id="page-info-${type}" style="align-self: center; margin: 0 15px;">Halaman 1 dari 1</span>
                    <button class="btn btn-primary" id="next-${type}" disabled>Berikutnya &raquo;</button>
                </div>
            </div>`;
        }
        
        exportHistoryToCsv(dataKey) {
            this.showLoading(true);
            const transactions = this._getFilteredHistoryData(dataKey);
            if (transactions.length === 0) {
                this.showNotification("Tidak ada data untuk diekspor.", false);
                this.showLoading(false);
                return;
            }

            const headers = ["No. Transaksi", "Tanggal", "Partner", "Alamat", "Telepon", "NPWP/NIK", "No. Kendaraan", "Metode Pembayaran", "Catatan", "Tipe Transaksi", "Subtotal", "Diskon", "PPN", "Ongkir", "DP", "Grand Total", "Kode Barang", "Nama Barang", "Jumlah", "Satuan", "Harga Satuan", "Total Barang"];
            const csvRows = [headers.join(",")];
            
            transactions.forEach(t => {
                (t.items || []).forEach(item => {
                    const row = [
                        `"${t.id}"`, `"${t.tanggal}"`, `"${t.customer || t.pemasok || t.penerima || ''}"`,
                        `"${t.alamat || ''}"`, `"${t.telepon || ''}"`, `"${t.npwp || ''}"`, `"${t.noKendaraan || ''}"`, `"${t.metodePembayaran || ''}"`,
                        `"${(t.notes || '').replace(/"/g, '""')}"`, `"${t.transType || dataKey}"`,
                        t.subtotal ?? 0, t.discount ?? 0, t.ppn ?? 0, t.shippingCost ?? 0, t.dp ?? 0, t.grandTotal ?? 0,
                        `"${item.code}"`, `"${(item.name || '').replace(/"/g, '""')}"`, item.qty, `"${item.unit}"`, item.price ?? 0, item.total ?? 0
                    ];
                    csvRows.push(row.join(','));
                });
            });

            const csvString = csvRows.join("\n");
            const blob = new Blob([`\uFEFF${csvString}`], { type: "text/csv;charset=utf-8;" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `riwayat_${dataKey}_${new Date().toISOString().slice(0, 10)}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            this.showLoading(false);
            this.showNotification("Riwayat transaksi berhasil diekspor ke CSV.");
        }
        
        exportHistoryToExcel(dataKey) {
            this.showLoading(true);
            const transactions = this._getFilteredHistoryData(dataKey);
            if (transactions.length === 0) {
                this.showNotification("Tidak ada data untuk diekspor.", false);
                this.showLoading(false);
                return;
            }

            const flattenedData = [];
            transactions.forEach(t => {
                const partner = t.customer || t.pemasok || t.penerima || '';
                (t.items || []).forEach(item => {
                    flattenedData.push({
                        'No Transaksi': t.id, 'Tanggal': t.tanggal, 'Partner': partner, 'NPWP/NIK': t.npwp || '', 'Tipe Transaksi': t.transType || dataKey,
                        'Subtotal': t.subtotal, 'Diskon': t.discount, 'PPN': t.ppn, 'Ongkir': t.shippingCost, 'DP': t.dp, 'Grand Total': t.grandTotal,
                        'Kode Barang': item.code, 'Nama Barang': item.name, 'Jumlah': item.qty, 'Satuan': item.unit,
                        'Harga Satuan': item.price, 'Total Barang': item.total
                    });
                });
            });

            const worksheet = XLSX.utils.json_to_sheet(flattenedData);
            worksheet['!cols'] = [
                { wch: 18 }, { wch: 12 }, { wch: 25 }, { wch: 20 }, { wch: 15 }, 
                { wch: 15 }, { wch: 15 }, { wch: 15 }, { wch: 15 }, { wch: 15 }, { wch: 15 },
                { wch: 15 }, { wch: 30 }, { wch: 10 }, { wch: 10 }, { wch: 15 }, { wch: 15 }
            ];
            
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Laporan');
            XLSX.writeFile(workbook, `Laporan_${dataKey}_${new Date().toISOString().slice(0, 10)}.xlsx`);
            this.showLoading(false);
            this.showNotification("Riwayat transaksi berhasil diekspor ke Excel.");
        }

        exportHistoryToPdf(dataKey) {
            this.showLoading(true);
            const transactions = this._getFilteredHistoryData(dataKey);
            if (transactions.length === 0) {
                this.showNotification("Tidak ada data untuk diekspor.", false);
                this.showLoading(false);
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'landscape' });
            
            const head = [['ID', 'Tanggal', 'Partner', 'NPWP', 'Tipe', 'Nama Brg', 'Jml', 'Satuan', 'Harga', 'Total']];
            const body = [];
            transactions.forEach(t => {
                (t.items || []).forEach(item => {
                    body.push([
                        t.id, t.tanggal, t.customer || t.pemasok || '', t.npwp || '-', t.transType || dataKey,
                        item.name || '-', this.formatNumber(item.qty || 0), item.unit || '-',
                        this.formatCurrency(item.price || 0, false), this.formatCurrency(item.total || 0, false)
                    ]);
                });
            });

            doc.autoTable({
                head: head,
                body: body,
                startY: 25,
                headStyles: { fillColor: [0, 48, 135] },
                didDrawPage: (data) => {
                    doc.setFontSize(16);
                    doc.setFont('helvetica', 'bold');
                    doc.text(`Laporan ${dataKey.charAt(0).toUpperCase() + dataKey.slice(1)}`, data.settings.margin.left, 15);
                    const today = new Date().toLocaleDateString('id-ID', { day: '2-digit', month: 'long', year: 'numeric' });
                    doc.setFontSize(10);
                    doc.text(`Dicetak pada: ${today}`, doc.internal.pageSize.getWidth() - data.settings.margin.right, 15, { align: 'right' });
                },
            });

            doc.save(`Laporan_${dataKey}_${new Date().toISOString().slice(0, 10)}.pdf`);
            this.showLoading(false);
            this.showNotification("Riwayat transaksi berhasil diekspor ke PDF.");
        }
        
        generateDashboardHTML() {
            return `<div class="form-section">
                        <h3 class="form-section-title">
                            <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/></svg>
                            Dashboard
                        </h3>
                        <div class="quick-actions" style="margin-bottom: 20px;">
                             <button class="btn btn-success" onclick="app.switchToTab('penjualan')">
                                <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 -960 960 960" width="24"><path d="M440-440H200v-80h240v-240h80v240h240v80H520v240h-80v-240Z"/></svg>
                                Buat Penjualan Baru
                             </button>
                             <button class="btn btn-info" onclick="app.switchToTab('pembelian')">
                                <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 -960 960 960" width="24"><path d="M440-440H200v-80h240v-240h80v240h240v80H520v240h-80v-240Z"/></svg>
                                Buat Pembelian Baru
                             </button>
                        </div>

                        <!-- PERIOD FILTERS -->
                        <div class="actions-group" style="margin-bottom: 20px; justify-content: flex-start; gap: 10px;">
                            <span style="font-weight: 600; color: var(--text);">Filter Periode:</span>
                            <button class="btn btn-sm btn-secondary" onclick="app.filterDashboardRange('today')">Hari Ini</button>
                            <button class="btn btn-sm btn-secondary" onclick="app.filterDashboardRange('week')">Minggu Ini</button>
                            <button class="btn btn-sm btn-secondary" onclick="app.filterDashboardRange('month')">Bulan Ini</button>
                            <button class="btn btn-sm btn-secondary" onclick="app.filterDashboardRange('year')">Tahun Ini</button>
                            <button class="btn btn-sm btn-secondary" onclick="app.filterDashboardRange('all')">Semua</button>
                        </div>
                        
                        <div class="stat-cards" id="dashboard-stats" style="margin-bottom: 25px;"></div>

                        <!-- PRO CHARTS GRID -->
                        <div class="dashboard-grid-pro">
                            <div class="chart-card">
                                <div class="chart-header">
                                    <span class="chart-title">Analisis Transaksi & Profit</span>
                                </div>
                                <div style="flex:1; position:relative;">
                                    <canvas id="salesChart"></canvas>
                                </div>
                            </div>
                            <div class="chart-card">
                                <div class="chart-header">
                                    <span class="chart-title">Top 5 Produk Terlaris</span>
                                </div>
                                <div style="flex:1; position:relative;">
                                    <canvas id="productChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3 class="form-section-title">Ringkasan Transaksi Terbaru (50 Teratas)</h3>
                        <div class="table-container">
                            <table class="data-table" id="dashboard-transactions-table">
                                <thead>
                                    <tr><th>Jenis</th><th>No. Transaksi</th><th>Tanggal</th><th>Nama</th><th class="text-right">Total</th><th class="action-cell">Aksi</th></tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>`;
        }

        switchToTab(tabName) {
        const tabButton = document.querySelector(`.nav-tab[data-tab="${tabName}"]`);
        if (tabButton) {
          tabButton.click();
        } else {
          console.error(`Tombol untuk tab "${tabName}" tidak ditemukan.`);
        }
      }

        generateAddItemFormHTML() {
            return `<form id="add-master-item-form-element">
                        <div class="form-grid" style="align-items: flex-end;">
                            <div class="form-group"><label for="newItemCode">Kode Barang</label><input type="text" id="newItemCode" required pattern="[A-Za-z0-9-]{1,20}"></div>
                            <div class="form-group"><label for="newItemName">Nama Barang</label><input type="text" id="newItemName" required maxlength="100"></div>
                            <div class="form-group"><label for="newItemUnit">Satuan</label><input type="text" id="newItemUnit" placeholder="e.g., kg, unit, m"></div>
                            <div class="form-group"><label for="newItemPrice">Harga Jual Default</label><input type="text" id="newItemPrice" class="rupiah-input" value="0"></div>
                            <div class="form-group"><button type="submit" class="btn btn-primary">Tambah ke Master</button></div>
                        </div>
                    </form>`;
        }

        renderMasterItemsTable() {
    const tableBody = document.getElementById("master-items-table-body");
    if (!tableBody) return;

    const searchInput = document.getElementById("search-master-items");
    const filter = searchInput ? searchInput.value.toUpperCase() : "";
    
    const filteredItems = this.data.masterItems.filter(item =>
        item.name.toUpperCase().includes(filter) || item.code.toUpperCase().includes(filter)
    );

    // Logika Paginasi
    const itemsPerPage = 5;
    const totalPages = Math.ceil(filteredItems.length / itemsPerPage) || 1;
    this.masterItemsPage = Math.max(1, Math.min(this.masterItemsPage, totalPages));
    
    const startIndex = (this.masterItemsPage - 1) * itemsPerPage;
    const paginatedItems = filteredItems.slice(startIndex, startIndex + itemsPerPage);

    // Render baris tabel
    tableBody.innerHTML = paginatedItems.map(item => `
        <tr>
            <td>${this.sanitizeInput(item.code)}</td>
            <td class="truncate-text">${this.sanitizeInput(item.name)}</td>
            <td>${this.sanitizeInput(item.unit)}</td>
            <td class="text-right">${this.formatCurrency(item.price || 0)}</td>
            <td class="action-cell">
                <button class="btn btn-sm btn-warning" onclick="app.showItemEditor('${item.code}')">Edit</button>
                <button class="btn btn-sm btn-danger" onclick="app.deleteMasterItem('${item.code}')">Hapus</button>
            </td>
        </tr>
    `).join('');

    // Update info paginasi dan tombol
    document.getElementById('current-item-page').textContent = this.masterItemsPage;
    document.getElementById('total-item-pages').textContent = totalPages;
    document.getElementById('prev-item-page').disabled = this.masterItemsPage === 1;
    document.getElementById('next-item-page').disabled = this.masterItemsPage >= totalPages;

    this.updateMasterItemCountDisplay(filteredItems.length);
}

/**
 * Menampilkan modal/pop-up untuk menambah atau mengedit barang.
 * @param {string|null} itemCode - Kode barang yang akan diedit. Jika null, mode tambah baru.
 */
showItemEditor(itemCode = null) {
    const modal = document.getElementById('item-editor-modal');
    const form = document.getElementById('item-editor-form');
    form.reset();

    if (itemCode) { // Mode Edit
        const item = this.data.masterItems.find(i => i.code === itemCode);
        if (item) {
            document.getElementById('edit-item-original-code').value = item.code;
            document.getElementById('edit-item-code').value = item.code;
            document.getElementById('edit-item-name').value = item.name;
            document.getElementById('edit-item-unit').value = item.unit;
            document.getElementById('edit-item-price').value = this.formatNumber(item.price || 0);
        }
    } else { // Mode Tambah Baru
        document.getElementById('edit-item-original-code').value = '';
    }
    
    // GANTI BARIS INI
    modal.style.display = 'flex'; // MENJADI SEPERTI INI
    document.getElementById('edit-item-code').focus();
}

/**
 * Menyembunyikan modal editor barang.
 */
hideItemEditor() {
    const modal = document.getElementById('item-editor-modal');
    modal.style.display = 'none';
}

/**
 * Menyimpan data barang dari modal (baik tambah baru maupun edit).
 */
saveMasterItemFromModal(event) {
    event.preventDefault();
    const originalCode = document.getElementById('edit-item-original-code').value.trim();
    const code = document.getElementById('edit-item-code').value.trim();
    const name = document.getElementById('edit-item-name').value.trim();
    const unit = document.getElementById('edit-item-unit').value.trim();
    const price = parseInt(document.getElementById('edit-item-price').value.replace(/[^0-9]/g, ""), 10) || 0;

    if (!code || !name) {
        this.showNotification("Kode dan Nama Barang harus diisi.", false);
        return;
    }

    // Cek duplikasi kode, kecuali jika kodenya tidak berubah saat edit
    if (this.data.masterItems.some(item => item.code.toUpperCase() === code.toUpperCase() && item.code !== originalCode)) {
        this.showNotification(`Kode barang '${code}' sudah ada. Gunakan kode lain.`, false);
        return;
    }

    if (originalCode) { // Mode Edit
        const itemIndex = this.data.masterItems.findIndex(i => i.code === originalCode);
        if (itemIndex > -1) {
            this.data.masterItems[itemIndex] = { code, name, unit, price };
            this.showNotification(`Barang '${name}' berhasil diperbarui.`);
        }
    } else { // Mode Tambah Baru
        this.data.masterItems.unshift({ code, name, unit, price });
        this.showNotification(`Barang '${name}' berhasil ditambahkan.`);
    }

    this.buildItemIndex();
    this.saveData();
    this.renderMasterItemsTable();
    this.hideItemEditor();
}

/**
 * Menghapus data master barang.
 */
deleteMasterItem(itemCode) {
    if (confirm(`Yakin ingin menghapus barang dengan kode: ${itemCode}?`)) {
        this.data.masterItems = this.data.masterItems.filter(item => item.code !== itemCode);
        this.buildItemIndex();
        this.saveData();
        this.renderMasterItemsTable();
        this.showNotification(`Barang '${itemCode}' telah dihapus.`);
    }
}
        
        generatePrintHTML(transaction, template) {
            let printId = transaction.id || 'N/A';
            if (template === "surat_jalan") {
                printId = transaction.id.replace(/SGM\.(PJ|PB|PJF|PBV)/, "SGM.SJ");
            }
            
            const config = this.data.config;
            const isTransaction = transaction.grandTotal !== undefined;
            const partyName = transaction.customer || transaction.pemasok || transaction.penerima || 'N/A';
            const grandTotalInteger = Math.floor(transaction.grandTotal || 0);

            let title = "SURAT JALAN";
            if (template === "faktur") title = `FAKTUR ${transaction.customer ? "PENJUALAN" : "PEMBELIAN"}`;
            else if (template === "invoice") title = `INVOICE ${transaction.transType === "sale" ? "PENJUALAN" : "PEMBELIAN"}`;
            else if (template === "kwitansi") title = "KWITANSI PEMBAYARAN";
            
            let noLabel = "No. Surat Jalan";
            if (template === "faktur") noLabel = "No. Faktur";
            else if (template === "invoice") noLabel = "No. Invoice";
            else if (template === "kwitansi") noLabel = "No. Kwitansi";

            // --- PERBAIKAN TATA LETAK: Titik dua (:) dipisah ke kolom sendiri ---
            let metaContent = `<div class="meta-tables">
                <table class="meta-table">
                    <tr><td>Kepada Yth.</td><td>:</td><td>${this.sanitizeInput(partyName)}</td></tr>
                    <tr><td>Alamat</td><td>:</td><td>${this.sanitizeInput(transaction.alamat || "-")}</td></tr>
                    ${transaction.telepon ? `<tr><td>Telepon</td><td>:</td><td>${this.sanitizeInput(transaction.telepon)}</td></tr>` : ""}
                    ${transaction.npwp && template === 'invoice' ? `<tr><td>NPWP/NIK</td><td>:</td><td>${this.sanitizeInput(transaction.npwp)}</td></tr>` : ""}
                </table>
                <table class="meta-table">
                    <tr><td>${noLabel}</td><td>:</td><td>${printId}</td></tr>
                    <tr><td>Tanggal</td><td>:</td><td>${this.formatDate(transaction.tanggal)}</td></tr>
                    ${isTransaction && transaction.ref && template !== "surat_jalan" ? `<tr><td>Ref</td><td>:</td><td>${this.sanitizeInput(transaction.ref)}</td></tr>` : ""}
                    ${transaction.noKendaraan ? `<tr><td>No. Kendaraan</td><td>:</td><td>${this.sanitizeInput(transaction.noKendaraan)}</td></tr>` : ""}
                    ${isTransaction && transaction.metodePembayaran && template !== "surat_jalan" ? `<tr><td>Metode Pembayaran</td><td>:</td><td>${this.sanitizeInput(transaction.metodePembayaran)}</td></tr>` : ""}
                </table>
            </div>`;

            if (template === "kwitansi") {
                metaContent = `<div class="kwitansi-box">
                    <table class="meta-table" style="width: 100%; table-layout: fixed;">
                        <tr><td style="width: 40mm; font-weight: bold;">Sudah terima dari</td><td>:</td><td>${this.sanitizeInput(partyName)}</td></tr>
                        <tr><td style="font-weight: bold;">Uang Sejumlah</td><td>:</td><td><b>${this.formatCurrency(transaction.grandTotal || 0)}</b></td></tr>
                        <tr><td style="font-weight: bold; vertical-align: top;">Terbilang</td><td style="vertical-align: top;">:</td><td style="vertical-align: top;" class="terbilang">${this.terbilang(grandTotalInteger)} rupiah</td></tr>
                        <tr><td style="font-weight: bold; vertical-align: top;">Untuk Pembayaran</td><td style="vertical-align: top;">:</td><td style="vertical-align: top;">Pelunasan ${transaction.ppn ? 'Invoice' : 'Faktur'} No. ${transaction.id || "N/A"}</td></tr>
                        ${transaction.metodePembayaran ? `<tr><td style="font-weight: bold;">Metode Pembayaran</td><td>:</td><td>${this.sanitizeInput(transaction.metodePembayaran)}</td></tr>` : ""}
                    </table>
                </div>`;
            }

            const maxItems = 20;
            const limitedItems = (transaction.items || []).slice(0, maxItems);
            
            // --- PERBAIKAN SIMBOL RP: Mengganti formatNumber dengan formatCurrency ---
            const itemsContent = template !== "kwitansi" ? `<table class="items-table">
                <thead>
                    <tr>
                        <th style="width:5%;">No</th>
                        <th style="width:${template === 'surat_jalan' ? '70%' : '35%'};">Nama Barang</th>
                        <th style="width:10%; text-align:right;">Qty</th>
                        <th style="width:10%; text-align:center;">Satuan</th>
                        ${template !== "surat_jalan" && isTransaction ? `
                            <th style="width:15%; text-align:right;">Harga Satuan</th>
                            <th style="width:20%; text-align:right;">Jumlah</th>
                        ` : ""}
                    </tr>
                </thead>
                <tbody>
                    ${limitedItems.map((item, i) => `<tr>
                        <td style="text-align:center;">${i + 1}</td>
                        <td>${this.sanitizeInput(item.name)} ${item.code ? `<small>(${this.sanitizeInput(item.code)})</small>` : ""}</td>
                        <td style="text-align:right;">${this.formatNumber(item.qty)}</td>
                        <td style="text-align:center;">${this.sanitizeInput(item.unit || "-")}</td>
                        ${template !== "surat_jalan" && isTransaction ? `
                            <td style="text-align:right;">${this.formatCurrency(item.price || 0)}</td>
                            <td style="text-align:right;">${this.formatCurrency(item.total || 0)}</td>
                        ` : ""}
                    </tr>`).join("")}
                </tbody>
            </table>` : "";

            const summaryContent = isTransaction && template !== "surat_jalan" && template !== "kwitansi" ? `<table class="summary-table">
    <tr>
        <td style="vertical-align: top;">Subtotal</td>
        <td style="text-align:right; line-height: 1.4; vertical-align: top;">
            ${this.formatCurrency(transaction.subtotal || 0)}
            ${(transaction.ppn || 0) > 0 ? `<br><small style="font-weight:normal; color: #4a5568;">(dpp: ${this.formatCurrency(transaction.dpp || 0)})</small>` : ""}
        </td>
    </tr>
    ${(transaction.discount || 0) > 0 ? `<tr><td style="vertical-align: top;">Diskon</td><td style="text-align:right; vertical-align: top;">-${this.formatCurrency(transaction.discount)}</td></tr>` : ""}
    
    ${transaction.isPpnDibebaskan ?
        `<tr><td style="vertical-align: top;">PPN 11%</td><td style="text-align:right; vertical-align: top; font-weight:bold;">DIBEBASKAN</td></tr>` :
        ((transaction.ppn || 0) > 0 ? `<tr><td style="vertical-align: top;">PPN 11%</td><td style="text-align:right; vertical-align: top;">${this.formatCurrency(transaction.ppn)}</td></tr>` : "")
    }
    ${(transaction.shippingCost || 0) > 0 ? `<tr><td style="vertical-align: top;">Ongkos Kirim</td><td style="text-align:right; vertical-align: top;">${this.formatCurrency(transaction.shippingCost)}</td></tr>` : ""}
    ${(transaction.dp || 0) > 0 ? `<tr><td style="vertical-align: top;">Uang Muka (DP)</td><td style="text-align:right; vertical-align: top;">-${this.formatCurrency(transaction.dp)}</td></tr>` : ""}
    <tr style="border-top: 1px solid black; font-weight:bold;"><td style="vertical-align: top;">Total Tagihan</td><td style="text-align:right; vertical-align: top;">${this.formatCurrency(transaction.grandTotal || 0)}</td></tr>
</table>
<div style="margin-top: 5px; font-style:italic; text-transform: capitalize;">Terbilang: ${this.terbilang(grandTotalInteger)} rupiah</div>

${transaction.isPpnDibebaskan ? 
    `<div style="font-size: 8pt; margin-top: 5px; font-weight: bold;"><i>(Transaksi Dibebaskan dari Pengenaan PPN)</i></div>` : 
    ((transaction.ppn || 0) > 0 ? `<div style="font-size: 7pt; margin-top: 5px;"><i>(Harga sudah termasuk PPN 11%)</i></div>` : "")
}
` : "";

            const signatures = template === "surat_jalan" ? `<div class="print-signatures">
                <div><p>Pengirim,</p><div class="signature-space"></div><p>(${"_".repeat(15)})</p></div>
                <div><p>Penerima,</p><div class="signature-space"></div><p>(${"_".repeat(15)})</p></div>
            </div>` :
            `<div class="print-signatures">
                <div><p>Penerima,</p><div class="signature-space"></div><p>(${"_".repeat(15)})</p></div>
                <div><p>Hormat Kami,</p><div class="signature-space"></div><p>(${this.sanitizeInput(config.namaPerusahaan)})</p></div>
            </div>`;

            const rekening = (transaction.ppn && transaction.ppn > 0)
                ? config.rekeningPpn 
                : config.rekening;

            const pageContent = `<div class="page printable-content">
                <div class="print-header">
                    <div class="company-info">
                        <h3 style="font-size: 12pt; margin: 0;">${this.sanitizeInput(config.namaPerusahaan)}</h3>
                        <p>${this.sanitizeInput(config.tagline)}</p>
                        <p>${this.sanitizeInput(config.alamatPerusahaan)}</p>
                        <p>${this.sanitizeInput(config.kontak)}</p>
                    </div>
                    <img src="${config.logoUrl || 'https://via.placeholder.com/120x40.png?text=Logo'}" class="logo" alt="Logo" onerror="this.src='https://via.placeholder.com/120x40.png?text=Logo';">
                </div>
                <div class="print-section ${template === 'kwitansi' ? 'kwitansi' : ''}">
                    <h4 style="font-size: 11pt; margin-bottom: 3mm; text-decoration: underline;">${title}</h4>
                    ${metaContent}
                    ${itemsContent}
                    ${summaryContent}
                    ${transaction.notes ? `<div style="border-top: 1px solid #ccc; margin-top: 3mm; padding-top: 3mm;"><p><b>Keterangan:</b> ${this.sanitizeInput(transaction.notes)}</p></div>` : ""}
                </div>
                ${isTransaction && template !== 'surat_jalan' ? `<div class="rekening-info" style="font-size:8pt; text-align:center; padding-top: 5mm;">Pembayaran mohon di transfer ke rekening ${this.sanitizeInput(rekening)}</div>` : ""}
                <div class="print-footer">
                    ${signatures}
                </div>
            </div>`;

            const copyPageContent = `<div class="page printable-content" style="page-break-before: always;">
                <h4 style="text-align: center; font-size: 11pt; margin-bottom: 3mm;">COPY</h4>
                <div class="print-header">
                    <div class="company-info">
                        <h3 style="font-size: 12pt; margin: 0;">${this.sanitizeInput(config.namaPerusahaan)}</h3>
                        <p>${this.sanitizeInput(config.tagline)}</p>
                        <p>${this.sanitizeInput(config.alamatPerusahaan)}</p>
                        <p>${this.sanitizeInput(config.kontak)}</p>
                    </div>
                    <img src="${config.logoUrl || 'https://via.placeholder.com/120x40.png?text=Logo'}" class="logo" alt="Logo" onerror="this.src='https://via.placeholder.com/120x40.png?text=Logo';">
                </div>
                <div class="print-section ${template === 'kwitansi' ? 'kwitansi' : ''}">
                    <h4 style="font-size: 11pt; margin-bottom: 3mm; text-decoration: underline;">${title}</h4>
                    ${metaContent}
                    ${itemsContent}
                    ${summaryContent}
                    ${transaction.notes ? `<div style="border-top: 1px solid #ccc; margin-top: 3mm; padding-top: 3mm;"><p><b>Keterangan:</b> ${this.sanitizeInput(transaction.notes)}</p></div>` : ""}
                </div>
                ${isTransaction && template !== 'surat_jalan' ? `<div class="rekening-info" style="font-size:8pt; text-align:center; padding-top: 5mm;">Pembayaran mohon di transfer ke rekening ${this.sanitizeInput(rekening)}</div>` : ""}
                <div class="print-footer">
                    ${signatures}
                </div>
            </div>`;

            const blankPageContent = `<div class="page" style="page-break-before: always;"></div>`;

            return `${pageContent}${copyPageContent}${copyPageContent}${blankPageContent}`;
        }
        
        async renderDashboard() {
            const statsContainer = document.getElementById("dashboard-stats");
            const tableBody = document.querySelector("#dashboard-transactions-table tbody");
            if (!statsContainer || !tableBody) return;

            // Date Filters based on state
            let startDate = this.currentDashboardStart || "";
            let endDate = this.currentDashboardEnd || "";

            const filterPredicate = t => (!startDate || t.tanggal >= startDate) && (!endDate || t.tanggal <= endDate);

            const allSales = [...this.data.penjualan, ...this.data.invoices.filter(inv => inv.transType === 'sale')];
            const allPurchases = [...this.data.pembelian, ...this.data.invoices.filter(inv => inv.transType === 'purchase')];

            const filteredSales = allSales.filter(filterPredicate);
            const filteredPurchases = allPurchases.filter(filterPredicate);
            
            const totalSales = filteredSales.reduce((sum, t) => sum + (t.grandTotal || 0), 0);
            const totalPurchases = filteredPurchases.reduce((sum, t) => sum + (t.grandTotal || 0), 0);
            const profit = totalSales - totalPurchases;
            
            const allTransactions = [
                ...this.data.penjualan.map((t) => ({ ...t, type: "Penjualan", dataKey: "penjualan", typeClass: "btn-success" })),
                ...this.data.pembelian.map((t) => ({ ...t, type: "Pembelian", dataKey: "pembelian", typeClass: "btn-danger" })),
                ...this.data.invoices.map((t) => ({ ...t, type: "Invoice", dataKey: "invoices", typeClass: "btn-info" })),
                ...this.data.suratJalan.map((t) => ({ ...t, type: "Surat Jalan", dataKey: "suratJalan", typeClass: "btn-warning" })),
            ].sort((a, b) => new Date(b.tanggal) - new Date(a.tanggal));

            const displayTransactions = allTransactions.filter(filterPredicate).slice(0, 50);

            statsContainer.innerHTML = `
                <div class="stat-card">
                    <div class="stat-card-title">Total Penjualan</div>
                    <div class="stat-card-value profit">${this.formatCurrency(totalSales)}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-title">Total Pembelian</div>
                    <div class="stat-card-value loss">${this.formatCurrency(totalPurchases)}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-title">Laba Kotor</div>
                    <div class="stat-card-value ${profit >= 0 ? "profit" : "loss"}">${this.formatCurrency(profit)}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-title">Transaksi Periode Ini</div>
                    <div class="stat-card-value">${this.formatNumber(displayTransactions.length)}</div>
                </div>`;

            // AUTO SCALE FONTS AFTER RENDER
            this.autoScaleStatFonts();

            tableBody.innerHTML = displayTransactions.map(t => {
                const party = t.customer || t.pemasok || t.penerima || "N/A";
                let printTemplate = 'faktur';
                if(t.dataKey === 'invoices') printTemplate = 'invoice';
                if(t.dataKey === 'suratJalan') printTemplate = 'surat_jalan';
                
                return `<tr>
                    <td><span class="btn btn-sm ${t.typeClass}">${t.type}</span></td>
                    <td class="truncate-text">${t.id}</td>
                    <td>${this.formatDate(t.tanggal)}</td>
                    <td class="truncate-text">${party}</td>
                    <td class="text-right">${t.grandTotal !== undefined ? this.formatCurrency(t.grandTotal) : "-"}</td>
                    <td class="action-cell">
                        <button class="btn btn-sm btn-info" onclick="app.printTransaction('${t.dataKey}', '${t.id}', '${printTemplate}')">Cetak</button>
                        <button class="btn btn-sm btn-danger" onclick="app.deleteTransaction('${t.dataKey}', '${t.id}')">Hapus</button>
                    </td></tr>`;
            }).join('');

            // Also refresh charts
            this.renderDashboardChart(startDate, endDate);
        }

        autoScaleStatFonts() {
            const values = document.querySelectorAll('.stat-card-value');
            values.forEach(el => {
                let size = 1.5; // Start from 1.5rem (from CSS clamp max)
                el.style.fontSize = size + 'rem';
                
                // Extremely aggressive fitting loop
                // We use offsetWidth of the parent to be extra safe
                const parent = el.closest('.stat-card');
                const maxAvailableWidth = parent ? parent.clientWidth - 24 : el.clientWidth; // 24 is padding (12*2)
                
                while (el.scrollWidth > maxAvailableWidth && size > 0.5) {
                    size -= 0.05; // Finer increments
                    el.style.fontSize = size + 'rem';
                }
            });
        }

        filterDashboardRange(range) {
            const now = new Date();
            let start = new Date();
            let end = new Date();

            switch(range) {
                case 'today':
                    start = now;
                    break;
                case 'week':
                    start.setDate(now.getDate() - now.getDay());
                    break;
                case 'month':
                    start.setDate(1);
                    break;
                case 'year':
                    start.setMonth(0, 1);
                    break;
                case 'all':
                    start = null;
                    end = null;
                    break;
            }

            const startStr = start ? start.toISOString().split('T')[0] : "";
            const endStr = end ? end.toISOString().split('T')[0] : "";

            // We don't have dashboard-filters in DOM anymore because I removed it in generateDashboardHTML
            // Wait, I should add them back or use a different way.
            // Actually, I'll just re-render with these dates passed.
            
            // I'll update my state if I had one, but let's just trigger renderDashboard with these.
            // For now, I'll just pass them to renderDashboard.
            
            // Re-calling renderDashboard but we need to store these dates somewhere.
            // Let's just use hidden inputs in the dashboard or just pass as args.
            
            this.currentDashboardStart = startStr;
            this.currentDashboardEnd = endStr;
            this.renderDashboard();
        }
        
        terbilang(nilai) {
            nilai = Math.floor(Math.abs(nilai));
            const bilangan = ["", "satu", "dua", "tiga", "empat", "lima", "enam", "tujuh", "delapan", "sembilan", "sepuluh", "sebelas"];
            const satuan = ["", "ribu", "juta", "miliar", "triliun"];
            
            function konversi(n) {
                if (n === 0) return "";
                if (n < 12) return bilangan[n];
                if (n < 20) return konversi(n - 10) + " belas";
                if (n < 100) return konversi(Math.floor(n / 10)) + " puluh" + (n % 10 ? " " + konversi(n % 10) : "");
                if (n < 200) return "seratus" + (n % 100 ? " " + konversi(n - 100) : "");
                if (n < 1000) return konversi(Math.floor(n / 100)) + " ratus" + (n % 100 ? " " + konversi(n % 100) : "");
                return "";
            }

            if (nilai === 0) return "nol";
            let hasil = "";
            let satuanIndex = 0;

            while (nilai > 0 && satuanIndex < satuan.length) {
                const bagian = nilai % 1000;
                if (bagian > 0) {
                    let teksBagian = (satuanIndex === 1 && bagian === 1) ? "se" : konversi(bagian);
                    teksBagian += satuan[satuanIndex] ? " " + satuan[satuanIndex] : "";
                    hasil = teksBagian + (hasil ? " " + hasil : "");
                }
                nilai = Math.floor(nilai / 1000);
                satuanIndex++;
            }
            return hasil.trim();
        }

        formatDate(dateString) {
            try {
                if (!dateString) return "-";
                const date = new Date(dateString);
                if (isNaN(date.getTime())) {
                    const parts = dateString.split(/[-T]/);
                    return new Date(parts[0], parts[1] - 1, parts[2]).toLocaleDateString("id-ID", { day: "2-digit", month: "long", year: "numeric" });
                }
                return date.toLocaleDateString("id-ID", { day: "2-digit", month: "long", year: "numeric" });
            } catch (error) {
                return dateString;
            }
        }

        deleteItemFromTempList(id, type) {
            this.tempItems[type] = this.tempItems[type].filter((item) => item.id !== id);
            this.renderTempItemsTable(type);
        }

        async renderMasterItemsTextarea() {
            const textarea = document.getElementById("masterItemJson");
            if (textarea) textarea.value = JSON.stringify(this.data.masterItems, null, 2);
        }

        updateMasterItemCountDisplay(filteredCount = null) {
    const countSpan = document.getElementById("master-item-count");
    if (countSpan) {
        const totalCount = this.data.masterItems.length;
        if (filteredCount !== null && filteredCount !== totalCount) {
            countSpan.textContent = `${filteredCount} dari ${totalCount}`;
        } else {
            countSpan.textContent = totalCount;
        }
    }
}

        loadConfigToForm() {
            const config = this.data.config;
            Object.keys(config).forEach(key => {
                const input = document.getElementById(`config-${key}`);
                if (input) input.value = config[key];
            });
            document.getElementById("header-title").textContent = config.namaPerusahaan || "Sistem Akuntansi SGM";
            document.getElementById("header-tagline").textContent = config.tagline || "Pencatatan Penjualan dan Pembelian";
            document.getElementById("header-logo").src = config.logoUrl || "https://via.placeholder.com/150x50.png?text=Logo";
        }

        saveConfig() {
            Object.keys(this.data.config).forEach(key => {
                const input = document.getElementById(`config-${key}`);
                if (input) this.data.config[key] = input.value;
            });
            this.saveData();
            this.loadConfigToForm();
            this.showNotification("Informasi perusahaan berhasil disimpan.");
        }

        saveMasterItemsFromTextarea() {
            const textarea = document.getElementById("masterItemJson");
            try {
                const items = JSON.parse(textarea.value);
                if (!Array.isArray(items)) throw new Error("Format JSON harus berupa array.");
                if (!items.every(item => item.hasOwnProperty("code") && item.hasOwnProperty("name"))) throw new Error('Setiap item harus memiliki properti "code" dan "name".');
                this.data.masterItems = items;
                this.buildItemIndex();
                this.saveData();
                this.updateMasterItemCountDisplay();
                this.showNotification("Data master barang berhasil disimpan dari JSON.");
            } catch (error) {
                Utils.logError("Failed to save master items from JSON", error);
                this.showNotification(`Gagal menyimpan: ${error.message}`, false);
            }
        }

        clearMasterItems() {
            if (confirm("Yakin ingin menghapus SEMUA data master barang?")) {
                this.data.masterItems = [];
                this.buildItemIndex();
                this.saveData();
                this.updateAllUI();
                this.showNotification("Semua data master barang telah dihapus.");
            }
        }

        backupData() {
            const dataStr = JSON.stringify(this.data, null, 2);
            const blob = new Blob([dataStr], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `backup_akuntansi_${new Date().toISOString().slice(0, 10)}.json`;
            a.click();
            URL.revokeObjectURL(url);
            this.showNotification("Backup data berhasil diunduh.");
        }

        restoreData(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const restoredData = JSON.parse(e.target.result);
                    if (restoredData.config && restoredData.penjualan && restoredData.pembelian) {
                        if (confirm("Yakin ingin memulihkan data? Data saat ini akan ditimpa.")) {
                            this.data = restoredData;
                            this.saveData();
                            await this.init(); // Re-initialize the app
                            this.showNotification("Data berhasil dipulihkan. Halaman akan dimuat ulang.");
                            setTimeout(() => window.location.reload(), 1500);
                        }
                    } else {
                        throw new Error("File backup tidak valid.");
                    }
                } catch (err) {
                    Utils.logError("Restore failed", err);
                    this.showNotification(`Gagal memulihkan: ${err.message}`, false);
                } finally {
                    event.target.value = "";
                }
            };
            reader.readAsText(file);
        }

        exportMasterItemsToCsv() {
            if (this.data.masterItems.length === 0) {
                this.showNotification("Tidak ada data barang untuk diekspor.", false);
                return;
            }
            const headers = ["code", "name", "unit", "price"];
            const csvRows = [headers.join(","), ...this.data.masterItems.map((item) => headers.map((header) => `"${(item[header] || "").toString().replace(/"/g, '""')}"`).join(","))];
            const csvString = csvRows.join("\n");
            const blob = new Blob([`\uFEFF${csvString}`], { type: "text/csv;charset=utf-8;" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "master_barang.csv";
            a.click();
            URL.revokeObjectURL(url);
        }

        importMasterItemsFromCsv(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const lines = e.target.result.split(/\r\n|\n/).filter(line => line.trim());
                    if (lines.length <= 1) throw new Error("File CSV kosong atau tidak valid.");
                    const splitRegex = /,(?=(?:(?:[^"]*"){2})*[^"]*$)/;
                    const headers = lines[0].split(splitRegex).map(h => h.trim().replace(/"/g, ""));
                    if (!headers.includes("code") || !headers.includes("name")) throw new Error('CSV harus memiliki kolom "code" dan "name".');
                    
                    const newItems = lines.slice(1).map(line => {
                        const values = line.split(splitRegex).map(v => v.trim().replace(/"/g, ""));
                        const item = {};
                        headers.forEach((header, index) => { item[header] = header === "price" ? (parseInt(values[index]) || 0) : (values[index] || ""); });
                        return item;
                    }).filter(item => item.code && item.name);

                    if (newItems.length === 0) throw new Error("Tidak ada data valid untuk diimpor.");
                    if (confirm(`Ditemukan ${newItems.length} barang dari CSV. Timpa data yang ada?`)) {
                        this.data.masterItems = newItems;
                        this.buildItemIndex();
                        this.saveData();
                        this.updateAllUI();
                        this.showNotification("Data barang berhasil diimpor.");
                    }
                } catch (err) {
                    Utils.logError("CSV Import failed", err);
                    this.showNotification(`Gagal mengimpor: ${err.message}`, false);
                } finally {
                    event.target.value = "";
                }
            };
            reader.readAsText(file);
        }

        addNewMasterItem() {
            const code = document.getElementById("newItemCode").value.trim();
            const name = document.getElementById("newItemName").value.trim();
            const unit = document.getElementById("newItemUnit").value.trim();
            const price = parseInt(document.getElementById("newItemPrice").value.replace(/[^0-9]/g, ""), 10) || 0;

            if (!code || !name) { this.showNotification("Kode dan Nama Barang harus diisi.", false); return; }
            if (!/^[A-Za-z0-9-]{1,20}$/.test(code)) { this.showNotification("Kode hanya boleh berisi huruf, angka, dan hubung (-), maks 20 karakter.", false); return; }
            if (this.data.masterItems.some((item) => item.code.toUpperCase() === code.toUpperCase())) { this.showNotification(`Kode barang '${code}' sudah ada.`, false); return; }

            this.data.masterItems.unshift({ code, name, unit, price: price || 0 });
            this.buildItemIndex();
            this.saveData();
            this.renderMasterItemsTextarea();
            this.updateMasterItemCountDisplay();
            this.showNotification(`Barang '${name}' berhasil ditambahkan.`);
            document.getElementById("add-master-item-form-element").reset();
        }

        printTransaction(dataKey, id, template) {
            const transaction = this.data[dataKey]?.find((t) => t.id === id);
            if (!transaction) { 
                this.showNotification("Transaksi tidak ditemukan.", false); 
                return; 
            }
            
            const printArea = document.getElementById("print-area");
            printArea.innerHTML = this.generatePrintHTML(transaction, template);
            
            document.body.classList.add('printing');

            setTimeout(() => {
                window.print();
                
                document.body.classList.remove('printing');
                printArea.innerHTML = "";
            }, 500);
        }
        
      }

      document.addEventListener("DOMContentLoaded", () => {
    window.app = new SistemAkuntansi();
    window.app.init();

    const tabs = document.querySelectorAll(".nav-tab");
    const tabContents = document.querySelectorAll(".tab-content");

    // Function to control FAB visibility
    const updateFabVisibility = (activeTabId) => {
        const fabSale = document.getElementById('fab-sale');
        const fabPurchase = document.getElementById('fab-purchase');

        if (fabSale) fabSale.style.display = 'none';
        if (fabPurchase) fabPurchase.style.display = 'none';

        if (activeTabId === 'penjualan' && fabSale) {
            fabSale.style.display = 'flex';
        } else if (activeTabId === 'pembelian' && fabPurchase) {
            fabPurchase.style.display = 'flex';
        }
    };

    tabs.forEach((tab) => {
      tab.addEventListener("click", () => {
        tabs.forEach((t) => t.classList.remove("active"));
        tabContents.forEach((c) => c.classList.remove("active"));

        tab.classList.add("active");
        const activeContent = document.getElementById(tab.dataset.tab);
        if (activeContent) activeContent.classList.add("active");

        // Call visibility function on tab change
        updateFabVisibility(tab.dataset.tab);

        // Refresh specific content if needed
        if (tab.dataset.tab === "dashboard") window.app.renderDashboard();
        if (tab.dataset.tab === "pengaturan") {
            window.app.renderTrashTable();
            window.app.renderNpwpTable();
        }
      });
    });

    // Set initial visibility for the default active tab
    const initialActiveTab = document.querySelector(".nav-tab.active");
    if (initialActiveTab) {
        updateFabVisibility(initialActiveTab.dataset.tab);
    }

    // Keyboard Shortcuts
    document.addEventListener('keydown', (e) => {
        // Ctrl+Shift+D for Dark Mode
        if (e.ctrlKey && e.shiftKey && e.key === 'D') {
            e.preventDefault();
            window.app.toggleDarkMode();
        }
        
        // Alt+N for Penjualan
        if (e.altKey && e.key.toLowerCase() === 'n') {
            e.preventDefault();
            const tab = document.querySelector('.nav-tab[data-tab="penjualan"]');
            if(tab) tab.click();
        }
        
        // Alt+P for Pembelian
        if (e.altKey && e.key.toLowerCase() === 'p') {
            e.preventDefault();
            const tab = document.querySelector('.nav-tab[data-tab="pembelian"]');
            if(tab) tab.click();
        }

        // Esc to close overlays
        if (e.key === 'Escape') {
            const overlays = document.querySelectorAll('.history-overlay, #item-editor-modal, .dropdown-options');
            overlays.forEach(el => {
                // Special handling for dropdowns to just hide them
                if (el.classList.contains('dropdown-options')) el.style.display = 'none';
                else if (el.style.display !== 'none') el.style.display = 'none';
            });
        }
    });
});
    </script>
</body>
</html>


